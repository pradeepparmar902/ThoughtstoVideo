<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thought to Viral Video Creator ‚Äî Pradeep Parmar</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,700;1,300&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<style>
:root {
  --bg:#080a0f;--surface:#0e1118;--surface2:#151b27;--border:#1e2840;
  --accent:#ff6b2b;--accent2:#ffb347;--gold:#f5c842;--text:#e8ecf4;
  --muted:#5a6580;--success:#2dce89;--danger:#ff4757;--purple:#b57bee;--blue:#4a9eff;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:0.35}
.amb{position:fixed;border-radius:50%;filter:blur(120px);pointer-events:none;z-index:0}
.a1{width:700px;height:700px;background:rgba(255,107,43,0.06);top:-250px;left:-150px}
.a2{width:500px;height:500px;background:rgba(245,200,66,0.04);bottom:50px;right:-150px}
.a3{width:300px;height:300px;background:rgba(74,158,255,0.03);top:40%;left:40%}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header{position:sticky;top:0;z-index:100;padding:17px 40px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);backdrop-filter:blur(24px);background:rgba(8,10,15,0.86)}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:20px}
.logo-text{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;background:linear-gradient(90deg,var(--accent),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-sub{font-family:'Space Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:3px;text-transform:uppercase;margin-top:-4px}
.hbadge{background:linear-gradient(135deg,rgba(255,107,43,0.15),rgba(255,179,71,0.1));border:1px solid rgba(255,107,43,0.3);border-radius:100px;padding:6px 16px;font-size:11px;font-weight:700;letter-spacing:1.5px;color:var(--accent2);text-transform:uppercase}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.main{position:relative;z-index:1;max-width:1480px;margin:0 auto;padding:34px 40px 80px;display:grid;grid-template-columns:1fr 430px;gap:30px}
.slabel{font-family:'Space Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--accent);text-transform:uppercase;margin-bottom:8px}
.stitle{font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:2px;color:var(--text);margin-bottom:18px}

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:26px;margin-bottom:22px;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,107,43,0.4),transparent)}
.stepnum{width:30px;height:30px;border-radius:9px;background:var(--accent);color:#fff;font-family:'Bebas Neue',sans-serif;font-size:17px;display:inline-flex;align-items:center;justify-content:center;margin-right:10px;flex-shrink:0}
.stephdr{display:flex;align-items:center;margin-bottom:20px}
.stitle2{font-weight:700;font-size:16px}
.ssub{font-size:12px;color:var(--muted);margin-top:2px}

/* ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ */
textarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;line-height:1.75;padding:16px 18px;resize:vertical;min-height:120px;outline:none;transition:border-color .2s,box-shadow .2s}
textarea:focus{border-color:rgba(255,107,43,.5);box-shadow:0 0 0 3px rgba(255,107,43,.08)}
textarea::placeholder{color:var(--muted)}
select{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:9px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;padding:10px 14px;outline:none;cursor:pointer;transition:border-color .2s;appearance:none}
select:focus{border-color:var(--accent)}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn-p{display:inline-flex;align-items:center;gap:8px;padding:12px 22px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:10px;color:#fff;font-family:'DM Sans',sans-serif;font-weight:700;font-size:14px;cursor:pointer;transition:all .2s;white-space:nowrap}
.btn-p:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(255,107,43,.35)}
.btn-s{display:inline-flex;align-items:center;gap:7px;padding:11px 18px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Sans',sans-serif;font-weight:600;font-size:13px;cursor:pointer;transition:all .2s}
.len-btn{background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:10px;font-weight:600;padding:8px 4px;cursor:pointer;transition:all .2s;text-align:center;line-height:1.4}
.len-btn:hover{border-color:var(--accent);color:var(--text)}
.len-btn.active{background:linear-gradient(135deg,rgba(255,107,43,.18),rgba(255,179,71,.1));border-color:var(--accent);color:var(--accent)}
.len-main{font-size:12px;font-weight:700;color:inherit}
.len-sub{font-size:9px;letter-spacing:.5px;text-transform:uppercase;opacity:.7}
.tgt-btn{background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:10px;font-weight:600;padding:8px 4px;cursor:pointer;transition:all .2s;text-align:center;line-height:1.5}
.tgt-btn:hover{border-color:#4a9eff;color:var(--text)}
.tgt-btn.active{background:linear-gradient(135deg,rgba(74,158,255,.18),rgba(181,123,238,.1));border-color:#4a9eff;color:#4a9eff}
.tgt-main{font-size:11px;font-weight:700;color:inherit;display:block}
.tgt-sub{font-size:9px;letter-spacing:.4px;text-transform:uppercase;opacity:.7;display:block}
.ai-mode-btn{background:var(--surface2);border:1px solid var(--border);border-radius:11px;color:var(--muted);padding:10px 8px;cursor:pointer;transition:all .2s;text-align:center;font-family:'DM Sans',sans-serif;line-height:1.5;width:100%}
.ai-mode-btn:hover{border-color:var(--accent);color:var(--text)}
.ai-mode-btn.active{background:linear-gradient(135deg,rgba(255,107,43,.15),rgba(255,179,71,.08));border-color:var(--accent);color:var(--accent)}
.btn-s:hover{border-color:var(--accent);color:var(--accent2)}

/* ‚îÄ‚îÄ AI ELABORATE BOX ‚îÄ‚îÄ */
.ai-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.ai-badge{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,rgba(181,123,238,.2),rgba(74,158,255,.1));border:1px solid rgba(181,123,238,.4);border-radius:100px;padding:4px 12px;font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--purple);text-transform:uppercase}
.ai-dot{width:6px;height:6px;background:var(--purple);border-radius:50%;animation:blink 1.5s infinite}
.elab-box{background:linear-gradient(135deg,rgba(181,123,238,.06),rgba(74,158,255,.04));border:1px solid rgba(181,123,238,.2);border-radius:14px;padding:18px;min-height:110px;position:relative}
.elab-ph{color:var(--muted);font-size:14px;font-style:italic;line-height:1.7}
.elab-txt{font-size:14px;line-height:1.8;color:var(--text);display:none}
.elab-txt.on{display:block}
.elab-spin{display:none;align-items:center;gap:10px;color:var(--purple);font-size:13px;font-weight:500}
.elab-spin.on{display:flex}
.tdots span{display:inline-block;width:6px;height:6px;background:var(--purple);border-radius:50%;margin:0 2px;animation:bdot 1.2s infinite}
.tdots span:nth-child(2){animation-delay:.2s} .tdots span:nth-child(3){animation-delay:.4s}
@keyframes bdot{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}

/* ‚îÄ‚îÄ STRUCTURE GRID ‚îÄ‚îÄ */
.sg{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:14px}
.si{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px 6px;text-align:center;cursor:pointer;transition:all .2s}
.si:hover,.si.active{border-color:var(--accent);background:rgba(255,107,43,.08)}
.se{font-size:18px;display:block;margin-bottom:5px}
.sn{font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted)}
.st{font-family:'Space Mono',monospace;font-size:8px;color:var(--accent);margin-top:3px}

/* ‚îÄ‚îÄ PARSED ‚îÄ‚îÄ */
.parsed{display:none;margin-top:18px;gap:10px;flex-direction:column}
.parsed.on{display:flex}
.pi{background:var(--surface2);border-left:3px solid var(--accent);border-radius:0 10px 10px 0;padding:14px 16px;animation:sli .35s ease forwards}
.pi:nth-child(2){border-left-color:var(--blue)} .pi:nth-child(3){border-left-color:var(--gold)} .pi:nth-child(4){border-left-color:var(--success)} .pi:nth-child(5){border-left-color:var(--purple)}
@keyframes sli{from{opacity:0;transform:translateX(-12px)}to{opacity:1;transform:translateX(0)}}
.plbl{font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px}
.ptxt{font-size:14px;line-height:1.65;color:var(--text)}
.ktag{display:inline-block;background:rgba(255,107,43,.15);border:1px solid rgba(255,107,43,.3);border-radius:4px;padding:1px 6px;font-size:12px;color:var(--accent2);margin:0 1px}

/* ‚îÄ‚îÄ VOICE TABS ‚îÄ‚îÄ */
.vtabs{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px}
.vtab{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:18px 10px;text-align:center;cursor:pointer;transition:all .25s}
.vtab:hover,.vtab.active{border-color:var(--accent);background:rgba(255,107,43,.08)}
.vti{font-size:26px;display:block;margin-bottom:7px}
.vtl{font-size:12px;font-weight:700;color:var(--text)}
.vtd{font-size:10px;color:var(--muted);margin-top:3px}
.vpanel{display:none} .vpanel.on{display:block}

/* ‚îÄ‚îÄ RECORD ‚îÄ‚îÄ */
.rec-area{text-align:center;padding:24px;background:var(--surface2);border-radius:14px;border:1px dashed var(--border)}
.rec-btn{width:76px;height:76px;border-radius:50%;background:linear-gradient(135deg,var(--danger),#ff2d55);border:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-size:30px;transition:all .2s}
.rec-btn:hover{transform:scale(1.06)}
.rec-btn.rng{animation:prec 1.5s infinite}
@keyframes prec{0%,100%{box-shadow:0 0 0 0 rgba(255,71,87,.4)}50%{box-shadow:0 0 0 22px rgba(255,71,87,0)}}
.rec-st{margin-top:11px;font-size:13px;color:var(--muted)}
.rec-tm{font-family:'Space Mono',monospace;font-size:26px;color:var(--danger);margin-top:8px;display:none}
.wf{display:flex;align-items:center;justify-content:center;gap:3px;height:44px;margin-top:12px}
.wb{width:3px;background:var(--accent);border-radius:2px;height:6px;transition:height .1s}

/* ‚îÄ‚îÄ UPLOAD ZONE ‚îÄ‚îÄ */
.upz{border:1px dashed var(--border);border-radius:12px;padding:28px;text-align:center;cursor:pointer;transition:all .2s}
.upz:hover{border-color:var(--accent);background:rgba(255,107,43,.04)}
.upz input{display:none}
.upi{font-size:34px;margin-bottom:10px}
.upt{font-size:13px;color:var(--muted)} .upt span{color:var(--accent);font-weight:600}

/* ‚îÄ‚îÄ TTS PANEL ‚îÄ‚îÄ */
.tts-p{background:var(--surface2);border-radius:14px;padding:20px}
.gender-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.gbtn{background:var(--surface);border:2px solid var(--border);border-radius:12px;padding:18px 12px;text-align:center;cursor:pointer;transition:all .2s}
.gbtn:hover,.gbtn.active{border-color:var(--accent);background:rgba(255,107,43,.08)}
.gi{font-size:32px;display:block;margin-bottom:8px}
.gl{font-size:13px;font-weight:700} .gd{font-size:11px;color:var(--muted);margin-top:3px}
.vctrl-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.vc label{font-size:11px;color:var(--muted);display:block;margin-bottom:5px;font-weight:600;letter-spacing:.5px}
input[type=range]{width:100%;accent-color:var(--accent);height:4px;cursor:pointer;background:var(--border);border-radius:4px;outline:none}
.cval{font-family:'Space Mono',monospace;font-size:10px;color:var(--accent);margin-top:3px}
.tts-play-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.sw-ind{display:none;align-items:center;gap:8px;font-size:12px;color:var(--success);font-weight:600}
.sw-ind.on{display:flex}
.sw{display:flex;align-items:center;gap:2px}
.sw span{width:3px;background:var(--success);border-radius:2px;display:inline-block}
.sw span:nth-child(1){height:8px;animation:sb .6s infinite 0s}
.sw span:nth-child(2){height:14px;animation:sb .6s infinite .1s}
.sw span:nth-child(3){height:20px;animation:sb .6s infinite .2s}
.sw span:nth-child(4){height:14px;animation:sb .6s infinite .3s}
.sw span:nth-child(5){height:8px;animation:sb .6s infinite .4s}
@keyframes sb{0%,100%{transform:scaleY(.4)}50%{transform:scaleY(1)}}

/* ‚îÄ‚îÄ IMAGE GRID ‚îÄ‚îÄ */
.img-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:14px}
.img-slot{aspect-ratio:1/1;border-radius:10px;border:2px dashed var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;position:relative;overflow:hidden;transition:all .2s;background:var(--surface2)}
.img-slot:hover{border-color:var(--accent);background:rgba(255,107,43,.06)}
.img-slot.filled{border-style:solid;border-color:var(--accent)}
.img-slot img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.img-si{font-size:22px;color:var(--muted)}
.img-sl{font-size:10px;color:var(--muted);margin-top:5px;text-align:center;font-weight:600}
.img-ov{position:absolute;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;gap:8px;opacity:0;transition:opacity .2s}
.img-slot:hover .img-ov{opacity:1}
.iob{width:32px;height:32px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px}
.iou{background:var(--accent);color:#fff}
.iod{background:var(--danger);color:#fff}
.irole{position:absolute;bottom:4px;left:4px;right:4px;background:rgba(255,107,43,.88);border-radius:5px;padding:2px 6px;font-size:8px;font-weight:700;color:#fff;text-align:center;letter-spacing:1px;text-transform:uppercase;backdrop-filter:blur(4px)}
.role-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:12px}
.rtag{padding:5px 12px;border-radius:7px;font-size:11px;font-weight:600;border:1px solid var(--border);background:var(--surface2);color:var(--muted);cursor:pointer;transition:all .2s}
.rtag:hover,.rtag.active{border-color:var(--accent);color:var(--accent2);background:rgba(255,107,43,.1)}

/* ‚îÄ‚îÄ BG GRID ‚îÄ‚îÄ */
.bgg{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px}
.bgt{aspect-ratio:16/9;border-radius:8px;border:2px solid transparent;cursor:pointer;overflow:hidden;transition:all .2s;position:relative}
.bgt:hover,.bgt.sel{border-color:var(--accent)}
.bgt .ck{position:absolute;top:4px;right:4px;width:18px;height:18px;background:var(--accent);border-radius:50%;display:none;align-items:center;justify-content:center;font-size:9px}
.bgt.sel .ck{display:flex}
.blbl{position:absolute;bottom:3px;left:4px;font-size:7px;font-weight:700;letter-spacing:1px;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,.9);text-transform:uppercase}
.b0{background:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460)}.b1{background:linear-gradient(135deg,#2d1b00,#5c3200,#8b4513)}.b2{background:linear-gradient(135deg,#0a192f,#112240,#233554)}.b3{background:linear-gradient(135deg,#1a0a00,#3d1c00,#6b3300)}.b4{background:linear-gradient(135deg,#0d2818,#155c35,#1e8449)}.b5{background:linear-gradient(135deg,#1a001a,#3d003d,#6b006b)}.b6{background:linear-gradient(135deg,#2a0000,#600000,#8b0000)}.b7{background:radial-gradient(circle at 30% 40%,#1a1a1a,#000)}

/* ‚îÄ‚îÄ ANIM ‚îÄ‚îÄ */
.arow{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.abtn{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 6px;text-align:center;cursor:pointer;transition:all .2s;font-size:10px;font-weight:600;color:var(--muted);letter-spacing:.5px}
.abtn:hover,.abtn.active{border-color:var(--accent);color:var(--accent2);background:rgba(255,107,43,.08)}
.ai{font-size:18px;display:block;margin-bottom:6px}

/* ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ */
.frow{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.fb{border-radius:10px;height:62px;cursor:pointer;transition:all .2s;border:2px solid transparent;position:relative;overflow:hidden}
.fb::after{content:attr(data-n);position:absolute;bottom:7px;left:0;right:0;font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,.8);text-align:center}
.fb:hover,.fb.active{border-color:var(--accent)}
.fb.active::before{content:'‚úì';position:absolute;top:6px;right:6px;width:16px;height:16px;background:var(--accent);border-radius:50%;font-size:9px;display:flex;align-items:center;justify-content:center;color:#fff}
.fc{background:linear-gradient(135deg,#0a0a1a,#1a1a3a)}.fw{background:linear-gradient(135deg,#3d1a00,#8b4513,#d2691e)}.fd{background:linear-gradient(135deg,#000,#1a0000,#2d0000)}.fbr{background:linear-gradient(135deg,#0a2a0a,#1a4a1a,#2d692d)}

/* ‚îÄ‚îÄ EMOJI ‚îÄ‚îÄ */
.emo-row{display:flex;flex-wrap:wrap;gap:8px}
.ec{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 14px;font-size:22px;cursor:pointer;transition:all .2s;position:relative}
.ec:hover{transform:scale(1.15);border-color:var(--accent)}
.ec.on{border-color:var(--accent);background:rgba(255,107,43,.1)}
.elbl{position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);font-size:8px;font-weight:700;letter-spacing:1px;color:var(--muted);white-space:nowrap;text-transform:uppercase;pointer-events:none}

/* ‚îÄ‚îÄ PLATFORM / RATIO ‚îÄ‚îÄ */
.prow{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:18px}
.pbtn{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 6px;text-align:center;cursor:pointer;transition:all .2s;font-size:10px;font-weight:700;letter-spacing:1px;color:var(--muted);text-transform:uppercase}
.pbtn:hover,.pbtn.active{border-color:var(--accent);color:var(--accent2);background:rgba(255,107,43,.08)}
.pi2{font-size:22px;display:block;margin-bottom:6px}
.rrow{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.rbtn{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 8px;text-align:center;cursor:pointer;transition:all .2s}
.rbtn:hover,.rbtn.active{border-color:var(--accent);background:rgba(255,107,43,.08)}
.rv{display:flex;align-items:center;justify-content:center;margin:0 auto 8px}
.rv .rect{background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:3px;opacity:.75}
.r916 .rect{width:20px;height:35px}.r169 .rect{width:40px;height:22px}.r11 .rect{width:28px;height:28px}
.rn{font-family:'Space Mono',monospace;font-size:11px;font-weight:700;color:var(--text)}
.rd{font-size:10px;color:var(--muted);margin-top:2px}

/* ‚îÄ‚îÄ TOGGLE ‚îÄ‚îÄ */
.trow{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.tl{font-size:13px;font-weight:500} .ts{font-size:11px;color:var(--muted);margin-top:2px}
.tog{width:44px;height:24px;background:var(--border);border-radius:100px;cursor:pointer;position:relative;transition:background .2s;flex-shrink:0}
.tog.on{background:var(--accent)}
.tog::after{content:'';width:18px;height:18px;background:#fff;border-radius:50%;position:absolute;top:3px;left:3px;transition:left .2s}
.tog.on::after{left:23px}

/* ‚îÄ‚îÄ INFO BOX ‚îÄ‚îÄ */
.ib{padding:12px 16px;background:var(--surface2);border-radius:10px;border:1px solid var(--success);font-size:13px;color:var(--success);display:none;margin-top:12px}
.ib.on{display:block}

/* ‚îÄ‚îÄ STRATEGY ‚îÄ‚îÄ */
.strat{background:linear-gradient(135deg,rgba(255,107,43,.08),rgba(245,200,66,.04));border:1px solid rgba(255,107,43,.2);border-radius:16px;padding:22px;margin-bottom:22px}
.stratp{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;color:var(--accent2);margin-bottom:14px}
.sflow{display:flex;align-items:center;gap:4px;flex-wrap:wrap}
.fs{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:9px 12px;font-size:11px;font-weight:600;color:var(--text);display:flex;align-items:center;gap:5px}
.fa{color:var(--accent);font-size:14px;font-weight:700}

/* ‚îÄ‚îÄ TIPS ‚îÄ‚îÄ */
.tips{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.ti{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:15px;display:flex;gap:11px}
.ticon{font-size:22px;flex-shrink:0}
.ttl{font-size:12px;font-weight:700;margin-bottom:4px}
.tdsc{font-size:11px;color:var(--muted);line-height:1.55}

/* ‚îÄ‚îÄ KEYWORD CHIPS ‚îÄ‚îÄ */
.kmap{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.kc{display:flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid var(--border);border-radius:100px;padding:6px 12px;font-size:12px;cursor:pointer;transition:all .2s}
.kc:hover,.kc.on{border-color:var(--accent);background:rgba(255,107,43,.1);color:var(--accent2)}
.ke{font-size:14px}

/* ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ */
.prev-panel{position:sticky;top:90px;height:fit-content}
.prev-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;overflow:hidden}
.prev-hdr{padding:14px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.prev-t{font-family:'Space Mono',monospace;font-size:11px;letter-spacing:2px;color:var(--muted);text-transform:uppercase}
.prev-live{display:flex;align-items:center;gap:6px;font-size:10px;font-weight:700;color:var(--success);letter-spacing:1px;text-transform:uppercase}
.ldot{width:6px;height:6px;background:var(--success);border-radius:50%;animation:blink 1.5s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
.prev-scr{margin:18px;border-radius:12px;overflow:hidden;position:relative;background:#000;transition:all .4s}
.prev-scr.r916{aspect-ratio:9/16;max-height:460px}
.prev-scr.r169{aspect-ratio:16/9}
.prev-scr.r11{aspect-ratio:1/1}
.pbg{position:absolute;inset:0;background:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460);background-size:cover;background-position:center;transition:background .5s}
.pov{position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.75),transparent 55%)}
.puimg{position:absolute;inset:0;object-fit:cover;width:100%;height:100%;opacity:0;transition:opacity .5s}
.puimg.on{opacity:.55}
.pcnt{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:flex-end;padding:22px 18px}
.pemo{font-size:22px;margin-bottom:10px;letter-spacing:4px}
.ptxt{font-family:'Bebas Neue',sans-serif;font-size:26px;line-height:1.1;letter-spacing:2px;color:#fff;text-shadow:0 2px 20px rgba(0,0,0,.8);word-break:break-word}
.psig{margin-top:10px;font-family:'Space Mono',monospace;font-size:8px;letter-spacing:3px;color:rgba(255,255,255,.5);text-transform:uppercase}
.ptxt.fi{animation:fadeIn .8s ease forwards}
.ptxt.zi{animation:zoomIn .5s ease forwards}
.ptxt.su{animation:slideUp .6s ease forwards}
.ptxt.ci{animation:cinema 1s ease forwards}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes zoomIn{from{transform:scale(.5);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes cinema{from{letter-spacing:20px;opacity:0}to{letter-spacing:2px;opacity:1}}
.playbar{margin:0 18px 18px}
.ptrack{height:3px;background:var(--border);border-radius:3px;overflow:hidden;margin-bottom:10px}
.pfill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%;border-radius:3px;transition:width .1s linear}
.pctrl{display:flex;align-items:center;justify-content:space-between}
.playbtn{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff;transition:all .2s}
.playbtn:hover{transform:scale(1.1)}
.timd{font-family:'Space Mono',monospace;font-size:11px;color:var(--muted)}

/* ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ */
.exc{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:22px;margin-top:18px}
.qrow{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px}
.qbtn{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center;cursor:pointer;transition:all .2s;font-family:'Space Mono',monospace;font-size:12px;color:var(--muted)}
.qbtn:hover,.qbtn.active{border-color:var(--accent);color:var(--accent2);background:rgba(255,107,43,.08)}
.qb{display:inline-block;background:var(--accent);color:#fff;border-radius:4px;padding:1px 5px;font-size:8px;margin-left:4px;vertical-align:middle}
.exbtn{width:100%;padding:18px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:14px;color:#fff;font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:3px;cursor:pointer;transition:all .3s;position:relative;overflow:hidden}
.exbtn::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent 30%,rgba(255,255,255,.1) 50%,transparent 70%);transform:translateX(-100%);transition:transform .5s}
.exbtn:hover::before{transform:translateX(100%)}
.exbtn:hover{transform:translateY(-2px);box-shadow:0 10px 40px rgba(255,107,43,.4)}
.epw{display:none;margin-top:12px}
.ep{height:4px;background:var(--border);border-radius:4px;overflow:hidden}
.epf{height:100%;background:linear-gradient(90deg,var(--accent),var(--gold));width:0%;border-radius:4px;transition:width .2s}
.est{text-align:center;margin-top:12px;font-size:12px;color:var(--muted);display:none}

/* ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ */
.div{height:1px;background:var(--border);margin:20px 0}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{position:fixed;bottom:28px;right:28px;background:var(--surface2);border:1px solid var(--accent);border-radius:12px;padding:14px 20px;font-size:13px;font-weight:600;color:var(--text);box-shadow:0 10px 40px rgba(0,0,0,.5);z-index:10000;display:flex;align-items:center;gap:10px;transform:translateY(120px);opacity:0;transition:all .35s cubic-bezier(.34,1.56,.64,1)}
.toast.on{transform:translateY(0);opacity:1}


/* ‚îÄ‚îÄ EDIT BTN ‚îÄ‚îÄ */
.editbtn{width:100%;padding:14px;background:var(--surface2);border:2px solid var(--accent);border-radius:14px;color:var(--accent2);font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:3px;cursor:pointer;transition:all .3s;margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:8px}
.editbtn:hover{background:rgba(255,107,43,.12);transform:translateY(-2px)}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   VIDEO EDITOR MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#vedModal {
  display: none; position: fixed; inset: 0; z-index: 99998;
  background: var(--bg); flex-direction: column; overflow: hidden;
}
#vedModal.open { display: flex; animation: fpFadeIn .3s ease; }

.ved-top {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 24px; background: var(--surface);
  border-bottom: 1px solid var(--border); flex-shrink: 0; z-index:10;
}
.ved-logo { font-family: 'Bebas Neue', sans-serif; font-size: 22px;
  letter-spacing: 2px; color: var(--text); display:flex;align-items:center;gap:8px }
.ved-logo span { font-size: 18px; color: var(--accent2); }
.ved-top-actions { display: flex; gap: 10px; }
.ved-btn-apply {
  padding: 9px 20px; background: linear-gradient(135deg,var(--accent),var(--accent2));
  border: none; border-radius: 9px; color: #fff;
  font-family: 'DM Sans', sans-serif; font-weight: 700; font-size: 13px;
  cursor: pointer; transition: all .2s;
}
.ved-btn-apply:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(255,107,43,.4); }
.ved-btn-close {
  padding: 9px 16px; background: var(--surface2); border: 1px solid var(--border);
  border-radius: 9px; color: var(--text);
  font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 13px;
  cursor: pointer; transition: all .2s;
}
.ved-btn-close:hover { border-color: var(--danger); color: var(--danger); }

.ved-body {
  display: grid; grid-template-columns: 290px 1fr;
  gap: 0; flex: 1; overflow: hidden;
}

/* LEFT PANEL */
.ved-left {
  background: var(--surface); border-right: 1px solid var(--border);
  padding: 18px; display: flex; flex-direction: column; gap: 14px;
  overflow-y: auto;
}
.ved-preview-label {
  font-family: 'Space Mono', monospace; font-size: 9px;
  letter-spacing: 3px; color: var(--muted); text-transform: uppercase;
  margin-bottom: 4px;
}
.ved-canvas-wrap {
  position: relative; border-radius: 12px; overflow: hidden;
  border: 1px solid var(--border); background: #000;
  width: 100%; aspect-ratio: 9/16; max-height: 380px;
  display: flex; align-items: center; justify-content: center;
}
#vedCanvas { width: 100%; height: 100%; object-fit: contain; display: block; }
.ved-canvas-sec {
  position: absolute; top: 10px; left: 10px;
  font-family: 'Space Mono', monospace; font-size: 8px; letter-spacing: 2px;
  color: rgba(255,255,255,0.7); background: rgba(0,0,0,0.5);
  padding: 3px 8px; border-radius: 4px; text-transform: uppercase;
}
.ved-nav-btns { display: flex; gap: 8px; }
.ved-nav-btns button {
  flex: 1; padding: 8px; background: var(--surface2); border: 1px solid var(--border);
  border-radius: 8px; color: var(--text); font-size: 12px; cursor: pointer;
  transition: all .2s;
}
.ved-nav-btns button:hover { border-color: var(--accent); color: var(--accent2); }

.ved-music-box {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 12px; padding: 14px;
}
.ved-upload-lbl {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 14px; background: var(--surface); border: 1px dashed var(--border);
  border-radius: 9px; font-size: 12px; color: var(--accent2); cursor: pointer;
  transition: all .2s; margin: 10px 0;
}
.ved-upload-lbl:hover { border-color: var(--accent); }
.ved-upload-lbl input { display: none; }
.ved-music-name { font-size: 11px; color: var(--muted); margin-bottom: 6px; }
.ved-music-controls { margin-top: 8px; display: flex; flex-direction: column; gap: 8px; }

/* CENTER PANEL */
.ved-center {
  padding: 18px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;
}
.ved-section-hdr {
  font-family: 'Space Mono', monospace; font-size: 10px;
  letter-spacing: 2px; color: var(--accent); text-transform: uppercase;
}
.ved-timeline {
  display: flex; gap: 4px; align-items: stretch;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 12px; padding: 12px; overflow-x: auto; min-height: 80px;
}
.ved-tl-block {
  border-radius: 8px; padding: 8px 10px; cursor: pointer;
  transition: all .2s; flex-shrink: 0; position: relative;
  min-width: 70px; display: flex; flex-direction: column;
  justify-content: space-between; border: 2px solid transparent;
  user-select: none;
}
.ved-tl-block:hover { transform: translateY(-2px); }
.ved-tl-block.active { border-color: #fff !important; box-shadow: 0 0 0 2px rgba(255,255,255,.3); }
.ved-tl-label { font-size: 8px; font-weight: 700; letter-spacing: 1px; color: rgba(255,255,255,.9); text-transform: uppercase; }
.ved-tl-dur { font-family: 'Space Mono', monospace; font-size: 9px; color: rgba(255,255,255,.6); margin-top: 4px; }
.ved-tl-resize {
  position: absolute; right: 0; top: 0; bottom: 0; width: 8px;
  cursor: ew-resize; background: rgba(255,255,255,.15); border-radius: 0 6px 6px 0;
}
.ved-tl-resize:hover { background: rgba(255,255,255,.35); }
.ved-tl-hint { font-size: 10px; color: var(--muted); text-align: center; }

.ved-props-box {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 14px; padding: 18px; flex: 1;
}
.ved-props-hdr {
  font-family: 'Bebas Neue', sans-serif; font-size: 20px;
  letter-spacing: 2px; color: var(--text); margin-bottom: 14px;
}
.ved-tabs { display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap; }
.ved-tab {
  padding: 7px 14px; background: var(--surface2); border: 1px solid var(--border);
  border-radius: 8px; color: var(--muted); font-size: 11px; font-weight: 600;
  cursor: pointer; transition: all .2s;
}
.ved-tab.active, .ved-tab:hover { border-color: var(--accent); color: var(--accent2); background: rgba(255,107,43,.1); }
.ved-tab-panel { display: none; }
.ved-tab-panel.active { display: block; }

.ved-lbl { font-size: 10px; font-weight: 700; letter-spacing: 1px; color: var(--muted); text-transform: uppercase; margin-bottom: 6px; display: block; }
.ved-textarea {
  width: 100%; background: var(--surface2); border: 1px solid var(--border);
  border-radius: 9px; color: var(--text); font-family: 'DM Sans', sans-serif;
  font-size: 14px; line-height: 1.6; padding: 12px 14px; resize: vertical;
  outline: none; transition: border-color .2s;
}
.ved-textarea:focus { border-color: rgba(255,107,43,.5); }
.ved-char-count { font-size: 10px; color: var(--muted); text-align: right; margin-top: 4px; }
.ved-row { display: flex; align-items: center; gap: 10px; }
.ved-val { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--accent2); min-width: 36px; }
.ved-pos-btns { display: flex; gap: 6px; }
.ved-pos-btns button, .ved-dur-presets button {
  flex: 1; padding: 8px; background: var(--surface2); border: 1px solid var(--border);
  border-radius: 7px; color: var(--muted); font-size: 11px; font-weight: 600;
  cursor: pointer; transition: all .2s;
}
.ved-pos-btns button.active, .ved-dur-presets button:hover,
.ved-pos-btns button:hover { border-color: var(--accent); color: var(--accent2); background: rgba(255,107,43,.1); }
.ved-dur-presets { display: flex; gap: 6px; }
.ved-total-dur { font-family: 'Bebas Neue', sans-serif; font-size: 36px; color: var(--accent2); letter-spacing: 2px; }
.ved-all-durs { display: flex; flex-direction: column; gap: 4px; margin-top: 10px; }
.ved-dur-row { display: flex; justify-content: space-between; font-size: 11px; color: var(--muted); padding: 4px 0; border-bottom: 1px solid var(--border); }
.ved-dur-row span:last-child { color: var(--text); font-family: 'Space Mono', monospace; }

.ved-img-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 6px; }
.ved-img-thumb {
  aspect-ratio: 9/16; border-radius: 6px; overflow: hidden; cursor: pointer;
  border: 2px solid transparent; transition: all .2s; position: relative;
  background: var(--surface2);
}
.ved-img-thumb img { width: 100%; height: 100%; object-fit: cover; }
.ved-img-thumb:hover, .ved-img-thumb.active { border-color: var(--accent); }
.ved-img-thumb.active::after { content: '‚úì'; position: absolute; top: 4px; right: 4px; background: var(--accent); color: #fff; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 9px; }
.ved-no-imgs { font-size: 11px; color: var(--muted); text-align: center; padding: 20px; }

.ved-color-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 6px; }
.ved-color-opt {
  aspect-ratio: 16/9; border-radius: 6px; cursor: pointer;
  border: 2px solid transparent; transition: all .2s;
}
.ved-color-opt:hover, .ved-color-opt.active { border-color: #fff; transform: scale(1.05); }
.ved-color-row { display: flex; gap: 8px; flex-wrap: wrap; }
.ved-color-swatch { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all .2s; }
.ved-color-swatch.active, .ved-color-swatch:hover { border-color: #fff; transform: scale(1.15); }
.ved-trans-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
.ved-trans-btn {
  padding: 10px; background: var(--surface2); border: 1px solid var(--border);
  border-radius: 8px; color: var(--muted); font-size: 11px; font-weight: 600;
  cursor: pointer; transition: all .2s; text-align: center;
}
.ved-trans-btn.active, .ved-trans-btn:hover { border-color: var(--accent); color: var(--accent2); background: rgba(255,107,43,.1); }
.ved-smol-btn {
  padding: 7px 12px; background: var(--surface2); border: 1px solid var(--border);
  border-radius: 7px; color: var(--text); font-size: 11px; font-weight: 600;
  cursor: pointer; transition: all .2s;
}
.ved-smol-btn:hover { border-color: var(--accent); color: var(--accent2); }

@media(max-width:900px){
  .ved-body { grid-template-columns: 1fr; }
  .ved-left { display: none; }
}

/* SCROLLBAR */
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* RESPONSIVE */
@media(max-width:1100px){.main{grid-template-columns:1fr;padding:20px}.prev-panel{position:static}}
@media(max-width:640px){header{padding:14px 18px}.main{padding:14px}.sg,.arow,.prow{grid-template-columns:repeat(3,1fr)}.frow{grid-template-columns:repeat(2,1fr)}.tips{grid-template-columns:1fr}.vtabs{grid-template-columns:1fr 1fr 1fr}}

/* ‚îÄ‚îÄ PIN Login ‚îÄ‚îÄ */
#pinOverlay{position:fixed;inset:0;background:linear-gradient(160deg,#0a0a0f 0%,#12121a 50%,#0d0d14 100%);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:0}
#pinBox{width:320px;padding:36px 28px;background:rgba(255,255,255,.03);border:1px solid rgba(255,107,43,.2);border-radius:24px;text-align:center}
#pinDots{display:flex;gap:12px;justify-content:center;margin:28px 0 8px}
.pin-dot{width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,107,43,.4);transition:all .2s}
.pin-dot.filled{background:var(--accent);border-color:var(--accent);box-shadow:0 0 10px rgba(255,107,43,.6)}
#pinPad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:24px}
.pin-key{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px;font-size:20px;font-weight:700;color:var(--text);cursor:pointer;transition:all .15s;font-family:'Space Mono',monospace;user-select:none}
.pin-key:active,.pin-key:hover{background:rgba(255,107,43,.15);border-color:rgba(255,107,43,.4);transform:scale(.96)}
.pin-key.del{font-size:16px;color:var(--muted)}
#pinErr{font-size:11px;color:#ff4444;height:16px;margin-top:8px;transition:opacity .3s}
#pinSubtitle{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.5}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê PIN LOGIN OVERLAY ‚ïê‚ïê‚ïê -->
<div id="pinOverlay">
  <div id="pinBox">
    <div style="font-size:36px;margin-bottom:4px">üé¨</div>
    <div style="font-size:18px;font-weight:700;color:var(--text);letter-spacing:1px">CREATOR STUDIO</div>
    <div id="pinSubtitle">Pradeep Parmar ‚Äî Private Access<br>Enter your PIN to continue</div>
    <div id="pinDots">
      <div class="pin-dot" id="d0"></div>
      <div class="pin-dot" id="d1"></div>
      <div class="pin-dot" id="d2"></div>
      <div class="pin-dot" id="d3"></div>
    </div>
    <div id="pinErr"></div>
    <div id="pinPad">
      <button class="pin-key" onclick="pinPress(1)">1</button>
      <button class="pin-key" onclick="pinPress(2)">2</button>
      <button class="pin-key" onclick="pinPress(3)">3</button>
      <button class="pin-key" onclick="pinPress(4)">4</button>
      <button class="pin-key" onclick="pinPress(5)">5</button>
      <button class="pin-key" onclick="pinPress(6)">6</button>
      <button class="pin-key" onclick="pinPress(7)">7</button>
      <button class="pin-key" onclick="pinPress(8)">8</button>
      <button class="pin-key" onclick="pinPress(9)">9</button>
      <button class="pin-key del" onclick="pinPress('bio')">üëÜ</button>
      <button class="pin-key" onclick="pinPress(0)">0</button>
      <button class="pin-key del" onclick="pinPress('del')">‚å´</button>
    </div>
  </div>
  <div style="margin-top:18px;font-size:10px;color:rgba(255,255,255,.2);letter-spacing:1px">BELIEF CREATOR STUDIO V2.0</div>
</div>

<div class="amb a1"></div><div class="amb a2"></div><div class="amb a3"></div>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-icon">üé¨</div>
    <div>
      <div class="logo-text">Thought ‚Üí Viral Video</div>
      <div class="logo-sub">Pradeep Parmar ‚Äî Belief Creator Studio</div>
    </div>
  </div>
  <div class="hbadge">üî• Creator Studio v2.0</div>
</header>

<div class="main">
<div><!-- LEFT COLUMN -->

<!-- FILE:// WARNING BANNER -->
<div id="fileBanner" style="display:none;background:linear-gradient(135deg,rgba(255,50,50,.12),rgba(255,107,43,.08));border:1px solid rgba(255,80,80,.4);border-radius:14px;padding:16px;margin-bottom:16px">
  <div style="display:flex;align-items:flex-start;gap:10px">
    <div style="font-size:24px;flex-shrink:0">üö´</div>
    <div style="flex:1">
      <div style="font-size:13px;font-weight:700;color:#ff5050;margin-bottom:6px">AI blocked ‚Äî this file must be hosted online</div>
      <div style="font-size:11px;color:var(--muted);line-height:1.7;margin-bottom:10px">
        iPhone Safari blocks ALL external network calls from local HTML files. This is an Apple security rule ‚Äî it cannot be bypassed. To use AI, you must open this app from an <strong style="color:var(--text)">https://</strong> URL.
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <div style="background:rgba(74,222,128,.08);border:1px solid rgba(74,222,128,.25);border-radius:10px;padding:10px 12px">
          <div style="font-size:12px;font-weight:700;color:#4ade80;margin-bottom:3px">‚ö° 2-minute fix ‚Äî Netlify Drop</div>
          <div style="font-size:11px;color:var(--muted);line-height:1.6">On your computer: go to <strong style="color:#4a9eff">app.netlify.com/drop</strong> ‚Üí drag this HTML file ‚Üí copy the link ‚Üí open on iPhone. Done.</div>
        </div>
        <div style="background:rgba(74,158,255,.06);border:1px solid rgba(74,158,255,.2);border-radius:10px;padding:10px 12px">
          <div style="font-size:12px;font-weight:700;color:#4a9eff;margin-bottom:3px">üñ•Ô∏è 10-minute fix ‚Äî Deploy the server (recommended)</div>
          <div style="font-size:11px;color:var(--muted);line-height:1.6">Deploy the server ZIP to Railway ‚Äî your key is hidden, PIN-protected, works forever on any device.</div>
        </div>
      </div>
    </div>
  </div>
  <button onclick="document.getElementById('fileBanner').style.display='none'" style="margin-top:12px;background:none;border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--muted);padding:6px 14px;font-size:10px;cursor:pointer;width:100%;letter-spacing:.5px">DISMISS ‚Äî USE SMART FALLBACK ONLY</button>
</div>

<!-- ‚ïê‚ïê‚ïê STEP 1: THOUGHT + AI ELABORATE ‚ïê‚ïê‚ïê -->
<div class="card">
  <div class="stephdr">
    <span class="stepnum">1</span>
    <div><div class="stitle2">Your Seed Thought</div><div class="ssub">Even one line ‚Äî AI will turn it into a powerful 60-second script</div></div>
  </div>

  <textarea id="scriptInput" rows="4" placeholder="Write your small thought here...&#10;&#10;Examples:&#10;‚Ä¢ Belief changes life.&#10;‚Ä¢ Log mante nahi isliye fail hote hai.&#10;‚Ä¢ Man ni shakti sarahari che."></textarea>

  <!-- AI MODE SELECTOR -->
  <div style="margin-top:14px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <label class="slabel" style="margin:0">ü§ñ AI Engine</label>
      <span id="aiProviderBadge" style="font-size:10px;font-weight:700;padding:3px 10px;border-radius:20px;background:rgba(74,158,255,.15);border:1px solid rgba(74,158,255,.4);color:#4a9eff;font-family:'Space Mono',monospace;letter-spacing:.5px">üîµ Server AI</span>
    </div>

    <!-- Mode toggle -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
      <button id="modeServerBtn" class="ai-mode-btn active" onclick="setAiMode('server')">
        <span style="font-size:14px">üñ•Ô∏è</span>
        <span style="font-size:11px;font-weight:700;display:block">Server AI</span>
        <span style="font-size:9px;opacity:.7">Built-in ¬∑ No key needed</span>
      </button>
      <button id="modePersonalBtn" class="ai-mode-btn" onclick="setAiMode('personal')">
        <span style="font-size:14px">üîë</span>
        <span style="font-size:11px;font-weight:700;display:block">Personal Key</span>
        <span style="font-size:9px;opacity:.7">Your Gemini / Claude</span>
      </button>
    </div>

    <!-- Personal key input ‚Äî hidden by default -->
    <div id="personalKeyPanel" style="display:none">
      <div style="display:flex;gap:8px;align-items:center">
        <input id="apiKeyInput" type="password" placeholder="Paste Gemini (AIza...) or Claude (sk-ant-...) key"
          style="flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:9px;
                 color:var(--text);font-family:'Space Mono',monospace;font-size:11px;padding:10px 12px;outline:none;transition:border-color .2s"
          oninput="saveApiKey(this.value);updateProviderBadge(detectProvider(this.value.trim()))" autocomplete="off">
        <button onclick="toggleApiVis()" style="padding:10px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;color:var(--muted);cursor:pointer;font-size:14px">üëÅ</button>
      </div>
      <div style="font-size:10px;color:var(--muted);margin-top:5px">üîí Stored in your device only ‚Äî not sent anywhere except directly to AI</div>
    </div>

    <!-- Server mode status -->
    <div id="serverModeStatus" style="display:flex;align-items:center;gap:8px;background:rgba(74,255,128,.06);border:1px solid rgba(74,255,128,.2);border-radius:9px;padding:8px 12px">
      <div style="width:7px;height:7px;border-radius:50%;background:#4ade80;box-shadow:0 0 6px #4ade80;flex-shrink:0"></div>
      <div style="font-size:11px;color:var(--muted)">Server AI active ‚Äî <span style="color:#4ade80;font-weight:600">ready to generate</span></div>
    </div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px">
    <div>
      <label class="slabel" style="display:block;margin-bottom:6px">Language</label>
      <select id="langSel"><option value="english">üá¨üáß English</option><option value="hindi">üáÆüá≥ Hindi</option><option value="gujarati">üî∂ Gujarati</option></select>
    </div>
    <div>
      <label class="slabel" style="display:block;margin-bottom:6px">Tone & Style</label>
      <select id="toneSel"><option value="motivational">üî• Motivational</option><option value="spiritual">üïâÔ∏è Spiritual / Belief</option><option value="emotional">üíñ Emotional Story</option><option value="powerful">üí™ Powerful & Bold</option><option value="workshop">üé§ Workshop Promo</option></select>
    </div>
  </div>

  <div style="margin-top:12px">
    <label class="slabel" style="display:block;margin-bottom:8px">üé¨ Video Length</label>
    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px" id="lenBtns">
      <button class="len-btn" data-len="60s"  onclick="setLen(this)">‚ö°<br><span class="len-main">60s</span><br><span class="len-sub">Reel</span></button>
      <button class="len-btn" data-len="3min" onclick="setLen(this)">üéØ<br><span class="len-main">3 min</span><br><span class="len-sub">Short</span></button>
      <button class="len-btn active" data-len="5min" onclick="setLen(this)">üî•<br><span class="len-main">5 min</span><br><span class="len-sub">Standard</span></button>
      <button class="len-btn" data-len="10min" onclick="setLen(this)">üìñ<br><span class="len-main">10 min</span><br><span class="len-sub">Deep</span></button>
      <button class="len-btn" data-len="30min" onclick="setLen(this)">üéôÔ∏è<br><span class="len-main">30 min</span><br><span class="len-sub">Masterclass</span></button>
    </div>
  </div>

  <div style="margin-top:14px">
    <label class="slabel" style="display:block;margin-bottom:8px">üéØ Target Group</label>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px" id="tgtBtns">
      <button class="tgt-btn active" data-tgt="general"    onclick="setTgt(this)">üë•<br><span class="tgt-main">General</span><br><span class="tgt-sub">Everyone</span></button>
      <button class="tgt-btn" data-tgt="entrepreneurs"     onclick="setTgt(this)">üöÄ<br><span class="tgt-main">Entrepreneurs</span><br><span class="tgt-sub">Business owners</span></button>
      <button class="tgt-btn" data-tgt="employees"         onclick="setTgt(this)">üíº<br><span class="tgt-main">Employees</span><br><span class="tgt-sub">9-5 professionals</span></button>
      <button class="tgt-btn" data-tgt="students"          onclick="setTgt(this)">üéì<br><span class="tgt-main">Students</span><br><span class="tgt-sub">Youth & learners</span></button>
      <button class="tgt-btn" data-tgt="salespeople"       onclick="setTgt(this)">üìà<br><span class="tgt-main">Sales / MLM</span><br><span class="tgt-sub">Networkers</span></button>
      <button class="tgt-btn" data-tgt="homemakers"        onclick="setTgt(this)">üè†<br><span class="tgt-main">Homemakers</span><br><span class="tgt-sub">Family focused</span></button>
      <button class="tgt-btn" data-tgt="coaches"           onclick="setTgt(this)">üéôÔ∏è<br><span class="tgt-main">Coaches</span><br><span class="tgt-sub">Trainers & mentors</span></button>
      <button class="tgt-btn" data-tgt="spiritual_seekers" onclick="setTgt(this)">üïâÔ∏è<br><span class="tgt-main">Spiritual</span><br><span class="tgt-sub">Faith & purpose</span></button>
      <button class="tgt-btn" data-tgt="leaders"           onclick="setTgt(this)">üëë<br><span class="tgt-main">Leaders</span><br><span class="tgt-sub">Managers & CEOs</span></button>
    </div>
  </div>

  <div style="display:flex;gap:10px;margin-top:14px;flex-wrap:wrap">
    <button class="btn-p" onclick="elaborateThought()">ü§ñ AI Elaborate My Thought</button>
    <button class="btn-s" onclick="parseScript()">‚ö° Structure It</button>
  </div>

  <!-- AI OUTPUT -->
  <div style="margin-top:18px">
    <div class="ai-hdr">
      <div class="slabel" style="margin:0">AI Elaborated Script</div>
      <div class="ai-badge"><div class="ai-dot"></div>Claude AI</div>
    </div>
    <div class="elab-box">
      <div class="elab-spin" id="espin"><span>üß† Crafting your script</span><div class="tdots"><span></span><span></span><span></span></div></div>
      <div class="elab-ph" id="eph">Write a short thought above and click "AI Elaborate" ‚Äî your full script will appear here.</div>
      <div class="elab-txt" id="etxt"></div>
      <div id="eacts" style="display:none;margin-top:12px;gap:8px;flex-wrap:wrap">
        <button class="btn-s" style="font-size:12px;padding:8px 14px" onclick="useElaborated()">‚úÖ Use This Script</button>
        <button class="btn-s" style="font-size:12px;padding:8px 14px" onclick="elaborateThought()">üîÑ Regenerate</button>
        <button class="btn-s" style="font-size:12px;padding:8px 14px" onclick="copyElab()">üìã Copy</button>
      </div>
    </div>
  </div>

  <!-- STRUCTURE -->
  <div style="margin-top:18px">
    <div class="slabel">Video Structure</div>
    <div class="sg">
      <div class="si active"><span class="se">üé£</span><div class="sn">Hook</div><div class="st">0‚Äì5s</div></div>
      <div class="si"><span class="se">üòî</span><div class="sn">Problem</div><div class="st">5‚Äì20s</div></div>
      <div class="si"><span class="se">üí°</span><div class="sn">Realize</div><div class="st">20‚Äì40s</div></div>
      <div class="si"><span class="se">üî•</span><div class="sn">Solution</div><div class="st">40‚Äì60s</div></div>
      <div class="si"><span class="se">‚ú®</span><div class="sn">Closing</div><div class="st">60s</div></div>
    </div>
  </div>

  <div class="parsed" id="parsed">
    <div class="pi"><div class="plbl">üé£ Hook</div><div class="ptxt" id="ph">‚Äî</div></div>
    <div class="pi"><div class="plbl">üòî Problem</div><div class="ptxt" id="pp">‚Äî</div></div>
    <div class="pi"><div class="plbl">üí° Realization</div><div class="ptxt" id="pr">‚Äî</div></div>
    <div class="pi"><div class="plbl">üî• Solution</div><div class="ptxt" id="ps">‚Äî</div></div>
    <div class="pi"><div class="plbl">‚ú® Closing</div><div class="ptxt" id="pc">Change your belief, change your life. üî•</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê STEP 2: VOICE ‚ïê‚ïê‚ïê -->
<div class="card">
  <div class="stephdr">
    <span class="stepnum">2</span>
    <div><div class="stitle2">Voice Over</div><div class="ssub">Record, upload, or let AI speak your script</div></div>
  </div>

  <div class="vtabs">
    <div class="vtab active" id="vt-rec" onclick="selVTab('rec')"><span class="vti">üéôÔ∏è</span><div class="vtl">Record Live</div><div class="vtd">Your voice</div></div>
    <div class="vtab" id="vt-up" onclick="selVTab('up')"><span class="vti">üìÇ</span><div class="vtl">Upload MP3</div><div class="vtd">Audio file</div></div>
    <div class="vtab" id="vt-ai" onclick="selVTab('ai')"><span class="vti">ü§ñ</span><div class="vtl">AI Voice</div><div class="vtd">Male / Female</div></div>
  </div>

  <!-- RECORD -->
  <div class="vpanel on" id="vp-rec">
    <div class="rec-area">
      <button class="rec-btn" id="recBtn" onclick="toggleRec()">üéôÔ∏è</button>
      <div class="rec-st" id="recSt">Click to start recording</div>
      <div class="rec-tm" id="recTm">0:00</div>
      <div class="wf" id="wf">
        <div class="wb" id="w1"></div><div class="wb" id="w2"></div><div class="wb" id="w3"></div>
        <div class="wb" id="w4"></div><div class="wb" id="w5"></div><div class="wb" id="w6"></div>
        <div class="wb" id="w7"></div><div class="wb" id="w8"></div><div class="wb" id="w9"></div>
        <div class="wb" id="w10"></div><div class="wb" id="w11"></div><div class="wb" id="w12"></div>
      </div>
    </div>
    <div class="ib" id="recInfo"></div>
  </div>

  <!-- UPLOAD -->
  <div class="vpanel" id="vp-up">
    <div class="upz" onclick="document.getElementById('aFile').click()">
      <input type="file" id="aFile" accept="audio/*" onchange="handleAudio(event)">
      <div class="upi">üéµ</div>
      <div class="upt">Click to <span>upload MP3 / WAV</span></div>
    </div>
    <div class="ib" id="upInfo"></div>
  </div>

  <!-- AI VOICE / TTS -->
  <div class="vpanel" id="vp-ai">
    <div class="tts-p">
      <div class="slabel" style="margin-bottom:10px">Choose Voice Gender</div>
      <div class="gender-row">
        <div class="gbtn active" id="gM" onclick="selGender('male')"><span class="gi">üë®</span><div class="gl">Male Voice</div><div class="gd">Deep & Powerful</div></div>
        <div class="gbtn" id="gF" onclick="selGender('female')"><span class="gi">üë©</span><div class="gl">Female Voice</div><div class="gd">Warm & Clear</div></div>
      </div>

      <div style="margin-bottom:14px">
        <label class="slabel" style="margin-bottom:6px;display:block">Select Voice</label>
        <select id="vSel" onchange="stopSpeech()"><option>Loading voices‚Ä¶</option></select>
      </div>

      <div class="vctrl-row">
        <div class="vc"><label>SPEED</label><input type="range" id="tRate" min="0.5" max="2" step="0.05" value="0.85" oninput="document.getElementById('rv').textContent=this.value+'x'"><div class="cval" id="rv">0.85x</div></div>
        <div class="vc"><label>PITCH</label><input type="range" id="tPitch" min="0.1" max="2" step="0.05" value="1.0" oninput="document.getElementById('pv').textContent=this.value"><div class="cval" id="pv">1.0</div></div>
        <div class="vc"><label>VOLUME</label><input type="range" id="tVol" min="0" max="1" step="0.05" value="1" oninput="document.getElementById('vv').textContent=Math.round(this.value*100)+'%'"><div class="cval" id="vv">100%</div></div>
        <div class="vc"><label>PAUSE (ms)</label><input type="range" id="tPause" min="0" max="1000" step="50" value="200" oninput="document.getElementById('pausev').textContent=this.value+'ms'"><div class="cval" id="pausev">200ms</div></div>
      </div>

      <div class="tts-play-row">
        <button class="btn-p" onclick="speakTxt()" id="ttsBtn">‚ñ∂ Play AI Voice</button>
        <button class="btn-s" onclick="stopSpeech()">‚èπ Stop</button>
        <div class="sw-ind" id="swInd"><div class="sw"><span></span><span></span><span></span><span></span><span></span></div>Speaking‚Ä¶</div>
      </div>

      <div style="margin-top:14px;padding:12px;background:var(--surface);border-radius:10px;border:1px solid var(--border)">
        <div style="font-size:10px;color:var(--muted);margin-bottom:6px;font-weight:700;letter-spacing:1px">SCRIPT TO SPEAK</div>
        <div id="ttsTxt" style="font-size:13px;line-height:1.6;color:var(--text)">Elaborate a thought above first, then switch to this tab.</div>
      </div>
    </div>
  </div>

  <div style="margin-top:18px">
    <div class="trow"><div><div class="tl">Sync Voice with Text</div><div class="ts">Text animates with voice timing</div></div><div class="tog on" onclick="this.classList.toggle('on')"></div></div>
    <div class="trow"><div><div class="tl">Background Music</div><div class="ts">Cinematic ambient underneath</div></div><div class="tog on" onclick="this.classList.toggle('on')"></div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê STEP 3: IMAGE UPLOAD ‚ïê‚ïê‚ïê -->
<div class="card">
  <div class="stephdr">
    <span class="stepnum">3</span>
    <div><div class="stitle2">Upload Your Images</div><div class="ssub">Photos used inside your video ‚Äî backgrounds, overlays, slides</div></div>
  </div>

  <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap">
    <button class="btn-p" onclick="document.getElementById('imgIn').click()">üì∏ Upload Images</button>
    <button class="btn-s" onclick="clearImgs()">üóëÔ∏è Clear All</button>
    <input type="file" id="imgIn" accept="image/*" multiple style="display:none" onchange="handleImgUp(event)">
  </div>

  <div class="slabel">Uploaded Images <span style="color:var(--muted);font-size:9px">(click ‚ñ∂ to use in preview)</span></div>
  <div class="img-grid" id="imgGrid">
    <div class="img-slot" onclick="document.getElementById('imgIn').click()"><div class="img-si">‚ûï</div><div class="img-sl">Add Image</div></div>
    <div class="img-slot" onclick="document.getElementById('imgIn').click()"><div class="img-si">‚ûï</div><div class="img-sl">Add Image</div></div>
    <div class="img-slot" onclick="document.getElementById('imgIn').click()"><div class="img-si">‚ûï</div><div class="img-sl">Add Image</div></div>
  </div>

  <div style="margin-top:14px">
    <label class="slabel" style="margin-bottom:8px;display:block">Assign Image Role in Video</label>
    <div class="role-tags">
      <div class="rtag active" onclick="selRole(this)">üé¨ Background</div>
      <div class="rtag" onclick="selRole(this)">üñºÔ∏è Overlay</div>
      <div class="rtag" onclick="selRole(this)">üë§ Speaker Photo</div>
      <div class="rtag" onclick="selRole(this)">üìå Intro Slide</div>
      <div class="rtag" onclick="selRole(this)">üéØ Outro Slide</div>
      <div class="rtag" onclick="selRole(this)">üí° Transition</div>
    </div>
  </div>

  <div style="margin-top:14px">
    <div class="trow"><div><div class="tl">Ken Burns Effect</div><div class="ts">Slow zoom/pan on still images</div></div><div class="tog on" onclick="this.classList.toggle('on')"></div></div>
    <div class="trow"><div><div class="tl">Auto Slideshow</div><div class="ts">Images change with script sections</div></div><div class="tog on" onclick="this.classList.toggle('on')"></div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê STEP 4: VISUAL ENGINE ‚ïê‚ïê‚ïê -->
<div class="card">
  <div class="stephdr"><span class="stepnum">4</span><div><div class="stitle2">Visual Engine</div><div class="ssub">Background & keyword detection</div></div></div>
  <div class="slabel">Auto-Detected Keywords</div>
  <div class="kmap" id="kmap">
    <div class="kc on" onclick="this.classList.toggle('on')"><span class="ke">üèîÔ∏è</span>Struggle</div>
    <div class="kc on" onclick="this.classList.toggle('on')"><span class="ke">üåÖ</span>Belief</div>
    <div class="kc" onclick="this.classList.toggle('on')"><span class="ke">‚õ∞Ô∏è</span>Success</div>
    <div class="kc" onclick="this.classList.toggle('on')"><span class="ke">üî•</span>Fire</div>
    <div class="kc" onclick="this.classList.toggle('on')"><span class="ke">üí™</span>Power</div>
    <div class="kc" onclick="this.classList.toggle('on')"><span class="ke">üß†</span>Mind</div>
  </div>
  <div class="slabel" style="margin-top:14px">Background Gradient <span style="color:var(--muted);font-size:9px">(or use images above)</span></div>
  <div class="bgg" id="bgg">
    <div class="bgt b0 sel" onclick="selBg(0)"><div class="ck">‚úì</div><div class="blbl">Deep Space</div></div>
    <div class="bgt b1" onclick="selBg(1)"><div class="ck">‚úì</div><div class="blbl">Desert Fire</div></div>
    <div class="bgt b2" onclick="selBg(2)"><div class="ck">‚úì</div><div class="blbl">Ocean Dark</div></div>
    <div class="bgt b3" onclick="selBg(3)"><div class="ck">‚úì</div><div class="blbl">Ember</div></div>
    <div class="bgt b4" onclick="selBg(4)"><div class="ck">‚úì</div><div class="blbl">Forest</div></div>
    <div class="bgt b5" onclick="selBg(5)"><div class="ck">‚úì</div><div class="blbl">Cosmic</div></div>
    <div class="bgt b6" onclick="selBg(6)"><div class="ck">‚úì</div><div class="blbl">Blood</div></div>
    <div class="bgt b7" onclick="selBg(7)"><div class="ck">‚úì</div><div class="blbl">Pure Dark</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê STEP 5: TEXT ANIMATION ‚ïê‚ïê‚ïê -->
<div class="card">
  <div class="stephdr"><span class="stepnum">5</span><div><div class="stitle2">Text Animation</div></div></div>
  <div class="arow">
    <div class="abtn active" onclick="selAnim('fi',this)"><span class="ai">üåü</span>Fade In</div>
    <div class="abtn" onclick="selAnim('tw',this)"><span class="ai">‚å®Ô∏è</span>Typewriter</div>
    <div class="abtn" onclick="selAnim('zi',this)"><span class="ai">üîç</span>Zoom</div>
    <div class="abtn" onclick="selAnim('su',this)"><span class="ai">‚¨ÜÔ∏è</span>Slide Up</div>
    <div class="abtn" onclick="selAnim('ci',this)"><span class="ai">üé¨</span>Cinematic</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê STEP 6: EMOJIS ‚ïê‚ïê‚ïê -->
<div class="card">
  <div class="stephdr"><span class="stepnum">6</span><div><div class="stitle2">Emoji Engine</div><div class="ssub">Auto-detected from script</div></div></div>
  <div class="emo-row">
    <div class="ec on" onclick="togEmoji(this)">üòî<span class="elbl">Pain</span></div>
    <div class="ec on" onclick="togEmoji(this)">üî•<span class="elbl">Fire</span></div>
    <div class="ec" onclick="togEmoji(this)">üí™<span class="elbl">Power</span></div>
    <div class="ec" onclick="togEmoji(this)">üß†<span class="elbl">Mind</span></div>
    <div class="ec" onclick="togEmoji(this)">üèÜ<span class="elbl">Win</span></div>
    <div class="ec on" onclick="togEmoji(this)">‚ú®<span class="elbl">Magic</span></div>
    <div class="ec" onclick="togEmoji(this)">‚ö°<span class="elbl">Energy</span></div>
    <div class="ec" onclick="togEmoji(this)">üåÖ<span class="elbl">Hope</span></div>
    <div class="ec" onclick="togEmoji(this)">üöÄ<span class="elbl">Rise</span></div>
    <div class="ec" onclick="togEmoji(this)">‚ù§Ô∏è<span class="elbl">Love</span></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê STEP 7: FILTERS ‚ïê‚ïê‚ïê -->
<div class="card">
  <div class="stephdr"><span class="stepnum">7</span><div><div class="stitle2">Cinematic Filter</div></div></div>
  <div class="frow">
    <div class="fb active fc" data-n="Cinematic" onclick="selFilter(this)"></div>
    <div class="fb fw" data-n="Warm Motiv." onclick="selFilter(this)"></div>
    <div class="fb fd" data-n="Dark Intense" onclick="selFilter(this)"></div>
    <div class="fb fbr" data-n="Bright Positive" onclick="selFilter(this)"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê STEP 8: PLATFORM & FORMAT ‚ïê‚ïê‚ïê -->
<div class="card">
  <div class="stephdr"><span class="stepnum">8</span><div><div class="stitle2">Platform & Format</div></div></div>
  <div class="slabel">Platform</div>
  <div class="prow">
    <div class="pbtn" onclick="selPlat(this)"><span class="pi2">‚ñ∂Ô∏è</span>YouTube</div>
    <div class="pbtn active" onclick="selPlat(this)"><span class="pi2">üì±</span>Reels</div>
    <div class="pbtn" onclick="selPlat(this)"><span class="pi2">üë•</span>Facebook</div>
    <div class="pbtn" onclick="selPlat(this)"><span class="pi2">‚ö°</span>Shorts</div>
    <div class="pbtn" onclick="selPlat(this)"><span class="pi2">üé§</span>Workshop</div>
  </div>
  <div class="slabel" style="margin-top:16px">Aspect Ratio</div>
  <div class="rrow">
    <div class="rbtn r916 active" onclick="selRatio('r916',this)"><div class="rv"><div class="rect"></div></div><div class="rn">9:16</div><div class="rd">Reels/Shorts</div></div>
    <div class="rbtn r169" onclick="selRatio('r169',this)"><div class="rv"><div class="rect"></div></div><div class="rn">16:9</div><div class="rd">YouTube</div></div>
    <div class="rbtn r11" onclick="selRatio('r11',this)"><div class="rv"><div class="rect"></div></div><div class="rn">1:1</div><div class="rd">Feed Post</div></div>
  </div>
</div>

<!-- STRATEGY -->
<div class="strat">
  <div class="stratp">üéØ Your Creator Flow</div>
  <div class="sflow">
    <div class="fs">üí° Small Thought</div><div class="fa">‚Üí</div>
    <div class="fs">ü§ñ AI Elaborates</div><div class="fa">‚Üí</div>
    <div class="fs">üéôÔ∏è Choose Voice</div><div class="fa">‚Üí</div>
    <div class="fs">üì∏ Add Images</div><div class="fa">‚Üí</div>
    <div class="fs">üé¨ Filter+Anim</div><div class="fa">‚Üí</div>
    <div class="fs">üì§ Export</div>
  </div>
</div>

<!-- TIPS -->
<div class="card">
  <div class="slabel">For You, Pradeepbhai</div>
  <div class="stitle">Trainer Power Secrets</div>
  <div class="tips">
    <div class="ti"><div class="ticon">ü§ñ</div><div><div class="ttl">AI Writes, You Inspire</div><div class="tdsc">Just give a seed thought. Let Claude expand it into a full emotional script in your style.</div></div></div>
    <div class="ti"><div class="ticon">üéôÔ∏è</div><div><div class="ttl">Your Voice = Your Brand</div><div class="tdsc">When you can't record, AI male/female voice keeps your content flowing daily.</div></div></div>
    <div class="ti"><div class="ticon">üì∏</div><div><div class="ttl">Real Photos = Trust</div><div class="tdsc">Upload your own event/training photos. Authenticity outperforms stock images.</div></div></div>
    <div class="ti"><div class="ticon">ü§´</div><div><div class="ttl">Silence = Power</div><div class="tdsc">Use TTS Pause control to add silence after key lines. Let words breathe.</div></div></div>
  </div>
</div>

</div><!-- END LEFT -->

<!-- RIGHT: PREVIEW + EXPORT -->
<div class="prev-panel">
  <div class="prev-card">
    <div class="prev-hdr">
      <div class="prev-t">Live Preview</div>
      <div style="display:flex;align-items:center;gap:10px">
        <div class="prev-live"><div class="ldot"></div>Live</div>
        <button onclick="openFullPreview()" style="display:inline-flex;align-items:center;gap:6px;padding:6px 14px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:8px;color:#fff;font-family:'DM Sans',sans-serif;font-weight:700;font-size:11px;cursor:pointer;letter-spacing:.5px;transition:all .2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">‚ñ∂ Full Preview</button>
      </div>
    </div>
    <div class="prev-scr r916" id="pScr">
      <div class="pbg" id="pBg"></div>
      <img class="puimg" id="pUImg" src="" alt="">
      <div class="pov"></div>
      <div class="pcnt">
        <div class="pemo" id="pEmo">üòî üî• ‚ú®</div>
        <div class="ptxt fi" id="pTxt">Most people fail not because they are weak‚Ä¶ but because their belief is weak.</div>
        <div class="psig">‚Äî Pradeep Parmar</div>
      </div>
    </div>
    <div class="playbar">
      <div class="ptrack"><div class="pfill" id="pFill"></div></div>
      <div class="pctrl">
        <button class="playbtn" id="playBtn" onclick="togPlay()">‚ñ∂</button>
        <div class="timd" id="timD">0:00 / 1:00</div>
        <div style="font-size:11px;color:var(--muted);font-family:'Space Mono',monospace" id="ratioLbl">9:16</div>
      </div>
    </div>
  </div>

  <div class="exc">
    <div class="slabel">Export Options</div>
    <div class="stitle" style="font-size:22px">Export Video</div>
    <div class="qrow">
      <div class="qbtn active" onclick="selQ(this)">1080p <span class="qb">HD</span></div>
      <div class="qbtn" onclick="selQ(this)">4K <span class="qb" style="background:var(--gold);color:#000">PRO</span></div>
    </div>
    <div style="margin-bottom:16px">
      <div class="trow"><div><div class="tl">Watermark</div><div class="ts">"Pradeep Parmar Presents"</div></div><div class="tog on" onclick="this.classList.toggle('on')"></div></div>
      <div class="trow"><div><div class="tl">Auto Captions</div><div class="ts">From voice-over transcript</div></div><div class="tog" onclick="this.classList.toggle('on')"></div></div>
      <div class="trow"><div><div class="tl">Intro Animation</div><div class="ts">"Pradeep Parmar Presents"</div></div><div class="tog on" onclick="this.classList.toggle('on')"></div></div>
    </div>
    <button class="editbtn" onclick="openVideoEditor()">‚úÇÔ∏è Edit Video</button>
    <button class="exbtn" onclick="doExport()">‚¨á Export Video</button>
    <div class="epw" id="epw"><div class="ep"><div class="epf" id="epf"></div></div><div style="text-align:center;margin-top:8px;font-family:'Space Mono',monospace;font-size:11px;color:var(--muted)" id="epct">0%</div></div>
    <div class="est" id="est">‚úÖ Video ready! Downloading‚Ä¶</div>
    <div class="div"></div>
    <div style="font-family:'Space Mono',monospace;font-size:9px;color:var(--muted);text-align:center;letter-spacing:1px;line-height:2">
      PRADEEP PARMAR PRESENTS<br><span style="color:var(--accent);font-size:11px;letter-spacing:2px">Change Your Belief, Change Your Life üî•</span>
    </div>
  </div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VIDEO EDITOR MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="vedModal">
  <!-- TOPBAR -->
  <div class="ved-top">
    <div class="ved-logo">‚úÇÔ∏è <span>Video Editor</span></div>
    <div class="ved-top-actions">
      <button class="ved-btn-apply" onclick="vedApply()">‚úÖ Apply Changes</button>
      <button class="ved-btn-close" onclick="closeVideoEditor()">‚úï Close</button>
    </div>
  </div>

  <div class="ved-body">
    <!-- LEFT: Mini Canvas Preview -->
    <div class="ved-left">
      <div class="ved-preview-label">PREVIEW</div>
      <div class="ved-canvas-wrap">
        <canvas id="vedCanvas" width="270" height="480"></canvas>
        <div class="ved-canvas-sec" id="vedCanvasLabel">INTRO</div>
      </div>
      <div class="ved-nav-btns">
        <button onclick="vedPrev()">‚è™ Prev</button>
        <button onclick="vedNext()">Next ‚è©</button>
      </div>

      <!-- Music Panel -->
      <div class="ved-music-box">
        <div class="ved-section-hdr">üéµ Background Music</div>
        <label class="ved-upload-lbl">
          <input type="file" accept="audio/*" id="vedMusicFile" onchange="vedLoadMusic(this)">
          üìÇ Upload Audio
        </label>
        <div id="vedMusicName" class="ved-music-name">No music selected</div>
        <div class="ved-music-controls" id="vedMusicControls" style="display:none">
          <div class="ved-row">
            <span>üîä Volume</span>
            <input type="range" id="vedMusicVol" min="0" max="100" value="40" oninput="vedUpdateMusicVol(this.value)">
            <span id="vedMusicVolV">40%</span>
          </div>
          <div class="ved-row">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="checkbox" id="vedMusicLoop" checked style="accent-color:var(--accent)"> Loop
            </label>
            <button class="ved-smol-btn" id="vedMusicPlayBtn" onclick="vedPreviewMusic()">‚ñ∂ Preview</button>
          </div>
        </div>
      </div>
    </div>

    <!-- CENTER: Timeline -->
    <div class="ved-center">
      <div class="ved-section-hdr" style="margin-bottom:10px">üìã TIMELINE ‚Äî click a section to edit</div>
      <div class="ved-timeline" id="vedTimeline"></div>
      <div class="ved-tl-hint">Drag right edge of any section to adjust duration</div>

      <!-- Section Properties -->
      <div class="ved-props-box" id="vedProps">
        <div class="ved-props-hdr" id="vedPropTitle">Select a section</div>

        <!-- TABS -->
        <div class="ved-tabs">
          <button class="ved-tab active" onclick="vedTab('text',this)">üìù Text</button>
          <button class="ved-tab" onclick="vedTab('image',this)">üñºÔ∏è Image</button>
          <button class="ved-tab" onclick="vedTab('style',this)">üé® Style</button>
          <button class="ved-tab" onclick="vedTab('timing',this)">‚è±Ô∏è Timing</button>
        </div>

        <!-- TEXT TAB -->
        <div class="ved-tab-panel active" id="vedTabText">
          <label class="ved-lbl">Section Text</label>
          <textarea id="vedTextInput" class="ved-textarea" rows="4" placeholder="Enter section text‚Ä¶" oninput="vedTextChange(this.value)"></textarea>
          <div class="ved-char-count" id="vedCharCount">0 chars</div>
          <label class="ved-lbl" style="margin-top:12px">Font Size</label>
          <div class="ved-row">
            <input type="range" id="vedFontSize" min="60" max="130" value="88" oninput="vedFontChange(this.value)">
            <span id="vedFontSizeV" class="ved-val">88px</span>
          </div>
          <label class="ved-lbl" style="margin-top:10px">Text Position</label>
          <div class="ved-pos-btns">
            <button onclick="vedSetPos('top',this)">Top</button>
            <button onclick="vedSetPos('center',this)" class="active">Center</button>
            <button onclick="vedSetPos('bottom',this)">Bottom</button>
          </div>
        </div>

        <!-- IMAGE TAB -->
        <div class="ved-tab-panel" id="vedTabImage">
          <label class="ved-lbl">Section Background Image</label>
          <div class="ved-img-grid" id="vedImgGrid"></div>
          <div class="ved-lbl" style="margin-top:10px;font-size:10px;color:var(--muted)">
            Select from uploaded images. Each section can have its own image.
          </div>
          <label class="ved-lbl" style="margin-top:12px">Image Opacity</label>
          <div class="ved-row">
            <input type="range" id="vedImgOpacity" min="10" max="90" value="42" oninput="vedImgOpacityChange(this.value)">
            <span id="vedImgOpacityV" class="ved-val">42%</span>
          </div>
          <button class="ved-smol-btn" style="margin-top:8px;width:100%" onclick="vedClearSectionImg()">üóëÔ∏è Remove Section Image</button>
        </div>

        <!-- STYLE TAB -->
        <div class="ved-tab-panel" id="vedTabStyle">
          <label class="ved-lbl">Background Theme</label>
          <div class="ved-color-grid" id="vedColorGrid"></div>
          <label class="ved-lbl" style="margin-top:14px">Text Color</label>
          <div class="ved-color-row">
            <div class="ved-color-swatch active" style="background:#ffffff" data-color="#ffffff" onclick="vedSetTextColor('#ffffff',this)"></div>
            <div class="ved-color-swatch" style="background:#ffb347" data-color="#ffb347" onclick="vedSetTextColor('#ffb347',this)"></div>
            <div class="ved-color-swatch" style="background:#ff6b2b" data-color="#ff6b2b" onclick="vedSetTextColor('#ff6b2b',this)"></div>
            <div class="ved-color-swatch" style="background:#f5c842" data-color="#f5c842" onclick="vedSetTextColor('#f5c842',this)"></div>
            <div class="ved-color-swatch" style="background:#2dce89" data-color="#2dce89" onclick="vedSetTextColor('#2dce89',this)"></div>
            <div class="ved-color-swatch" style="background:#4a9eff" data-color="#4a9eff" onclick="vedSetTextColor('#4a9eff',this)"></div>
          </div>
          <label class="ved-lbl" style="margin-top:14px">Transition Effect</label>
          <div class="ved-trans-grid">
            <button class="ved-trans-btn active" onclick="vedSetTrans('fade',this)">‚ú® Fade</button>
            <button class="ved-trans-btn" onclick="vedSetTrans('slide',this)">‚û°Ô∏è Slide</button>
            <button class="ved-trans-btn" onclick="vedSetTrans('zoom',this)">üîç Zoom</button>
            <button class="ved-trans-btn" onclick="vedSetTrans('wipe',this)">üé¨ Wipe</button>
          </div>
        </div>

        <!-- TIMING TAB -->
        <div class="ved-tab-panel" id="vedTabTiming">
          <label class="ved-lbl">Section Duration</label>
          <div class="ved-row" style="margin-bottom:16px">
            <input type="range" id="vedDurSlider" min="2" max="20" value="10" oninput="vedDurChange(this.value)">
            <span id="vedDurV" class="ved-val">10s</span>
          </div>
          <div class="ved-dur-presets">
            <button onclick="vedSetDur(5)">5s</button>
            <button onclick="vedSetDur(8)">8s</button>
            <button onclick="vedSetDur(12)">12s</button>
            <button onclick="vedSetDur(15)">15s</button>
          </div>
          <div class="ved-lbl" style="margin-top:16px">Total Video Duration</div>
          <div class="ved-total-dur" id="vedTotalDur">0:00</div>
          <div class="ved-all-durs" id="vedAllDurs"></div>
        </div>
      </div>
    </div>
  </div>
</div><!-- end vedModal -->

</div><!-- END RIGHT -->
</div><!-- END MAIN -->

<div class="toast" id="toast"><span>üî•</span><span id="tmsg">Done!</span></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FULL VIDEO PREVIEW MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="fpModal">

  <!-- Background layers -->
  <div id="fpBg"></div>
  <div id="fpImgBg"></div>
  <div class="fp-vignette"></div>
  <div class="fp-grad-top"></div>
  <div class="fp-grad-bot"></div>

  <!-- TOP BAR: section label + timer + close -->
  <div class="fp-topbar">
    <div class="fp-rec-dot"></div>
    <span id="fpSectionLabel" class="fp-sec-lbl">INTRO</span>
    <div style="flex:1"></div>
    <span id="fpTimerDisplay" class="fp-timer">0:00</span>
    <button class="fp-close-btn" onclick="closeFullPreview()">‚úï</button>
  </div>

  <!-- PROGRESS DOTS -->
  <div class="fp-dots">
    <div class="fpdot" data-i="0"></div>
    <div class="fpdot" data-i="1"></div>
    <div class="fpdot" data-i="2"></div>
    <div class="fpdot" data-i="3"></div>
    <div class="fpdot" data-i="4"></div>
  </div>

  <!-- INTRO SLIDE -->
  <div id="fpIntro" class="fp-slide">
    <div class="fp-intro-pre">PRADEEP PARMAR PRESENTS</div>
    <div id="fpIntroTitle" class="fp-intro-title"></div>
    <div class="fp-divider"></div>
    <div class="fp-intro-tag">Belief ¬∑ Mind ¬∑ Life</div>
  </div>

  <!-- CONTENT SLIDE (hook / problem / realize / solution / closing) -->
  <div id="fpContent" class="fp-slide fp-content-layout">
    <!-- Top: badge + emoji -->
    <div class="fp-top-area">
      <div id="fpBadge" class="fp-badge"></div>
      <div id="fpEmoji" class="fp-emoji-row"></div>
    </div>
    <!-- Center: BIG main text -->
    <div class="fp-center-area">
      <div id="fpText" class="fp-main-text"></div>
    </div>
    <!-- Bottom: signature -->
    <div class="fp-bottom-area">
      <div class="fp-sig">‚Äî Pradeep Parmar</div>
    </div>
  </div>

  <!-- OUTRO SLIDE -->
  <div id="fpOutro" class="fp-slide">
    <div class="fp-outro-fire">üî•</div>
    <div class="fp-outro-line1">Change Your Belief</div>
    <div class="fp-outro-line2">Change Your Life</div>
    <div class="fp-divider"></div>
    <div class="fp-sig" style="color:rgba(255,255,255,0.5);font-size:11px;letter-spacing:3px">‚Äî Pradeep Parmar</div>
  </div>

  <!-- BOTTOM CONTROLS -->
  <div class="fp-controls">
    <!-- Timeline -->
    <div class="fp-timeline-wrap">
      <div id="fpTimeline" class="fp-timeline" onclick="seekPreview(event)">
        <div id="fpBar" class="fp-bar">
          <div class="fp-bar-dot"></div>
        </div>
      </div>
      <div class="fp-tl-labels">
        <span>INTRO</span><span>HOOK</span><span>PROBLEM</span><span>REALIZE</span><span>SOLUTION</span><span>OUTRO</span>
      </div>
    </div>
    <!-- Buttons row -->
    <div class="fp-btn-row">
      <div class="fp-btn-left">
        <button class="fp-btn-sm" onclick="restartPreview()" title="Restart">‚èÆ</button>
        <button class="fp-btn-sm" onclick="prevSection()" title="Prev">‚è™</button>
        <button id="fpPlayBtn" class="fp-btn-play" onclick="toggleFpPlay()">‚ñ∂</button>
        <button class="fp-btn-sm" onclick="nextSection()" title="Next">‚è©</button>
        <button id="fpVoiceBtn" class="fp-btn-sm" onclick="toggleFpVoice()" title="Voice">üîä</button>
      </div>
      <div class="fp-btn-right">
        <span id="fpFullTime" class="fp-timer">0:00 / 0:00</span>
        <button class="fp-btn-export" onclick="closeFullPreview();doExport()">‚¨á Export</button>
      </div>
    </div>
  </div>

</div><!-- end fpModal -->

<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FULL PREVIEW MODAL ‚Äî clean mobile-first
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#fpModal {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 99999;
  background: #000;
  overflow: hidden;
}
#fpModal.open {
  display: block;
  animation: fpFadeIn .35s ease forwards;
}
@keyframes fpFadeIn { from{opacity:0} to{opacity:1} }

/* Background layers */
#fpBg {
  position: absolute; inset: 0;
  background: linear-gradient(135deg,#1a1a2e,#16213e,#0f3460);
  background-size: cover; background-position: center;
  transition: background 1s ease;
  z-index: 0;
}
#fpImgBg {
  position: absolute; inset: 0;
  background-size: cover; background-position: center;
  opacity: 0; z-index: 1;
  transition: opacity .8s ease;
}
.fp-vignette {
  position: absolute; inset: 0; z-index: 2; pointer-events: none;
  background: radial-gradient(ellipse at center, transparent 25%, rgba(0,0,0,0.75) 100%);
}
.fp-grad-top {
  position: absolute; top: 0; left: 0; right: 0; height: 180px; z-index: 2; pointer-events: none;
  background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
}
.fp-grad-bot {
  position: absolute; bottom: 0; left: 0; right: 0; height: 220px; z-index: 2; pointer-events: none;
  background: linear-gradient(to top, rgba(0,0,0,0.92), transparent);
}

/* TOP BAR */
.fp-topbar {
  position: absolute; top: 0; left: 0; right: 0; z-index: 20;
  display: flex; align-items: center; gap: 10px;
  padding: 16px 20px 12px;
}
.fp-rec-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: #ff4757; animation: blink 1.2s infinite; flex-shrink: 0;
}
.fp-sec-lbl {
  font-family: 'Space Mono', monospace; font-size: 10px;
  letter-spacing: 3px; color: rgba(255,255,255,0.7); text-transform: uppercase;
}
.fp-timer {
  font-family: 'Space Mono', monospace; font-size: 11px;
  color: rgba(255,255,255,0.5);
}
.fp-close-btn {
  width: 32px; height: 32px; border-radius: 50%;
  background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2);
  color: #fff; font-size: 14px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: background .2s;
}
.fp-close-btn:hover { background: rgba(255,71,87,0.7); }

/* PROGRESS DOTS */
.fp-dots {
  position: absolute; top: 56px; left: 50%; transform: translateX(-50%);
  z-index: 20; display: flex; gap: 7px; align-items: center;
}
.fpdot {
  width: 7px; height: 7px; border-radius: 50%;
  background: rgba(255,255,255,0.22);
  border: 1px solid rgba(255,255,255,0.1);
  transition: all .3s;
}
.fpdot.active { background: var(--accent); box-shadow: 0 0 8px rgba(255,107,43,0.8); transform: scale(1.35); }
.fpdot.done   { background: rgba(255,107,43,0.45); }

/* SLIDES ‚Äî all absolute, fill the screen */
.fp-slide {
  position: absolute; inset: 0; z-index: 10;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  text-align: center;
  opacity: 0; pointer-events: none;
  transition: opacity .5s ease;
  padding: 80px 32px 180px; /* top=topbar, bot=controls */
}
.fp-slide.fp-visible { opacity: 1; pointer-events: auto; }

/* INTRO slide */
.fp-intro-pre {
  font-family: 'Space Mono', monospace; font-size: 10px;
  letter-spacing: 5px; color: rgba(255,255,255,0.4);
  text-transform: uppercase; margin-bottom: 18px;
}
.fp-intro-title {
  font-family: 'Bebas Neue', sans-serif;
  font-size: clamp(32px, 8vw, 72px);
  letter-spacing: 4px; color: #fff; line-height: 1.05;
  text-shadow: 0 0 60px rgba(255,107,43,0.7);
  max-width: 90%;
}
.fp-intro-tag {
  font-family: 'Space Mono', monospace; font-size: 11px;
  letter-spacing: 3px; color: var(--accent2); text-transform: uppercase;
}
.fp-divider {
  width: 50px; height: 2px;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  margin: 20px auto; border-radius: 2px;
}

/* CONTENT SLIDE ‚Äî badge top-left, text centered, sig bottom */
.fp-content-layout {
  justify-content: flex-start !important;
  align-items: stretch !important;
  text-align: left !important;
  padding: 100px 28px 160px !important; /* clear topbar & controls */
}
.fp-top-area {
  display: flex; flex-direction: column; gap: 10px;
  flex-shrink: 0;
}
.fp-badge {
  display: inline-flex; align-items: center;
  background: rgba(255,107,43,0.2);
  border: 1px solid rgba(255,107,43,0.4);
  border-radius: 100px; padding: 5px 14px;
  font-size: 11px; font-weight: 700; letter-spacing: 2px;
  color: var(--accent2); text-transform: uppercase;
  width: fit-content; backdrop-filter: blur(8px);
  opacity: 0; transform: translateY(8px);
  transition: all .4s ease;
}
.fp-badge.fp-in { opacity: 1; transform: translateY(0); }

.fp-emoji-row {
  font-size: clamp(20px,4vw,30px); letter-spacing: 6px;
  opacity: 0; transform: translateY(8px);
  transition: all .4s ease .08s;
}
.fp-emoji-row.fp-in { opacity: 1; transform: translateY(0); }

/* CENTER: main text ‚Äî this is the hero, vertically centered in remaining space */
.fp-center-area {
  flex: 1;
  display: flex;
  align-items: center; /* vertical center */
  padding: 16px 0;
}
.fp-main-text {
  font-family: 'DM Sans', sans-serif;  /* readable body font, not caps */
  font-size: clamp(18px, 4.5vw, 36px);
  font-weight: 700;
  line-height: 1.45;
  letter-spacing: 0.3px;
  color: #fff;
  text-shadow: 0 2px 20px rgba(0,0,0,0.95), 0 0 40px rgba(0,0,0,0.8);
  word-break: break-word;
  opacity: 0; transform: translateY(20px);
  transition: all .6s cubic-bezier(.22,1,.36,1) .15s;
  width: 100%;
}
.fp-main-text.fp-in { opacity: 1; transform: translateY(0); }

/* Word highlight (karaoke) */
.fpw { transition: color .1s, text-shadow .1s; }
.fpw-on {
  color: #FFB347 !important;
  text-shadow: 0 0 12px rgba(255,179,71,1), 0 0 28px rgba(255,107,43,0.7) !important;
}

.fp-bottom-area {
  flex-shrink: 0;
  padding-top: 8px;
}
.fp-sig {
  font-family: 'Space Mono', monospace; font-size: 9px;
  letter-spacing: 3px; color: rgba(255,255,255,0.3); text-transform: uppercase;
}

/* OUTRO */
.fp-outro-fire { font-size: clamp(40px,8vw,72px); margin-bottom: 16px; }
.fp-outro-line1 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: clamp(28px,5vw,56px); letter-spacing: 4px; color: #fff; margin-bottom: 4px;
}
.fp-outro-line2 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: clamp(28px,5vw,56px); letter-spacing: 4px;
  background: linear-gradient(90deg, var(--accent), var(--gold));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}

/* BOTTOM CONTROLS */
.fp-controls {
  position: absolute; bottom: 0; left: 0; right: 0; z-index: 20;
  padding: 12px 20px 24px;
  background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.6) 60%, transparent 100%);
}
.fp-timeline-wrap { margin-bottom: 12px; }
.fp-timeline {
  height: 3px; background: rgba(255,255,255,0.15);
  border-radius: 3px; position: relative; cursor: pointer;
  overflow: visible;
}
.fp-bar {
  height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2));
  border-radius: 3px; width: 0%; position: relative;
  transition: width .08s linear;
}
.fp-bar-dot {
  width: 11px; height: 11px; background: #fff; border-radius: 50%;
  position: absolute; right: -5px; top: -4px;
  box-shadow: 0 0 8px rgba(255,107,43,0.9);
}
.fp-tl-labels {
  display: flex; justify-content: space-between; margin-top: 5px;
}
.fp-tl-labels span {
  font-family: 'Space Mono', monospace; font-size: 7px;
  color: rgba(255,255,255,0.22); letter-spacing: 1px;
}

.fp-btn-row {
  display: flex; align-items: center; justify-content: space-between;
}
.fp-btn-left { display: flex; align-items: center; gap: 10px; }
.fp-btn-right { display: flex; align-items: center; gap: 10px; }

.fp-btn-sm {
  width: 36px; height: 36px; border-radius: 50%;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.15);
  color: #fff; font-size: 13px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .2s; flex-shrink: 0;
}
.fp-btn-sm:hover { background: rgba(255,255,255,0.2); }

.fp-btn-play {
  width: 50px; height: 50px; border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border: none; color: #fff; font-size: 20px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 4px 18px rgba(255,107,43,0.55);
  transition: all .2s; flex-shrink: 0;
}
.fp-btn-play:active { transform: scale(0.93); }

.fp-btn-export {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 8px 14px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border: none; border-radius: 9px; color: #fff;
  font-family: 'DM Sans', sans-serif; font-weight: 700;
  font-size: 12px; cursor: pointer; letter-spacing: .5px;
  white-space: nowrap;
}

/* Ken Burns */
@keyframes kb1 { 0%{transform:scale(1) translate(0,0)} 100%{transform:scale(1.14) translate(-2%,-1%)} }
@keyframes kb2 { 0%{transform:scale(1.08) translate(-1%,0)} 100%{transform:scale(1) translate(1%,1%)} }
@keyframes kb3 { 0%{transform:scale(1) translate(0,0)} 100%{transform:scale(1.1) translate(2%,-2%)} }
.kb1 { animation: kb1 12s ease-in-out infinite alternate; }
.kb2 { animation: kb2 10s ease-in-out infinite alternate; }
.kb3 { animation: kb3 14s ease-in-out infinite alternate; }

/* Section background colours */
.fpbg-hook     { background: linear-gradient(135deg,#1a1a2e,#16213e,#0f3460) !important; }
.fpbg-problem  { background: linear-gradient(135deg,#2a0000,#3d0000,#5a0000) !important; }
.fpbg-realize  { background: linear-gradient(135deg,#1a1200,#3d2800,#5c3c00) !important; }
.fpbg-solution { background: linear-gradient(135deg,#001a0a,#003d1a,#005c28) !important; }
.fpbg-closing  { background: linear-gradient(135deg,#0f003d,#1a0064,#2a0096) !important; }
</style>



<script>

// ‚îÄ‚îÄ Canvas roundRect polyfill (for browsers that don't support it natively) ‚îÄ‚îÄ
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
    r=Math.min(r,w/2,h/2);
    this.beginPath();
    this.moveTo(x+r,y);
    this.lineTo(x+w-r,y);
    this.quadraticCurveTo(x+w,y,x+w,y+r);
    this.lineTo(x+w,y+h-r);
    this.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
    this.lineTo(x+r,y+h);
    this.quadraticCurveTo(x,y+h,x,y+h-r);
    this.lineTo(x,y+r);
    this.quadraticCurveTo(x,y,x+r,y);
    this.closePath();
    return this;
  };
}

// ----------------------------------------------------------------------------------------------------
// SINGLE SOURCE OF TRUTH  ‚Äî VS object
// ALL features read content from here. No DOM scraping.
// ----------------------------------------------------------------------------------------------------
const VS = {
  seedThought:'', hook:'', problem:'', realization:'', solution:'',
  closing:'Change your belief, change your life. üî•',
  emojis:'üòî üî• ‚ú®'
};
let elabRaw = '';   // raw string from AI, kept for re-parsing

// ‚îÄ‚îÄ Robust section extractor ‚îÄ‚îÄ
// Emoji-agnostic: strips ALL non-ASCII symbols before matching keywords.
// Works in every browser regardless of emoji encoding/surrogate pairs.
function parseIntoVS(raw) {
  if (!raw) return;
  elabRaw = raw;

  const lines = raw.replace(/\r/g, '').split('\n');
  const sections = {};
  let currentKey = null;
  let currentLines = [];

  // Strip leading emojis / unicode symbols from a line, leaving only text
  function stripLeadingEmoji(line) {
    // Remove any char that is NOT basic Latin, Indian scripts, punctuation, digits, spaces
    return line.replace(/^[\s\u00A0\u200B-\u200D\uFEFF]*/, '')  // strip zero-width + nbsp
               .replace(/^[^\w\s\u0900-\u097F\u0A80-\u0AFF"'(]+/, '') // strip leading symbols/emoji
               .trim();
  }

  const HEADER = /^(HOOK|PROBLEM|REALIZATION|SOLUTION|CLOSING)\s*[:\-]?\s*([\s\S]*)/i;

  for (const line of lines) {
    const stripped = stripLeadingEmoji(line);
    const m = stripped.match(HEADER);
    if (m) {
      // Save previous section before starting new one
      if (currentKey) sections[currentKey] = currentLines.join(' ').replace(/\s+/g,' ').trim();
      currentKey = m[1].toUpperCase();
      const rest = m[2].trim();
      currentLines = rest ? [rest] : [];
    } else if (currentKey) {
      // Continuation line ‚Äî add if non-empty and not another header
      const cont = line.trim();
      if (cont) currentLines.push(cont);
    }
  }
  // Save the last section
  if (currentKey) sections[currentKey] = currentLines.join(' ').replace(/\s+/g,' ').trim();

  // Assign to VS ‚Äî use seedThought as fallback for hook only
  VS.hook        = sections['HOOK']        || VS.seedThought || '';
  VS.problem     = sections['PROBLEM']     || '';
  VS.realization = sections['REALIZATION'] || '';
  VS.solution    = sections['SOLUTION']    || '';
  VS.closing     = sections['CLOSING']     || 'Change your belief, change your life. üî•';
}

// -------------------------------------------------- APP STATE --------------------------------------------------
let isRec=false, recInt=null, recSec=0, wInt=null;
let isPlay=false, pInt=null, pProg=0;
let curRatio='r916', curAnim='fi';
let imgs=[], activeImg=-1, curGender='male', allVoices=[];

// -------------------------------------------------- TOAST --------------------------------------------------
function toast(msg, dur=3200){
  document.getElementById('tmsg').textContent=msg;
  const t=document.getElementById('toast');
  // Error styling for messages starting with ‚ö†Ô∏è or ‚ùå
  const isErr = msg.startsWith('‚ö†Ô∏è')||msg.startsWith('‚ùå')||msg.startsWith('‚è≥');
  t.style.borderColor = isErr ? 'var(--danger)' : 'var(--accent)';
  t.style.maxWidth = isErr ? '340px' : '';
  t.style.fontSize = isErr ? '11px' : '';
  t.style.lineHeight = isErr ? '1.5' : '';
  t.classList.add('on');
  if(toast._timer) clearTimeout(toast._timer);
  toast._timer = setTimeout(()=>{ t.classList.remove('on'); t.style.borderColor=''; t.style.maxWidth=''; }, dur);
}

// -------------------------------------------------- AI ELABORATE --------------------------------------------------
// ‚îÄ‚îÄ API Key helpers ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PIN LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var PIN_HASH = null;  // loaded from server on init
var pinBuffer = '';
var pinUnlocked = false;

async function initPin(){
  try{
    var r = await fetch('/api/health');
    var d = await r.json();
    PIN_HASH = d.pinHash || null;
    // If server has no PIN set, skip login
    if(!PIN_HASH){
      unlockApp();
      return;
    }
  }catch(e){
    // Server not reachable (file:// mode) ‚Äî skip PIN, show banner
    unlockApp();
    return;
  }

  // Try biometric / passkey auto-auth first
  if(localStorage.getItem('pp_unlocked') === PIN_HASH){
    unlockApp();
    return;
  }

  // Show PIN pad
  document.getElementById('pinOverlay').style.display = 'flex';
}

function pinPress(key){
  if(key === 'bio'){
    // Biometric placeholder ‚Äî skip for now, act as clear
    pinBuffer = '';
    updatePinDots();
    return;
  }
  if(key === 'del'){
    pinBuffer = pinBuffer.slice(0, -1);
    updatePinDots();
    return;
  }
  if(pinBuffer.length >= 4) return;
  pinBuffer += key;
  updatePinDots();

  if(pinBuffer.length === 4){
    setTimeout(checkPin, 120);
  }
}

function updatePinDots(){
  for(var i=0; i<4; i++){
    var dot = document.getElementById('d'+i);
    if(dot) dot.className = 'pin-dot' + (i < pinBuffer.length ? ' filled' : '');
  }
}

function simpleHash(str){
  var h = 0;
  for(var i=0; i<str.length; i++){
    h = ((h << 5) - h) + str.charCodeAt(i);
    h |= 0;
  }
  return Math.abs(h).toString(16);
}

function checkPin(){
  var hash = simpleHash(pinBuffer);
  if(hash === PIN_HASH){
    localStorage.setItem('pp_unlocked', PIN_HASH);
    unlockApp();
  } else {
    // Wrong PIN ‚Äî shake and reset
    var box = document.getElementById('pinBox');
    box.style.animation = 'none';
    box.style.transform = 'translateX(12px)';
    setTimeout(function(){ box.style.transform = 'translateX(-10px)'; }, 80);
    setTimeout(function(){ box.style.transform = 'translateX(7px)'; }, 160);
    setTimeout(function(){ box.style.transform = ''; }, 240);
    document.getElementById('pinErr').textContent = 'Wrong PIN ‚Äî try again';
    setTimeout(function(){ document.getElementById('pinErr').textContent = ''; }, 2000);
    pinBuffer = '';
    updatePinDots();
  }
}

function unlockApp(){
  pinUnlocked = true;
  var overlay = document.getElementById('pinOverlay');
  if(overlay){
    overlay.style.opacity = '0';
    overlay.style.transition = 'opacity .4s';
    setTimeout(function(){ overlay.style.display = 'none'; }, 400);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI MODE ‚Äî server vs personal key
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var aiMode = 'server'; // 'server' or 'personal'

function setAiMode(mode){
  aiMode = mode;
  document.getElementById('modeServerBtn').className  = 'ai-mode-btn' + (mode==='server'  ? ' active' : '');
  document.getElementById('modePersonalBtn').className = 'ai-mode-btn' + (mode==='personal' ? ' active' : '');
  document.getElementById('personalKeyPanel').style.display  = mode==='personal' ? 'block' : 'none';
  document.getElementById('serverModeStatus').style.display  = mode==='server'   ? 'flex'  : 'none';

  var badge = document.getElementById('aiProviderBadge');
  if(mode === 'server'){
    badge.textContent = 'üîµ Server AI';
    badge.style.color = '#4a9eff';
    badge.style.borderColor = 'rgba(74,158,255,.4)';
    toast('üñ•Ô∏è Server AI mode ‚Äî your built-in key');
  } else {
    var k = document.getElementById('apiKeyInput')?.value.trim() || loadApiKey();
    updateProviderBadge(detectProvider(k));
    toast('üîë Personal key mode');
  }
}

function saveApiKey(val){ try{localStorage.setItem('pp_api_key',val.trim());}catch(e){} }
function loadApiKey(){ try{return localStorage.getItem('pp_api_key')||'';}catch(e){return '';} }
function toggleApiVis(){
  const f=document.getElementById('apiKeyInput');
  f.type=f.type==='password'?'text':'password';
}

// ‚îÄ‚îÄ Video Length Config ‚îÄ‚îÄ
let selectedLen = '5min';

var LEN_CONFIG = {
  '60s':  { label:'60-second Reel', words_per_section:'10-15', total_words:'~80 words total', depth:'Ultra-short. Every word earns its place. HOOK=1 sentence, PROBLEM=2 sentences, REALIZATION=2 sentences, SOLUTION=1 sentence, CLOSING=1 sentence.', tokens: 300 },
  '3min': { label:'3-minute video',  words_per_section:'40-50', total_words:'~250 words total', depth:'Short and punchy. Each section 2-3 flowing sentences. Tight and impactful.', tokens: 500 },
  '5min': { label:'5-minute video',  words_per_section:'90-110', total_words:'~550 words total', depth:'Standard depth. HOOK 2-3 sentences, PROBLEM 4-5 sentences, REALIZATION 4-5 sentences, SOLUTION 3-4 sentences, CLOSING 2 sentences.', tokens: 900 },
  '10min':{ label:'10-minute video', words_per_section:'180-220', total_words:'~1100 words total', depth:'Deep coaching. Each section is a full, rich argument. PROBLEM explores the root cause in detail. REALIZATION tells a real story and restates the truth 3-4 times. SOLUTION gives a multi-step practice.', tokens: 1800 },
  '30min':{ label:'30-minute Masterclass', words_per_section:'550-650', total_words:'~3200 words total', depth:'Full masterclass chapter. Each section is a deep teaching block. HOOK sets full context. PROBLEM does root-cause analysis with multiple examples. REALIZATION is the central teaching with stories, repetition, and psychological explanation. SOLUTION is a complete practice framework with steps. CLOSING is a full summation.', tokens: 5500 }
};

function setLen(btn){
  document.querySelectorAll('.len-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  selectedLen = btn.dataset.len;
  toast('üé¨ Length set: ' + LEN_CONFIG[selectedLen].label);
}

// ‚îÄ‚îÄ Target Group Config ‚îÄ‚îÄ
var selectedTgt = 'general';

var TGT_CONFIG = {
  general:           { label:'General Audience', persona:'a broad audience of everyday people ‚Äî men and women of all ages who are working hard but feeling stuck in life', pain:'feeling like they are trying their best but not getting anywhere', language:'simple, warm, universal ‚Äî no jargon, no industry terms', examples:'use everyday relatable situations: morning routines, family pressure, self-doubt, comparing with others', address:'you' },
  entrepreneurs:     { label:'Entrepreneurs & Business Owners', persona:'entrepreneurs, small business owners, and startup founders who are building something but facing self-doubt, cash pressure, slow growth, or fear of failure', pain:'putting everything in ‚Äî time, money, identity ‚Äî and still not seeing the breakthrough they expected', language:'business-aware ‚Äî reference revenue, clients, team, market, execution, decisions', examples:'use situations like: losing a client, pivoting the business, struggling to scale, self-funding under pressure, comparing with competitors', address:'you as a founder' },
  employees:         { label:'Working Professionals (9-5)', persona:'salaried employees and corporate professionals who feel trapped in their job, overlooked for promotion, or quietly dreaming of something more', pain:'giving their best at work and still feeling invisible, underpaid, or unfulfilled', language:'office-aware ‚Äî reference boss, salary, appraisal, meetings, deadlines, career ladder', examples:'use situations like: being passed over for promotion, Sunday dread, performance reviews, not feeling heard in meetings', address:'you as a professional' },
  students:          { label:'Students & Young Adults', persona:'college students and young adults aged 18-28 who are figuring out their identity, career direction, and self-worth under pressure from parents, peers, and society', pain:'feeling lost, comparing themselves constantly on social media, afraid of making the wrong choice', language:'young and direct ‚Äî reference exams, placements, parents expectations, peer pressure, social media comparison', examples:'use situations like: exam pressure, choosing a career, feeling behind compared to friends, parents disappointment', address:'you as a young person' },
  salespeople:       { label:'Sales Professionals & Network Marketers', persona:'direct sales professionals, MLM distributors, and network marketers who face daily rejection, income inconsistency, and the mental battle of building a business from scratch', pain:'hearing "no" every day, losing belief in themselves and their product, struggling with the gap between their vision and their current reality', language:'sales-aware ‚Äî reference prospects, rejection, follow-up, downline, targets, commissions, belief in product', examples:'use situations like: a prospect saying no, a slow month, team members quitting, being doubted by family', address:'you as a builder' },
  homemakers:        { label:'Homemakers & Family-Focused Individuals', persona:'homemakers ‚Äî primarily women ‚Äî who pour everything into their family but quietly struggle with their own identity, lost dreams, and the feeling that they have sacrificed their potential', pain:'feeling invisible, undervalued, and unsure if it is too late for them to pursue something of their own', language:'warm and deeply personal ‚Äî reference family, sacrifice, children, husband, home, identity, worth', examples:'use situations like: feeling unheard at home, putting everyone first and forgetting yourself, wondering what happened to your dreams', address:'you as a woman / as a person' },
  coaches:           { label:'Coaches, Trainers & Mentors', persona:'coaches, corporate trainers, life mentors, and speakers who want to help others but sometimes doubt their own authority, struggle with imposter syndrome, or find it hard to charge what they are worth', pain:'knowing they have the knowledge to help people but holding back ‚Äî afraid of judgment, not feeling credible enough, or undercharging', language:'coaching-aware ‚Äî reference clients, sessions, programs, transformation, results, authority, positioning', examples:'use situations like: doubt before a training, a client not getting results, pricing their services, posting content publicly', address:'you as a coach' },
  spiritual_seekers: { label:'Spiritual Seekers & Faith-Driven Individuals', persona:'people on a spiritual or faith journey who are looking for meaning, peace, and alignment between their inner world and their outer life', pain:'knowing spiritual truths intellectually but not feeling them deeply ‚Äî living in contradiction between what they believe and how they actually think and act', language:'spiritually resonant ‚Äî reference surrender, faith, divine timing, inner peace, ego, purpose, the soul', examples:'use situations like: praying but not feeling heard, the gap between knowing and being, testing faith under pressure', address:'you as a seeker' },
  leaders:           { label:'Leaders, Managers & CEOs', persona:'senior leaders, managers, team leads, and CEOs who carry the weight of decisions, teams, and results ‚Äî and privately battle self-doubt, loneliness at the top, or the pressure of being the person everyone looks to', pain:'being strong for everyone else while privately carrying uncertainty ‚Äî afraid to show vulnerability, struggling with the loneliness of leadership', language:'leadership-aware ‚Äî reference team, decisions, accountability, results, board, pressure, vision, culture', examples:'use situations like: making a hard call, a team member failing, losing confidence before a big presentation, the cost of leadership', address:'you as a leader' }
};

function setTgt(btn){
  document.querySelectorAll('.tgt-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  selectedTgt = btn.dataset.tgt;
  toast('üéØ Target: ' + TGT_CONFIG[selectedTgt].label);
}

// ‚îÄ‚îÄ Elaborate (fresh unique script every call) ‚îÄ‚îÄ
let elabCallCount = 0; // increments each call so AI produces fresh output

async function elaborateThought(){
  const inp=document.getElementById('scriptInput').value.trim();
  if(!inp){toast('‚úçÔ∏è Write a thought first!');return;}
  VS.seedThought=inp;
  elabCallCount++;

  // Block AI calls if running as local file ‚Äî will always fail on iOS
  if(window.location.protocol === 'file:'){
    document.getElementById('fileBanner').style.display = 'block';
    document.getElementById('fileBanner').scrollIntoView({behavior:'smooth'});
    // Still generate fallback so user gets something
    applyScript(buildFallback(inp, document.getElementById('toneSel').value||'motivational', selectedLen, selectedTgt));
    toast('üìù Smart Fallback generated ‚Äî host online for real AI', 4000);
    return;
  }

  // API key is stored securely on server ‚Äî not needed client-side

  const langMap={english:'English',hindi:'Hindi',gujarati:'Gujarati'};
  const toneMap={
    motivational:'motivational and high-energy ‚Äî bold statements, strong action verbs',
    spiritual:'spiritual and soulful ‚Äî metaphors of light, faith, and divine purpose',
    emotional:'personal story-driven ‚Äî first-person journey, vulnerability, breakthrough moment',
    powerful:'powerful and commanding ‚Äî short punchy sentences, strong leadership voice',
    workshop:'workshop promo style ‚Äî speaks directly to a training audience, highlights transformation'
  };
  const lang   = langMap[document.getElementById('langSel').value]||'English';
  const tone   = toneMap[document.getElementById('toneSel').value]||toneMap.motivational;
  const toneKey= document.getElementById('toneSel').value||'motivational';
  const lenCfg = LEN_CONFIG[selectedLen] || LEN_CONFIG['5min'];
  const tgtCfg = TGT_CONFIG[selectedTgt] || TGT_CONFIG['general'];

  // UI: loading state
  document.getElementById('eph').style.display='none';
  document.getElementById('etxt').classList.remove('on');
  document.getElementById('eacts').style.display='none';
  document.getElementById('espin').classList.add('on');

  // Unique variation hint so each regenerate is genuinely different
  const angles=[
    'Use a surprising statistic or unexpected comparison in the HOOK.',
    'Open the HOOK with a direct "You" statement ‚Äî speak straight to the viewer.',
    'Start the HOOK with a short story: one sentence that drops the viewer into a scene.',
    'Open with a provocative question that challenges a common belief.',
    'Use contrast in the HOOK ‚Äî "Everyone tells you X, but the truth is Y."',
    'Start with a bold declaration ‚Äî no question, just a powerful statement of truth.',
  ];
  const variationHint = angles[elabCallCount % angles.length];

  const sys=`You are Pradeep Parmar ‚Äî India's belief and mindset coach with 20+ years of coaching real people through real transformations. You are recording a short-form video speaking DIRECTLY and personally to your viewer, exactly in the style of the top motivational YouTube channels you have studied.

--------------------------------------------------
YOUR EXACT WRITING STYLE ‚Äî BASED ON REAL SCRIPTS
--------------------------------------------------

VOICE: Direct coaching voice. Urgent, personal, like a mentor who has figured something out and needs you to hear it right now. Confident but not arrogant. Honest, not motivational fluff.

SENTENCE RHYTHM: Mix flowing sentences with short punches.
Real example pattern: "Most people work hard every single day. They sacrifice. They show up. And still ‚Äî nothing changes. Because it was never about the effort. It was about the belief they carried while doing it."

THE CONTRAST FORMULA ‚Äî your most powerful tool, use in every section:
‚Ä¢ "Most people do [X]. But here is the truth ‚Äî [Y]."
‚Ä¢ "It is not about [X]. It is about [Y]."
‚Ä¢ "You do not need [X]. You need [Y]."
‚Ä¢ "This is not [X]. This is [Y]."

DIRECT ADDRESS ‚Äî always "you", always personal, never abstract:
Write as if speaking to ONE specific person. Use "you", "your", "let me ask you", "I want you to understand", "let me tell you something."
NEVER: "people often struggle with..." ‚Äî ALWAYS: "You have been struggling with..."

NATURAL OPENING PHRASES (rotate, do not repeat the same one):
‚Ä¢ "Let me ask you something."
‚Ä¢ "Most people think [X]. But here is what they miss."
‚Ä¢ "Think about this for a moment."
‚Ä¢ "Here is what nobody tells you."
‚Ä¢ "I want you to understand something important."
‚Ä¢ "Here is the truth that most people are not willing to hear."
‚Ä¢ "Let me tell you something that changed everything for the people I work with."

STORYTELLING ‚Äî drop one real observation or brief story:
"I once worked with someone who [real situation in one sentence]. They tried everything. And what I told them was this: [insight]. That single shift changed the direction of their life."

REPETITION FOR EMPHASIS ‚Äî restate the key truth 2‚Äì3 times in different words:
"That is it. That is the whole thing. That is what changes everything." This is deliberate ‚Äî it makes the message land.

WHAT THIS STYLE NEVER DOES:
‚Ä¢ Never uses: hustle, grind, mindset, journey, potential, transformation, empower, unlock, unleash, breakthrough, level up
‚Ä¢ Never uses weak endings: "You've got this!" ‚Äî too generic
‚Ä¢ Never makes vague spiritual claims without grounding them in real human behaviour
‚Ä¢ Never lists bullet points inside sections ‚Äî always flows as spoken word
‚Ä¢ Never sounds like a book ‚Äî sounds like a real person talking

--------------------------------------------------
PRADEEP'S CREDIBILITY ‚Äî WHAT MAKES PEOPLE TRUST HIM
--------------------------------------------------
He speaks from 20+ years of watching real people transform and stay stuck.
‚Ä¢ References real observations: "I have seen this happen...", "In my experience working with people..."
‚Ä¢ Admits difficulty honestly: "This is not easy to hear. But it is true."
‚Ä¢ Explains the WHY ‚Äî the psychological mechanism behind the problem, not just the symptom
‚Ä¢ No fake promises: "This will not change overnight. But the moment you understand this ‚Äî everything starts to shift."

--------------------------------------------------
5-SECTION SCRIPT STRUCTURE
--------------------------------------------------

üé£ HOOK (2‚Äì3 sentences):
Immediately identify the viewer's hidden pain, common mistake, or wrong belief.
Use the contrast formula OR a direct challenge that makes them think "that is me."
Variation technique for this script: ${variationHint}

üòî PROBLEM (4‚Äì5 sentences):
Describe the EXACT experience the viewer is living. Use "you" throughout.
Name what they keep doing and WHY it keeps failing ‚Äî the hidden mechanism.
Include ONE brief observation from Pradeep's real experience: "I have seen this with so many people I coach..."
Use the contrast formula to sharpen the diagnosis.

üí° REALIZATION (4‚Äì5 sentences ‚Äî this is the PEAK):
State the core truth inside the seed thought using the contrast formula.
Explain WHY this truth changes everything ‚Äî the mechanism, not just the message.
Restate the key insight 2‚Äì3 times in different words. Let it land.
Include a brief real example or story if it adds power.

üî• SOLUTION (3‚Äì4 sentences):
ONE specific inner shift or real daily action. Grounded and honest.
Be direct: "Here is what I want you to do. Not next week. Starting today."
Acknowledge it takes time but make the first step feel immediately possible.

‚ú® CLOSING (2 sentences):
One quiet, final, earned truth that seals the message.
Must end with: Change your belief, change your life.

FORMAT ‚Äî output ONLY this structure, nothing else, no explanation:
üé£ HOOK: [text]
üòî PROBLEM: [text]
üí° REALIZATION: [text]
üî• SOLUTION: [text]
‚ú® CLOSING: [text ending with: Change your belief, change your life.]

Language: ${lang}. Tone: ${tone}. Variation ${elabCallCount} ‚Äî different opening, different story, different angle than before.

--------------------------------------------------
TARGET AUDIENCE: ${tgtCfg.label}
--------------------------------------------------
You are speaking SPECIFICALLY to: ${tgtCfg.persona}

Their core pain in this topic: ${tgtCfg.pain}

LANGUAGE & TONE FOR THIS AUDIENCE:
Use ${tgtCfg.language}

EXAMPLES & SITUATIONS to reference:
${tgtCfg.examples}

How to address them: Speak to ${tgtCfg.address}

CRITICAL: Every sentence must feel written FOR this specific person. Their job, their world, their pressure. Not generic. If a businessperson reads this, they must think "Pradeep is speaking about MY situation." If a student reads this, they must think the same. The situations, the language, the examples ‚Äî all must match their daily reality.

--------------------------------------------------
VIDEO LENGTH: ${lenCfg.label} (${lenCfg.total_words})
--------------------------------------------------
${lenCfg.depth}
Target: ${lenCfg.words_per_section} words per section. Hit the word target ‚Äî not shorter, not longer. The viewer is watching a ${lenCfg.label}.`;

  const userMsg=`My seed thought: "${inp}"

I am Pradeep Parmar speaking directly to a ${tgtCfg.label}. This person is ${tgtCfg.persona}. They are working hard. They are trying. But something is not connecting. Write this in my voice ‚Äî like I am coaching them personally in a short video. Make every example, every reference, every situation feel like it was written specifically for ${tgtCfg.address}.

Use the contrast formula. Speak directly to "you." Include one real observation from my work with people. Make the REALIZATION the peak ‚Äî where the truth lands. Make the SOLUTION feel honest and immediately doable.

Technique for this variation: ${variationHint}. This is variation ${elabCallCount} ‚Äî use a completely different story, opening, and angle than before.

Output only the 5 sections. Start directly with üé£ HOOK:`;

  // ‚îÄ‚îÄ Route to server API or personal key based on mode ‚îÄ‚îÄ
  try{
    var txt = null;
    var usedProvider = 'server';

    if(aiMode === 'personal'){
      // ‚îÄ‚îÄ Personal key mode: call AI directly from browser ‚îÄ‚îÄ
      var personalKey = document.getElementById('apiKeyInput')?.value.trim() || loadApiKey();
      if(!personalKey) throw new Error('No personal key entered. Switch to Server AI or paste your key.');
      var provider = detectProvider(personalKey);
      updateProviderBadge(provider);
      txt = await callAI(provider, personalKey, sys, userMsg, lenCfg.tokens);
      usedProvider = provider;
    } else {
      // ‚îÄ‚îÄ Server mode: backend holds the key, no exposure ‚îÄ‚îÄ
      var resp = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sys, userMsg, maxTokens: lenCfg.tokens })
      });
      var data = await resp.json();
      if(!resp.ok || data.error) throw new Error(data.error || 'Server error '+resp.status);
      if(data.provider) updateProviderBadge(data.provider);
      txt = data.text;
      usedProvider = data.provider;
    }

    if(txt){
      applyScript(txt);
      var pNames = {gemini:'ü§ñ Gemini AI', anthropic:'üü† Claude AI', openai:'üü¢ GPT-4', server:'üñ•Ô∏è Server AI'};
      toast('‚úÖ Script ready ‚Äî '+(pNames[usedProvider]||'AI'));
    } else {
      throw new Error('Empty response');
    }
  }catch(e){
    console.warn('Elaborate error:', e.message);
    document.getElementById('espin').classList.remove('on');
    toast('‚ö†Ô∏è '+(e.message||'Error'), 5000);
    applyScript(buildFallback(inp, toneKey, selectedLen, selectedTgt));
    toast('üìù Smart Fallback used ‚Äî '+(aiMode==='server' ? 'check server is running' : 'check your API key'));
  }
}

// ‚îÄ‚îÄ Provider detection ‚îÄ‚îÄ
function detectProvider(key){
  if(!key) return 'none';
  if(key.startsWith('sk-ant-')) return 'anthropic';
  if(key.startsWith('AIza'))    return 'gemini';
  if(key.startsWith('sk-') || key.startsWith('sk-proj-')) return 'openai';
  // Gemini keys can also be long random strings from AI Studio
  if(key.length > 30 && !key.startsWith('sk-')) return 'gemini';
  return 'anthropic'; // default guess
}
function providerName(p){
  return {anthropic:'Claude',gemini:'Gemini',openai:'ChatGPT',none:'AI'}[p]||'AI';
}
function updateProviderBadge(provider){
  const badge = document.getElementById('aiProviderBadge');
  if(!badge) return;
  const labels = {
    anthropic:'üü† Claude (Anthropic)',
    gemini:   'ü§ñ Gemini AI',
    openai:   'üü¢ ChatGPT (OpenAI)',
    none:     '‚ö™ No key'
  };
  badge.textContent = labels[provider]||'AI';
}

// ‚îÄ‚îÄ Universal AI caller ‚îÄ‚îÄ
async function callAI(provider, apiKey, sys, userMsg, maxTok){
  maxTok = maxTok || 900;
  if(provider==='anthropic') return callAnthropic(apiKey, sys, userMsg);
  if(provider==='gemini')    return callGemini(apiKey, sys, userMsg, maxTok);
  if(provider==='openai')    return callOpenAI(apiKey, sys, userMsg, maxTok);
  throw new Error('Unknown provider');
}

// ‚îÄ‚îÄ Anthropic ‚îÄ‚îÄ
async function callAnthropic(apiKey, sys, userMsg){
  const r = await fetch('https://api.anthropic.com/v1/messages',{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'x-api-key': apiKey,
      'anthropic-version':'2023-06-01',
      'anthropic-dangerous-direct-browser-access':'true'
    },
    body:JSON.stringify({
      model:'claude-haiku-4-5-20251001',
      max_tokens:maxTok||900,
      temperature:1,
      system:sys,
      messages:[{role:'user',content:userMsg}]
    })
  });
  if(!r.ok){
    const err=await r.json().catch(()=>({}));
    const msg = err.error?.message||`HTTP ${r.status}`;
    if(r.status===401) throw new Error('Invalid Anthropic API key. Get one at console.anthropic.com');
    if(r.status===429) throw new Error('Rate limited. Wait a moment and try again.');
    throw new Error('Anthropic error: '+msg);
  }
  const d=await r.json();
  return (d.content||[]).map(b=>b.text||'').join('').trim();
}

// ‚îÄ‚îÄ Gemini ‚Äî iOS-safe via XMLHttpRequest (fetch blocked by iOS Safari CORS) ‚îÄ‚îÄ
// ‚îÄ‚îÄ Gemini ‚Äî iOS Safari safe via CORS proxy chain ‚îÄ‚îÄ
// iOS Safari blocks direct API calls from file:// (null origin).
// We chain through free CORS proxies until one succeeds.
// XHR helper - works on iOS Safari file:// where fetch() is blocked by WebKit
function xhrPost(url, bodyStr, extraHeaders){
  extraHeaders = extraHeaders || {};
  return new Promise(function(resolve, reject){
    var xhr = new XMLHttpRequest();
    xhr.open('POST', url, true);
    xhr.timeout = 30000;
    xhr.setRequestHeader('Content-Type','application/json');
    Object.keys(extraHeaders).forEach(function(k){ xhr.setRequestHeader(k, extraHeaders[k]); });
    xhr.onload = function(){
      try{ resolve({json: JSON.parse(xhr.responseText), status: xhr.status}); }
      catch(e){ reject(new Error('Parse error: '+xhr.responseText.slice(0,80))); }
    };
    xhr.onerror   = function(){ reject(new Error('XHR network error')); };
    xhr.ontimeout = function(){ reject(new Error('XHR timeout')); };
    xhr.send(bodyStr);
  });
}

async function callGemini(apiKey, sys, userMsg, maxTok){
  maxTok = maxTok || 900;
  var model   = 'gemini-1.5-flash';
  var apiUrl  = 'https://generativelanguage.googleapis.com/v1beta/models/'+model+':generateContent?key='+apiKey;
  var fullMsg = sys + '\n\n---\n\n' + userMsg;
  var bodyStr = JSON.stringify({
    contents:[{role:'user', parts:[{text: fullMsg}]}],
    generationConfig:{temperature:1.0, maxOutputTokens:maxTok||900}
  });

  // iOS Safari blocks fetch() from file:// pages - XHR has looser rules and often works
  var strategies = [
    // 1. XHR direct to Gemini API (primary iOS fix)
    async function(){
      var res = await xhrPost(apiUrl, bodyStr);
      return geminiParseResponse(res.json, res.status);
    },
    // 2. XHR via corsproxy.io
    async function(){
      var res = await xhrPost('https://corsproxy.io/?'+encodeURIComponent(apiUrl), bodyStr);
      return geminiParseResponse(res.json, res.status);
    },
    // 3. XHR via thingproxy
    async function(){
      var res = await xhrPost('https://thingproxy.freeboard.io/fetch/'+apiUrl, bodyStr);
      return geminiParseResponse(res.json, res.status);
    },
    // 4. fetch (works when page is hosted on https://)
    async function(){
      var r = await fetch(apiUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:bodyStr});
      return geminiParseResponse(await r.json(), r.status);
    }
  ];

  var lastErr = null;
  for(var i=0; i<strategies.length; i++){
    try{
      var txt = await strategies[i]();
      if(txt) return txt;
    }catch(e){
      console.warn('Gemini strategy '+(i+1)+' failed:', e.message);
      lastErr = e;
    }
  }
  throw lastErr || new Error('All Gemini strategies failed');
}

function geminiParseResponse(d, status){
  // Check for API-level errors
  if(d.error){
    const msg = d.error.message || 'API error';
    const code = d.error.code || status;
    if(code===400||msg.includes('API_KEY')||msg.includes('Invalid')) throw new Error('‚ùå Invalid Gemini key. Get a free one at aistudio.google.com');
    if(code===403) throw new Error('‚ùå Gemini key not enabled. Visit aistudio.google.com ‚Üí Get API Key');
    if(code===429) throw new Error('‚è≥ Gemini rate limit. Wait 30 seconds and try again.');
    throw new Error('Gemini: '+msg);
  }
  // Extract text
  const txt = d.candidates?.[0]?.content?.parts?.[0]?.text
           || d.candidates?.[0]?.output || '';
  if(!txt) throw new Error('Gemini returned empty text');
  return txt.trim();
}

// ‚îÄ‚îÄ OpenAI ‚îÄ‚îÄ
async function callOpenAI(apiKey, sys, userMsg, maxTok){
  maxTok = maxTok || 900;
  const r = await fetch('https://api.openai.com/v1/chat/completions',{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'Authorization':'Bearer '+apiKey
    },
    body:JSON.stringify({
      model:'gpt-4o-mini',
      max_tokens:maxTok||900,
      temperature:1,
      messages:[
        {role:'system',content:sys},
        {role:'user',content:userMsg}
      ]
    })
  });
  if(!r.ok){
    const err=await r.json().catch(()=>({}));
    const msg = err.error?.message||`HTTP ${r.status}`;
    if(r.status===401) throw new Error('Invalid OpenAI key. Get one at platform.openai.com');
    if(r.status===429) throw new Error('OpenAI rate limited. Wait a moment.');
    throw new Error('OpenAI error: '+msg);
  }
  const d = await r.json();
  return (d.choices?.[0]?.message?.content||'').trim();
}

function showApiKeyHint(){
  const f=document.getElementById('apiKeyInput');
  if(f){ f.style.borderColor='var(--accent)'; f.focus(); setTimeout(()=>f.style.borderColor='',3000); }
}

// ‚îÄ‚îÄ Dynamic fallback ‚Äî ALWAYS produces unique output from the thought ‚îÄ‚îÄ
// ‚îÄ‚îÄ Show file:// warning if accessed as local file ‚îÄ‚îÄ
(function(){
  if(window.location.protocol === 'file:'){
    var b = document.getElementById('fileBanner');
    if(b) b.style.display = 'block';
  }
  // Health check is now handled inside initPin()
})();

function buildFallback(inp, tone, lenKey, tgtKey){
  lenKey = lenKey || '5min';
  tgtKey = tgtKey || 'general';
  var lenCfg = LEN_CONFIG[lenKey] || LEN_CONFIG['5min'];
  var tgtCfg = TGT_CONFIG[tgtKey] || TGT_CONFIG['general'];
  const thought = inp.trim();

  // ‚îÄ‚îÄ REAL TRANSCRIPT STYLE: Pradeep Parmar voice ‚îÄ‚îÄ
  // Based on actual JR Motivation channel transcripts.
  // Style: Direct coaching, contrast formula, "you" address,
  // flowing sentences with short punches, real observations, repetition for emphasis.

  const hooks = {
    motivational:[
      `Most people believe that if they just work harder, things will finally change. But let me tell you something ‚Äî working harder on the wrong foundation does not build a better life. It just builds a bigger version of the same problem.`,
      `Let me ask you something honestly. You are working. You are trying. You are showing up every day. So why does it feel like nothing is actually moving? Here is what most people miss ‚Äî and it is the one thing that changes everything.`,
      `Here is a truth that most people are not willing to hear. The problem is not your circumstances. The problem is not the people around you. The problem is the belief you are running your life on, and you have had it so long that you stopped questioning it.`,
      `Think about this for a moment. You know what to do. You have known for a long time. So why are you still not doing it? It is not laziness. It is not lack of discipline. It is something much deeper ‚Äî and once you see it, you cannot unsee it.`,
      `I want you to understand something that I have seen change the direction of people's lives. It is not about doing more. It is not about trying harder. It is about one shift ‚Äî one change in what you believe is actually possible for you.`,
      `Most people spend their entire lives focused on the wrong thing. They focus on the result. They focus on the outcome. They focus on what other people will think. And in doing so, they completely miss the one thing that actually creates the result.`,
      `Let me tell you something that I have shared in every training I have ever run. The most consistent pattern I see in people who stay stuck is not that they lack skill. It is not that they lack opportunity. It is that they have never truly examined what they believe.`,
      `Here is what nobody tells you when you are trying to build something meaningful with your life. Results do not follow effort alone. Results follow the quality of belief you bring to that effort. And most people are bringing the wrong one.`,
    ],
    spiritual:[
      `Most people think that faith means waiting for things to get better on their own. But let me ask you something ‚Äî have you ever considered that the waiting itself might be the barrier? That what you are really waiting for is your own permission to believe?`,
      `Let me tell you something I have observed in people who carry genuine peace, the kind that does not depend on what is happening around them. It is not that they have fewer problems. It is that they have a different relationship with what they believe about those problems.`,
      `Here is a truth about faith that most people never examine. You can go through every practice, every ritual, every prayer ‚Äî and still carry a quiet doubt underneath it all that says "but is this really for me?" That doubt is the only thing standing in the way.`,
      `Think about this for a moment. Every great shift in a person's life that I have witnessed ‚Äî and I have witnessed many ‚Äî was preceded by a change in what that person believed was meant for them. Not what they deserved. What they believed was truly possible.`,
      `I want you to understand something that goes deeper than advice or strategy. Real transformation does not come from doing more. It comes from releasing a belief that has been quietly limiting you for years ‚Äî often without you even realizing it was there.`,
      `Most people pray for their situation to change. But the people I have seen experience real, lasting change ‚Äî they did not just pray for a different life. They changed what they believed was available to them. And that changed everything else.`,
    ],
    emotional:[
      `Let me ask you something that I do not think you have been asked honestly in a long time. When was the last time you truly believed ‚Äî not hoped, not wished, but genuinely believed ‚Äî that what you want for your life is actually possible for you? I want you to sit with that question.`,
      `I want to speak to the part of you that is tired. Not physically tired. The kind of tired that comes from trying over and over again while carrying a quiet voice inside that says "maybe this is just not meant for me." I have sat with many people who carry that voice. And I want to tell you something about it.`,
      `Here is something I have noticed in every person who has come to me feeling stuck and hopeless. On the surface they look like they have given up. But underneath ‚Äî underneath there is still something alive. Still something that has not accepted the story their doubt is telling them. That part of you is why you are watching this right now.`,
      `Most people who are struggling are not struggling because they lack strength. They are struggling because they are fighting against a belief about themselves that they accepted a long time ago ‚Äî and they have been carrying it ever since without realizing it is not true.`,
      `I remember working with someone who had tried everything. Different approaches, different strategies, different advice. Nothing was working. And when I finally asked them the real question ‚Äî not "what are you doing wrong" but "what do you believe about yourself when you are alone at night" ‚Äî the answer changed everything.`,
      `Think about this for a moment. The most painful experiences in life are not the ones where things go wrong externally. They are the ones where you are doing everything right on the outside while quietly believing on the inside that you do not deserve for it to work. That gap ‚Äî between your effort and your belief ‚Äî is where the exhaustion lives.`,
    ],
    powerful:[
      `Let me be direct with you because I think you need to hear this. The reason you are not where you want to be is not because you lack ability. It is not because the world is unfair ‚Äî though sometimes it is. It is because at the level where decisions actually get made, you do not fully believe you belong there yet.`,
      `Here is the truth about discipline that most people get completely wrong. They think discipline is about forcing yourself to do things you do not want to do. But real discipline ‚Äî the kind that actually produces results ‚Äî it is not about force. It is about identity. It is about who you believe you are.`,
      `Most people think that if they could just find the right strategy, the right method, the right system ‚Äî everything would finally work. And strategies matter. But I have seen people with perfect strategies stay completely stuck. And I have seen people with imperfect strategies achieve extraordinary things. The difference is never the strategy.`,
      `I want you to understand something about the highest-performing people I have ever worked with. They are not smarter than you. They are not more talented than you. They do not have fewer problems than you. What they have is a fundamentally different answer to one question: do I believe I can actually do this?`,
      `Think about this for a moment. Every day you make hundreds of small decisions. What to focus on. What to ignore. What to start and what to leave unfinished. And underneath every single one of those decisions is a belief. Not a plan. Not a strategy. A belief. Change the belief and every decision that follows changes with it.`,
      `Let me tell you something that I have seen separate the people who succeed from the people who stay stuck. It is not effort ‚Äî both groups work hard. It is not intelligence ‚Äî both groups are capable. It is that the people who succeed have learned to trust their own direction. They have stopped waiting for external permission to move.`,
    ],
    workshop:[
      `In every training room I have walked into over the past twenty years, I see the same pattern. Different people, different industries, different backgrounds ‚Äî but the same invisible barrier. It is never a skill gap. It is never a knowledge gap. Let me tell you what it actually is.`,
      `Let me ask you something that I ask every group I train on the very first day. What is the one belief about yourself that ‚Äî if you changed it tomorrow ‚Äî would change everything else? Most people have never been asked that question. And the answer is always the same kind of answer. It lives right at the edge of what they are willing to admit.`,
      `Here is what I have learned from watching thousands of people go through real transformation ‚Äî the kind that actually lasts. It does not start with a better plan. It does not start with better habits. It starts with one honest conversation ‚Äî usually the one you have been avoiding having with yourself.`,
      `Most organisations invest heavily in training skills. And skills matter. But the most expensive limitation I see in every business I work with is not a skill problem. It is a belief problem. It is what people think is possible for them ‚Äî and for their teams ‚Äî that determines how far they go.`,
      `Think about every person you have seen transform ‚Äî genuinely transform, not just for a week. What changed? Was it information? They already had information. Was it motivation? Motivation comes and goes. What changed was something at a deeper level. What changed was what they believed was actually available to them.`,
      `I want to tell you something that I have observed consistently across every workshop I have delivered. The moment that creates real change for someone is almost never the moment they learn something new. It is the moment they finally give themselves permission to believe something they always knew but never trusted.`,
    ]
  };

  const problems = {
    motivational:[
      `You have been told that success is about working harder. So you work harder. You sacrifice more. You push further. And you watch people around you achieve things with what seems like less effort, and you wonder what you are missing. Here is what I have seen over and over again in the people I coach: the effort is never the problem. The belief underneath the effort is. You are working hard with a quiet conviction somewhere inside you that says "this probably will not work for me." And that conviction ‚Äî that small, invisible, consistent doubt ‚Äî is cancelling out everything you are building above it.`,
      `Most people do not realise how much of their daily life is being run by a belief they adopted years ago ‚Äî often before they were old enough to question it. You decided something about your own capability, your own worth, your own right to succeed. And since then, every action you have taken has been shaped by that decision. Not consciously. But consistently. I see this every time I work with someone who is stuck. On the surface, the problem looks like effort or discipline or strategy. Underneath, it is always the same thing. It is what they believe about what is actually possible for them.`,
      `Think about the last time you really started something ‚Äî a goal, a project, something that mattered to you. What happened in the first week, when the initial excitement faded? Most people experience a very specific moment. It is not tiredness. It is not distraction. It is a quiet voice that says: "Who do you think you are?" That voice is not wisdom. It is not experience. It is a belief you have been carrying. And the reason you have never examined it is because it feels like the truth.`,
    ],
    spiritual:[
      `Most people who describe themselves as having faith carry, at the same time, a quiet doubt about whether they personally deserve what they are asking for. The practice is real. The intention is sincere. But underneath both of those things, there is a belief that has never been directly addressed. A belief that says: God works for other people. Things work out for other people. But for me? I have to work harder for it. I have to earn it. I have to prove it. And that belief ‚Äî that quiet, persistent, deeply personal belief ‚Äî is the one thing that keeps the very thing you are asking for at a distance.`,
      `I have worked with people who do everything right on the surface. Every ritual, every practice, every commitment. And they still feel disconnected. Still feel like something is not quite working. And when I sit with them and ask the real question ‚Äî not "what are you doing" but "what do you actually believe about what is available to you" ‚Äî the answer is always the same kind of answer. There is a gap. Between what they say they believe and what they actually feel in quiet moments when no one is watching. That gap is not a failure of faith. It is a belief that has not yet been updated.`,
      `Think about this for a moment. What you receive in life is not determined by how hard you work for it or how consistently you ask for it. It is shaped by what you believe, at your deepest level, you are worthy of receiving. Most people have never examined that belief directly. They have worked around it. They have prayed over it. But they have never looked directly at it and asked: "Where did this come from? And is it actually true?" That examination is where everything shifts.`,
    ],
    emotional:[
      `Let me describe something that I think you will recognise. You are trying. Genuinely trying. You show up every day and you do the work. You keep going even when it is hard. And yet there is a persistent feeling underneath all of it ‚Äî a feeling of not quite being enough. Of doing everything right and still wondering when the other shoe is going to drop. That feeling is not a personality trait. It is not weakness. It is a belief that you absorbed somewhere along the way ‚Äî about your own worth, your own right to succeed, your own place in this world. And it has been running quietly in the background of every effort you have made.`,
      `I have sat with people who have achieved things that should, by every external measure, make them feel proud and secure. And I have watched them sit in my sessions and explain in careful, quiet voices why they are afraid that all of it is about to fall apart. Why they feel like a fraud. Why they cannot fully enjoy what they have built because some part of them does not believe they earned the right to have it. This is not rare. It is one of the most common human experiences I encounter. And it has one source. A belief about personal worth that was formed long before any of those achievements existed.`,
      `Most people who are struggling emotionally are not struggling because their life is objectively harder than everyone else's. They are struggling because they are carrying a story ‚Äî a narrative about who they are and what they deserve ‚Äî that is fundamentally out of alignment with the truth. And because that story is so old, so familiar, it feels like the truth. It feels like just "how things are." But I want you to understand something I have seen change lives. A story that you adopted is not the same as a story that is true. And you can change the one you are carrying.`,
    ],
    powerful:[
      `Here is what I observe in almost every high-performing person who comes to me still feeling stuck. They have built incredible capability on the outside. Skills, systems, habits ‚Äî all solid. But at the level where the real decisions get made ‚Äî the level of belief about who they are and what they deserve ‚Äî there is a gap. A gap between how they present to the world and what they actually feel when they are alone with their own thoughts. And that gap costs them. Not in effort. In direction. They are powerful engines driving in a direction that a quiet part of them does not fully believe they belong in.`,
      `Most people treat self-discipline like a force they apply to themselves from the outside. They push. They force. They white-knuckle their way through the day. And it works ‚Äî for a while. Until it doesn't. Until the pressure of life exceeds the force of will. And then they collapse and wonder why they keep failing. Here is what I have seen in the people who maintain real, consistent discipline. They are not pushing harder from the outside. They have changed something on the inside. They have built an identity ‚Äî a belief about who they are ‚Äî that makes the disciplined action feel like the natural thing. Not the forced thing.`,
      `Think about the people you most admire in terms of what they have built with their lives. I promise you this ‚Äî it is not their intelligence that separates them. It is not even their talent. It is that at some point, they made a fundamental decision about who they were. They stopped operating from a place of "I hope this works" and started operating from a place of "this is who I am and this is what I do." That shift ‚Äî from hoping to being ‚Äî is the whole thing. It is not complicated. But it is everything.`,
    ],
    workshop:[
      `I have delivered training across hundreds of organisations and thousands of individuals. And the same pattern appears every time. The people who transform ‚Äî who really change, who take what they learn and actually apply it in ways that compound into results ‚Äî they are not the ones with the best starting conditions. They are not the most talented or the most prepared. They are the ones who walk in carrying a belief that they are genuinely capable of change. And the ones who leave unchanged? Almost universally, they walked in already certain that the change was unlikely to happen for them specifically. The workshop was the same. The belief was different. And that was everything.`,
      `Here is what I tell every group I work with at the start of a training. The information I am about to give you is not the most important thing in this room. The most important thing in this room is what each of you decides to believe about your own ability to use it. Because I have given the same information to two different people and watched completely different outcomes result ‚Äî not because the information was different, but because what those two people believed about themselves when they received it was different. Belief is not a soft skill. It is the infrastructure that every other skill either builds on or collapses on.`,
      `Most performance problems that I am brought in to solve are described as skills problems or strategy problems or systems problems. And sometimes they are. But after twenty years of looking carefully at what actually shifts and what does not, I can tell you that the deepest and most consistent performance limiter I encounter is a belief problem. It is what people believe about their own capability, their own right to succeed, their own worthiness of the result they are working toward. Fix the skill without addressing the belief and you will get temporary improvement. Address the belief and the skill builds itself.`,
    ]
  };

  const realizations = [
    `Here is the truth inside this thought: "${thought}." Most people hear this and agree with it intellectually. They nod. They say "yes, of course." And then they go home and live in complete contradiction to it. Why? Because intellectually agreeing with a truth is not the same as actually believing it at the level where your decisions get made. The gap between knowing this and living it ‚Äî that is the entire work. That gap is not a gap in information. It is a gap in belief. And the moment you close that gap ‚Äî the moment this truth stops being something you know and becomes something you actually feel ‚Äî everything starts to shift. Not because your circumstances changed. Because you did.`,
    `"${thought}." I want you to read that again. Not quickly. Read it the way you would read something that was written specifically for you, about the specific situation you are in right now. Because here is what I have found: the people who transform their lives are not the ones who find a new strategy. They are the ones who find a truth ‚Äî a real, deeply personal truth like this one ‚Äî and they let it land. They let it actually change the answer to the question they ask themselves every morning. The question is never "what should I do?" The question is always "what do I believe is possible for me?" Answer that differently and everything else follows.`,
    `Let me tell you why this matters ‚Äî really matters, not just in theory. The thought "${thought}" is not motivation. It is not a phrase to put on your phone screen. It is a description of how the most consistent, most grounded, most genuinely successful people I have ever worked with actually operate. It is not something they try to do. It is something they believe. And that is the difference between someone who occasionally achieves things and someone who consistently builds something. One is applying effort. The other is operating from a belief. You cannot effort your way to the same result that belief produces. You can only believe your way there.`,
    `Here is the psychological mechanism behind this truth ‚Äî and I think understanding it will make it much harder to dismiss. "${thought}." What this describes is not just a mindset. It is a filter. What you believe about yourself and about what is possible filters everything you perceive. It determines which opportunities you see and which ones you walk straight past. It determines how you interpret setbacks ‚Äî whether they are feedback or proof of your worst fear about yourself. Fix the filter and the same world looks completely different. Not because the world changed. Because the mechanism through which you experience it changed. I have watched this happen in real people. It is not gradual. It is a shift.`,
    `Most people who hear "${thought}" will agree with it immediately and then do nothing differently. I know this because I have said versions of this truth to thousands of people. And the pattern is consistent. Intellectual agreement is easy. It does not require anything. But actual belief ‚Äî the kind that changes how you behave when you are tired, when you are afraid, when the evidence seems to be pointing the other way ‚Äî that kind of belief requires something. It requires you to make a decision about what story you are going to run your life on. Not the story that seems most realistic right now. The story that is actually true at a deeper level. This is that story.`,
    `"${thought}." I want to tell you what I have seen happen when someone truly internalises this truth ‚Äî not just agrees with it, but builds their daily life on it. The results do not come all at once. They never do. But something quieter and more important happens first. The quality of the decisions changes. Not because they have more information. Because they have a different belief operating underneath the decisions. And different decisions, repeated over time, become a different life. That is not complicated. But it is the whole thing. And this thought ‚Äî right here ‚Äî is the beginning of that shift for you, if you are willing to let it be.`,
  ];

  const solutions = {
    motivational:[
      `Here is what I want you to do ‚Äî and I want you to do it today, not next week. I want you to write down the one belief about yourself that is most directly contradicting the result you are working toward. Not the goal. The belief underneath the goal. The one that says "but probably not for me." Write it down. Look at it. And then ask yourself one honest question: where did this come from? Did you choose this belief? Or did you absorb it somewhere along the way without realising it? Because a belief you absorbed by accident is not the same as a truth you examined and chose. And you can change the ones you did not choose.`,
      `Starting tomorrow morning ‚Äî before you check your phone, before you begin your day ‚Äî I want you to spend three minutes with one clear, deliberate statement about who you are choosing to be. Not who you hope to be. Not who you are working toward becoming. Who you are choosing to be. Say it out loud. Say it until it feels less like something you are claiming and more like something you are remembering. This is not a trick. This is how belief gets rebuilt. Through small, consistent, deliberate repetitions of a different story ‚Äî until that story starts to feel more true than the old one.`,
      `The practice I recommend is deceptively simple and almost no one actually does it consistently. For the next seven days, every time you catch yourself thinking or speaking about yourself in a limiting way ‚Äî in your head or out loud ‚Äî just stop. Notice it. Do not fight it. Do not immediately try to replace it. Just witness it. Say to yourself: "That is the old belief. That is the story I am changing." Awareness is always the first door. You cannot change what you cannot see. But once you can see it clearly and consistently ‚Äî and name it for what it is ‚Äî changing it becomes not just possible but inevitable.`,
    ],
    spiritual:[
      `The practice I want to give you is simple and it takes five minutes. Every morning, before the noise of the day begins, sit quietly ‚Äî no phone, no agenda ‚Äî and ask yourself one question. Not "what do I need today?" but "what do I believe is available to me?" Sit with the honest answer. If the honest answer is smaller than what you say you believe, that is useful information. That is where the work is. Not in the prayer or the practice ‚Äî in the belief underneath them. Update that belief, even slightly, even for five minutes in the morning, and watch what begins to shift over time.`,
      `What I ask people to do at this stage is to take the core truth in this thought and write it somewhere they will encounter it every single day. Not as a reminder. As a question. "Do I actually believe this today?" Because the goal is not to repeat a phrase until it becomes meaningless. The goal is to keep returning to the honest gap ‚Äî the gap between what you say and what you feel ‚Äî and work on closing it. One honest moment at a time. That is not a spiritual practice with a formula. It is a personal conversation that you commit to having with yourself every day.`,
      `Here is what I have seen work when nothing else does. Stop asking for the thing you want and start asking for the belief that would make it possible. Do not pray for the outcome. Pray for the conviction. Do not ask to receive it. Ask to believe you deserve to receive it. That distinction sounds small. But it changes everything about how you show up. Because when the belief is there ‚Äî genuinely there ‚Äî the action that produces the result follows naturally. The belief is not the reward at the end. The belief is the beginning of everything.`,
    ],
    emotional:[
      `Here is what I want you to do this week. I want you to write ‚Äî honestly, privately, for no one but yourself ‚Äî the story you have been telling about what you deserve and what is possible for you. Not your goals. Not your plans. The story underneath them. The one that has been running quietly in the background for years. Write it out. All of it. And then, when you have it in front of you, I want you to ask yourself one question: is this actually true? Not does it feel true. Not has it been true in the past. Is it true right now? You will be surprised how often the honest answer is no ‚Äî and how much shifts in that moment of honesty.`,
      `The one thing I ask people at this point in our work together is to find one person ‚Äî just one person ‚Äî with whom they can be genuinely unfinished. Not in crisis. Not performing. Just honest. The isolation that comes from always presenting "I'm fine" to the world has a real cost. It keeps the wrong story in place because there is no outside voice to reflect back the truth. You do not need many people. You need one. One person who can witness you without judgment and remind you, in moments when you have forgotten, who you actually are.`,
      `Give yourself a specific permission today. Write it down. "I give myself permission to still be in the middle of this." "I give myself permission to be working on this without having it resolved yet." Real growth in the middle of the process does not look like clarity and confidence. It looks exactly like what you are experiencing right now. The difference between the people who make it through and the ones who do not is not that the ones who make it feel more certain. It is that they learn to keep moving while uncertain. That skill starts with permission. Give yourself that permission today.`,
    ],
    powerful:[
      `Here is the practice ‚Äî and it is identity first, always. Before your next significant challenge, decision, or action, I want you to pause for thirty seconds and ask: who am I being right now? Not what should I do. Who am I being? Because the action that follows from a clear, grounded answer to that question is fundamentally different from the action that follows from uncertainty and doubt. You are not looking for the right strategy. You are looking for the right identity to operate from. Thirty seconds. That is all it takes to reset. And over time, those thirty seconds become automatic.`,
      `I want you to do something this week that feels small but is not small. I want you to identify the one sentence that you say to yourself most often when things get difficult. The one that has become your automatic response to challenge. And I want you to replace it ‚Äî not with something you do not believe yet, but with the honest opposite. Not "I always mess this up." But "I learn from this." Not "I am not ready." But "I am preparing." This is not affirmation for the sake of feeling better. This is deliberate reprogramming of the story your brain defaults to under pressure. Do it every time. It compounds.`,
      `The challenge I am giving you is this. Do the thing you have been avoiding ‚Äî not after you feel ready, but instead of waiting to feel ready. Because here is what I know from twenty years of working with people: confidence does not arrive before the action. It arrives inside the action. It arrives when you discover, in the middle of doing the thing you were afraid to do, that you are actually capable of doing it. Every time you wait to feel ready before moving, you rob yourself of the experience that builds the belief. The belief is on the other side of the action. Go there.`,
    ],
    workshop:[
      `Here is the exercise I want you to do before your next training session, meeting, or high-stakes conversation. Write down the belief you are bringing into the room about your own capability in this specific context. Not what you know. What you believe. And then write the belief that would produce the best possible version of your performance. If those two beliefs are different ‚Äî and for most people, they will be ‚Äî then the preparation you need is not more content or more rehearsal. It is a deliberate shift in the second belief before you walk in. That shift takes two minutes. Its effect on what follows is not small.`,
      `The question I leave every workshop with is this: not "what did you learn?" ‚Äî but "what did you give yourself permission to believe today that you were not believing before you walked in?" Because permission is the thing. Knowledge without permission stays theoretical. Belief with permission becomes action. Identify one thing today ‚Äî one specific, personal belief ‚Äî that you are choosing to operate from starting now. Not trying. Choosing. There is a different quality of commitment in that word. Choosing means it is decided. It is done. Now you just live from it.`,
      `Apply this today in one specific, real context. Pick the area of your work or your life where the gap between your capability and your results is widest. Where you know what to do but something is consistently not connecting. And ask yourself the question I ask in every room I work in: what do I believe about my own right to succeed in this specific area? Whatever that answer reveals ‚Äî that is the work. Not the strategy. Not the system. The belief that either supports the strategy or quietly undermines it every time. Address that belief directly. Everything else will follow.`,
    ]
  };

  const closings = [
    `Most people will hear this truth and move on. Do not be most people. Let it land. Let it change the story you are running on. Change your belief, change your life.`,
    `The life you want is not waiting for better circumstances. It is waiting for a different belief. And that belief is a decision you can make right now. Change your belief, change your life.`,
    `You have been working hard for a long time. Now work on the one thing underneath everything else. The belief that determines what all that hard work is actually capable of producing. Change your belief, change your life.`,
    `I have watched this truth transform people who had genuinely stopped believing transformation was possible for them. It can do the same for you ‚Äî but only if you decide to actually believe it, not just agree with it. Change your belief, change your life.`,
    `The version of you that achieves what you are working toward is not more talented or more disciplined or more fortunate than the version of you that exists right now. They simply believe something different. That is available to you today. Change your belief, change your life.`,
    `You already have more than enough to build what you are after. What you may be missing is the belief that you are allowed to use it. Give yourself that permission. Change your belief, change your life.`,
    `In my experience, the gap between where someone is and where they are meant to be is never as wide as the belief they carry makes it feel. The moment the belief shifts, the gap closes faster than anyone expects. Change your belief, change your life.`,
  ];

  var tKey = tone||'motivational';
  var hookPool = hooks[tKey]   || hooks.motivational;
  var probPool = problems[tKey]|| problems.motivational;
  var solPool  = solutions[tKey]||solutions.motivational;

  var hook = hookPool[Math.floor(Math.random()*hookPool.length)];
  var prob = probPool[Math.floor(Math.random()*probPool.length)];
  var real = realizations[Math.floor(Math.random()*realizations.length)];
  var sol  = solPool[Math.floor(Math.random()*solPool.length)];
  var clos = closings[Math.floor(Math.random()*closings.length)];

  // ‚îÄ‚îÄ Apply Target Group customisation ‚îÄ‚îÄ
  var tgtLabel = tgtCfg.label;
  var tgtPain  = tgtCfg.pain;
  var tgtAddr  = tgtCfg.address;
  // Inject target context into problem section (personalises the generic pool text)
  if(tgtKey !== 'general'){
    prob = prob + ' I see this most clearly with ' + tgtLabel.toLowerCase() + ' ‚Äî people who ' + tgtPain + '. The external situation looks like the problem. But underneath it, the real issue is always the same.';
    sol  = sol  + ' This is especially true for you as ' + tgtAddr + '. The next action you take in your specific world ‚Äî whether it is a conversation, a decision, or a moment of courage ‚Äî take it from a different belief. See what happens.';
  }

  // ‚îÄ‚îÄ Apply Length scaling ‚îÄ‚îÄ
  // For short formats, trim to first sentence(s). For long formats, double-up sections.
  function trimToSentences(text, n){
    var parts = text.match(/[^.!?]+[.!?]+/g) || [text];
    return parts.slice(0, n).join(' ').trim();
  }
  function expandSection(text, extra){
    return text + ' ' + extra;
  }

  if(lenKey === '60s'){
    // Reel: one sentence per section max
    hook = trimToSentences(hook, 2);
    prob = trimToSentences(prob, 1);
    real = trimToSentences(real, 2);
    sol  = trimToSentences(sol, 1);
    clos = 'Change your belief, change your life.';
  } else if(lenKey === '3min'){
    hook = trimToSentences(hook, 3);
    prob = trimToSentences(prob, 3);
    real = trimToSentences(real, 3);
    sol  = trimToSentences(sol, 2);
  } else if(lenKey === '10min'){
    // Deep: combine two pool items per section
    var hook2 = hookPool[Math.floor(Math.random()*hookPool.length)];
    var prob2 = probPool[Math.floor(Math.random()*probPool.length)];
    var real2 = realizations[Math.floor(Math.random()*realizations.length)];
    var sol2  = solPool[Math.floor(Math.random()*solPool.length)];
    hook = hook + ' ' + trimToSentences(hook2, 2);
    prob = prob + '\n\n' + prob2;
    real = real + '\n\n' + trimToSentences(real2, 3);
    sol  = sol  + ' ' + trimToSentences(sol2, 2);
  } else if(lenKey === '30min'){
    // Masterclass: three pool items per section + full elaboration
    var hookA = hookPool[Math.floor(Math.random()*hookPool.length)];
    var hookB = hookPool[Math.floor(Math.random()*hookPool.length)];
    var probA = probPool[Math.floor(Math.random()*probPool.length)];
    var probB = probPool[Math.floor(Math.random()*probPool.length)];
    var realA = realizations[Math.floor(Math.random()*realizations.length)];
    var realB = realizations[Math.floor(Math.random()*realizations.length)];
    var solA  = solPool[Math.floor(Math.random()*solPool.length)];
    hook = hook + '\n\n' + hookA + '\n\n' + trimToSentences(hookB, 3);
    prob = prob + '\n\n' + probA + '\n\n' + probB;
    real = real + '\n\n' + realA + '\n\n' + realB;
    sol  = sol  + '\n\n' + solA;
    var clos2 = closings[Math.floor(Math.random()*closings.length)];
    clos = clos + '\n\n' + clos2;
  }
  // 5min = default, no changes needed

  return 'üé£ HOOK: '+hook+'\nüòî PROBLEM: '+prob+'\nüí° REALIZATION: '+real+'\nüî• SOLUTION: '+sol+'\n‚ú® CLOSING: '+clos;
}


// Called after AI returns script OR fallback is used
function applyScript(raw){
  parseIntoVS(raw);   // fills VS.hook / problem / realization / solution / closing

  // Show formatted HTML in elaboration box
  document.getElementById('espin').classList.remove('on');
  document.getElementById('etxt').innerHTML=renderElabHTML(raw);
  document.getElementById('etxt').classList.add('on');
  document.getElementById('eacts').style.display='flex';

  // Update parsed section cards
  refreshParsedCards();

  // Update small preview panel
  document.getElementById('pTxt').textContent=(VS.hook||VS.seedThought).substring(0,90);
  trigAnim();

  // Update TTS text field with full script
  const full=[VS.hook,VS.problem,VS.realization,VS.solution,VS.closing].filter(Boolean).join(' ‚Ä¶ ');
  document.getElementById('ttsTxt').textContent=full.substring(0,500);

  toast('ü§ñ Script ready! Click "‚ñ∂ Full Preview" to watch it.');
}

function renderElabHTML(raw){
  const cols={HOOK:'var(--accent)',PROBLEM:'var(--blue)',REALIZATION:'var(--gold)',SOLUTION:'var(--success)',CLOSING:'var(--purple)'};
  const emos={HOOK:'üé£',PROBLEM:'üòî',REALIZATION:'üí°',SOLUTION:'üî•',CLOSING:'‚ú®'};
  let html='';
  const lines=raw.replace(/\r/g,'').split('\n');
  let inSection=false;
  for(const line of lines){
    // Strip leading emoji/symbols before matching keyword (same as parseIntoVS)
    const stripped=line.replace(/^[\s\u00A0\u200B-\u200D\uFEFF]*/,'')
                       .replace(/^[^\w\s\u0900-\u097F\u0A80-\u0AFF"'(]+/,'').trim();
    const m=stripped.match(/^(HOOK|PROBLEM|REALIZATION|SOLUTION|CLOSING)\s*[:\-]?\s*([\s\S]*)/i);
    if(m){
      if(inSection)html+='</span></div>';
      const key=m[1].toUpperCase();
      const rest=(m[2]||'').trim();
      html+=`<div style="margin-bottom:14px"><span style="font-size:9px;font-weight:700;letter-spacing:2px;color:${cols[key]};text-transform:uppercase">${emos[key]||''} ${key}</span><br><span style="font-size:14px;line-height:1.8">${rest}`;
      inSection=true;
    } else if(line.trim()&&inSection){
      html+=` ${line.trim()}`;
    }
  }
  if(inSection)html+='</span></div>';
  return html||`<span style="font-size:14px;line-height:1.8">${raw}</span>`;
}

function refreshParsedCards(){
  document.getElementById('ph').innerHTML=hilite(VS.hook||VS.seedThought);
  document.getElementById('pp').innerHTML=hilite(VS.problem);
  document.getElementById('pr').innerHTML=hilite(VS.realization);
  document.getElementById('ps').innerHTML=hilite(VS.solution);
  document.getElementById('pc').innerHTML=hilite(VS.closing);
  document.getElementById('parsed').classList.add('on');
}

function hilite(t){
  if(!t)return'<span style="color:var(--muted);font-style:italic">‚Äî</span>';
  const kws=['belief','fail','weak','change','life','struggle','power','success','mind','fear','strong','hope','truth','doubt'];
  let r=t;
  kws.forEach(k=>{r=r.replace(new RegExp('\\b'+k+'\\b','gi'),`<span class="ktag">${k}</span>`);});
  return r;
}

function fmtKw(t){return hilite(t);}

function useElaborated(){
  if(!elabRaw){toast('‚úçÔ∏è Elaborate a thought first!');return;}
  refreshParsedCards();
  document.getElementById('pTxt').textContent=(VS.hook||VS.seedThought).substring(0,90);
  trigAnim();
  toast('‚úÖ Script locked in ‚Äî ready for Full Preview!');
}

function copyElab(){
  if(!elabRaw)return;
  navigator.clipboard.writeText(elabRaw).then(()=>toast('üìã Copied!'));
}

function parseScript(){
  VS.seedThought=document.getElementById('scriptInput').value.trim();
  if(elabRaw){
    parseIntoVS(elabRaw);
  } else if(VS.seedThought){
    VS.hook=VS.seedThought;
    VS.problem=VS.realization=VS.solution='';
    VS.closing='Change your belief, change your life. üî•';
  } else {
    toast('‚úçÔ∏è Write a thought first, then AI Elaborate!');return;
  }
  refreshParsedCards();
  document.getElementById('pTxt').textContent=(VS.hook||VS.seedThought).substring(0,90);
  trigAnim();
  toast('‚ö° Script structured!');
}

// -------------------------------------------------- VOICE TABS --------------------------------------------------
function selVTab(tab){
  ['rec','up','ai'].forEach(t=>{
    document.getElementById('vt-'+t).classList.toggle('active',t===tab);
    document.getElementById('vp-'+t).classList.toggle('on',t===tab);
  });
}

// -------------------------------------------------- RECORDING --------------------------------------------------
function toggleRec(){isRec?stopRec():startRec();}
function startRec(){
  isRec=true;
  document.getElementById('recBtn').classList.add('rng');
  document.getElementById('recBtn').textContent='‚èπ';
  document.getElementById('recSt').textContent='Recording‚Ä¶';
  document.getElementById('recTm').style.display='block';
  recSec=0;
  recInt=setInterval(()=>{recSec++;const m=Math.floor(recSec/60),s=recSec%60;document.getElementById('recTm').textContent=`${m}:${s.toString().padStart(2,'0')}`;},1000);
  wInt=setInterval(()=>{for(let i=1;i<=12;i++){const b=document.getElementById('w'+i),h=Math.random()*32+6;b.style.height=h+'px';b.style.background=h>20?'var(--accent)':'var(--muted)';}},100);
}
function stopRec(){
  isRec=false;clearInterval(recInt);clearInterval(wInt);
  document.getElementById('recBtn').classList.remove('rng');
  document.getElementById('recBtn').textContent='üéôÔ∏è';
  document.getElementById('recSt').textContent=`‚úÖ Recorded ‚Äî ${recSec}s`;
  const ib=document.getElementById('recInfo');
  ib.textContent=`‚úÖ Voice recorded ‚Äî ${recSec} seconds. Ready for export.`;
  ib.classList.add('on');
  for(let i=1;i<=12;i++){document.getElementById('w'+i).style.height='6px';document.getElementById('w'+i).style.background='var(--accent)';}
  toast('‚úÖ Voice recorded!');
}
function handleAudio(e){
  const f=e.target.files[0];
  if(f){const ib=document.getElementById('upInfo');ib.textContent=`‚úÖ ${f.name} (${(f.size/1024).toFixed(0)}KB)`;ib.classList.add('on');toast('üéµ Audio uploaded!');}
}

// -------------------------------------------------- TTS / AI VOICE --------------------------------------------------
function loadVoices(){allVoices=window.speechSynthesis.getVoices();filterVoices(curGender);}
function filterVoices(g){
  const sel=document.getElementById('vSel');sel.innerHTML='';
  const maleKw=['male','man','david','alex','daniel','james','fred','tom','george','mark','guy'];
  const femKw=['female','woman','samantha','victoria','karen','moira','fiona','tessa','veena','zira','alice'];
  let filtered=allVoices.filter(v=>(g==='male'?maleKw:femKw).some(k=>v.name.toLowerCase().includes(k)));
  if(!filtered.length)filtered=allVoices.filter((_,i)=>g==='male'?i%2===0:i%2===1);
  if(!filtered.length)filtered=allVoices;
  filtered.forEach(v=>{const o=document.createElement('option');o.value=v.name;o.textContent=`${v.name} (${v.lang})`;sel.appendChild(o);});
  if(!sel.options.length)sel.innerHTML='<option>Default voice</option>';
}
function selGender(g){
  curGender=g;
  document.getElementById('gM').classList.toggle('active',g==='male');
  document.getElementById('gF').classList.toggle('active',g==='female');
  const pitch=document.getElementById('tPitch');
  if(g==='male'){pitch.value=0.8;document.getElementById('pv').textContent='0.8';}
  else{pitch.value=1.3;document.getElementById('pv').textContent='1.3';}
  filterVoices(g);
  toast(g==='male'?'üë® Male voice selected':'üë© Female voice selected');
}
function buildUtterance(text){
  const utt=new SpeechSynthesisUtterance(text);
  const sn=document.getElementById('vSel').value;
  const v=allVoices.find(x=>x.name===sn);
  if(v)utt.voice=v;
  utt.rate=parseFloat(document.getElementById('tRate').value)||0.85;
  utt.pitch=parseFloat(document.getElementById('tPitch').value)||1;
  utt.volume=parseFloat(document.getElementById('tVol').value)||1;
  return utt;
}
function speakTxt(){
  if(!('speechSynthesis' in window)){toast('‚ùå Browser not supported');return;}
  window.speechSynthesis.cancel();
  let txt=document.getElementById('ttsTxt').textContent.trim();
  if(!txt||txt.length<5){txt=VS.hook||VS.seedThought;}
  if(!txt){toast('‚úçÔ∏è Add a script first!');return;}
  const utt=buildUtterance(txt);
  utt.onstart=()=>{document.getElementById('swInd').classList.add('on');document.getElementById('ttsBtn').textContent='‚è∏ Playing‚Ä¶';};
  utt.onend=utt.onerror=()=>{document.getElementById('swInd').classList.remove('on');document.getElementById('ttsBtn').textContent='‚ñ∂ Play AI Voice';};
  window.speechSynthesis.speak(utt);
  toast('ü§ñ AI voice speaking!');
}
function stopSpeech(){
  window.speechSynthesis.cancel();
  document.getElementById('swInd').classList.remove('on');
  document.getElementById('ttsBtn').textContent='‚ñ∂ Play AI Voice';
}
if('speechSynthesis' in window){
  if(speechSynthesis.getVoices().length)loadVoices();
  speechSynthesis.onvoiceschanged=loadVoices;
}

// -------------------------------------------------- IMAGES --------------------------------------------------
function handleImgUp(e){
  const files=Array.from(e.target.files);
  const role=document.querySelector('.rtag.active')?.textContent?.replace(/[üé¨üñºÔ∏èüë§üìåüéØüí°]/g,'').trim()||'Background';
  files.forEach(f=>{
    const r=new FileReader();
    r.onload=ev=>{imgs.push({src:ev.target.result,name:f.name,role});renderImgs();};
    r.readAsDataURL(f);
  });
  toast(`üì∏ ${files.length} image(s) uploaded!`);
  e.target.value='';
}
function renderImgs(){
  const g=document.getElementById('imgGrid');g.innerHTML='';
  imgs.forEach((img,i)=>{
    const s=document.createElement('div');s.className='img-slot filled';
    s.innerHTML=`<img src="${img.src}" alt="${img.name}"><div class="irole">${img.role}</div><div class="img-ov"><button class="iob iou" onclick="useImg(${i})">‚ñ∂</button><button class="iob iod" onclick="delImg(${i})">‚úï</button></div>`;
    g.appendChild(s);
  });
  const empty=Math.max(0,3-imgs.length)+1;
  for(let i=0;i<empty;i++){
    const s=document.createElement('div');s.className='img-slot';
    s.onclick=()=>document.getElementById('imgIn').click();
    s.innerHTML='<div class="img-si">‚ûï</div><div class="img-sl">Add Image</div>';
    g.appendChild(s);
  }
}
function useImg(i){
  const img=imgs[i];activeImg=i;
  const ui=document.getElementById('pUImg');ui.src=img.src;ui.classList.add('on');
  if(img.role.includes('Background')){
    document.getElementById('pBg').style.backgroundImage=`url(${img.src})`;
    document.getElementById('pBg').style.backgroundSize='cover';
    document.getElementById('pBg').style.backgroundPosition='center';
    document.querySelectorAll('.bgt').forEach(t=>t.classList.remove('sel'));
  }
  toast(`‚úÖ "${img.name}" ‚Üí Preview!`);
}
function delImg(i){
  imgs.splice(i,1);
  if(activeImg===i){document.getElementById('pUImg').classList.remove('on');activeImg=-1;}
  renderImgs();toast('üóëÔ∏è Image removed');
}
function clearImgs(){imgs=[];activeImg=-1;document.getElementById('pUImg').classList.remove('on');renderImgs();toast('üóëÔ∏è All cleared');}
function selRole(el){document.querySelectorAll('.rtag').forEach(t=>t.classList.remove('active'));el.classList.add('active');}

// -------------------------------------------------- BACKGROUND --------------------------------------------------
const bgs=['linear-gradient(135deg,#1a1a2e,#16213e,#0f3460)','linear-gradient(135deg,#2d1b00,#5c3200,#8b4513)','linear-gradient(135deg,#0a192f,#112240,#233554)','linear-gradient(135deg,#1a0a00,#3d1c00,#6b3300)','linear-gradient(135deg,#0d2818,#155c35,#1e8449)','linear-gradient(135deg,#1a001a,#3d003d,#6b006b)','linear-gradient(135deg,#2a0000,#600000,#8b0000)','radial-gradient(circle at 30% 40%,#1a1a1a,#000)'];
function selBg(i){
  document.querySelectorAll('.bgt').forEach(t=>t.classList.remove('sel'));
  document.querySelectorAll('.bgt')[i].classList.add('sel');
  const bg=document.getElementById('pBg');bg.style.backgroundImage='';bg.style.background=bgs[i];
  document.getElementById('pUImg').classList.remove('on');
  toast('üé® Background updated!');
}

// -------------------------------------------------- ANIMATION --------------------------------------------------
function selAnim(type,el){document.querySelectorAll('.abtn').forEach(b=>b.classList.remove('active'));el.classList.add('active');curAnim=type;trigAnim();toast('‚ú® '+el.textContent.trim());}
function trigAnim(){const p=document.getElementById('pTxt');p.className='ptxt';setTimeout(()=>{p.className='ptxt '+curAnim;},50);}

// -------------------------------------------------- EMOJI --------------------------------------------------
function togEmoji(el){
  el.classList.toggle('on');
  VS.emojis=[...document.querySelectorAll('.ec.on')].map(e=>e.childNodes[0].textContent.trim()).join(' ');
  document.getElementById('pEmo').textContent=VS.emojis;
}

// -------------------------------------------------- FILTER / PLATFORM / RATIO --------------------------------------------------
function selFilter(el){document.querySelectorAll('.fb').forEach(b=>b.classList.remove('active'));el.classList.add('active');toast('üé¨ '+el.dataset.n);}
function selPlat(el){document.querySelectorAll('.pbtn').forEach(b=>b.classList.remove('active'));el.classList.add('active');}
function selRatio(r,el){
  document.querySelectorAll('.rbtn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');curRatio=r;
  document.getElementById('pScr').className='prev-scr '+r;
  const lbl={'r916':'9:16','r169':'16:9','r11':'1:1'};
  document.getElementById('ratioLbl').textContent=lbl[r]||'';
  toast('üìê '+lbl[r]);
}
function selQ(el){document.querySelectorAll('.qbtn').forEach(b=>b.classList.remove('active'));el.classList.add('active');}

// -------------------------------------------------- MINI LIVE PREVIEW --------------------------------------------------
// Cycles through all 5 sections with real voice + background transitions

// Mini preview sections ‚Äî built fresh each play from VS
function pGetSections(){
  return [
    {id:'hook',    badge:'üé£ HOOK',        text:VS.hook||VS.seedThought||'',          bg:'linear-gradient(135deg,#1a1a2e,#16213e,#0f3460)'},
    {id:'problem', badge:'üòî THE PROBLEM', text:VS.problem||'',                        bg:'linear-gradient(135deg,#2a0000,#3d0000,#5a0000)'},
    {id:'realize', badge:'üí° REALIZATION', text:VS.realization||'',                   bg:'linear-gradient(135deg,#1a1200,#3d2800,#5c3c00)'},
    {id:'solution',badge:'üî• SOLUTION',    text:VS.solution||'',                       bg:'linear-gradient(135deg,#001a0a,#003d1a,#005c28)'},
    {id:'closing', badge:'‚ú® CLOSING',     text:VS.closing||'Change your belief, change your life. üî•', bg:'linear-gradient(135deg,#0f003d,#1a0064,#2a0096)'},
  ].filter(s=>s.text.trim().length>0);
}

let pSecIdx   = 0;       // current section index
let pSections = [];      // sections for this playthrough
let pSpeaking = false;   // TTS busy
let pSafeTimer= null;    // safety advance timer
let pBarRAF   = null;    // RAF for bar animation
let pSecStart = 0;       // timestamp when current section started
let pSecDur   = 0;       // duration of current section (ms)

function togPlay(){
  if(isPlay){ pStop(); return; }
  pSections=pGetSections();
  if(!pSections.length){ toast('‚úçÔ∏è Elaborate a thought first!'); return; }
  isPlay=true;
  document.getElementById('playBtn').textContent='‚è∏';
  pSecIdx=0;
  pShowSection(0);
}

function pStop(){
  isPlay=false;
  document.getElementById('playBtn').textContent='‚ñ∂';
  if(pInt){ clearInterval(pInt); pInt=null; }
  if(pSafeTimer){ clearTimeout(pSafeTimer); pSafeTimer=null; }
  if(pBarRAF){ cancelAnimationFrame(pBarRAF); pBarRAF=null; }
  if('speechSynthesis' in window) window.speechSynthesis.cancel();
  pSpeaking=false;
  document.getElementById('pFill').style.width='0%';
  document.getElementById('timD').textContent='0:00 / 0:00';
}

function pShowSection(idx){
  if(!isPlay) return;
  const sec=pSections[idx];
  if(!sec){ pStop(); return; }

  // ‚îÄ‚îÄ Update preview card ‚îÄ‚îÄ
  const pTxt=document.getElementById('pTxt');
  const pEmo=document.getElementById('pEmo');
  const pBg =document.getElementById('pBg');

  // Background ‚Äî use uploaded image if available, else gradient
  const hasBgImg=pBg.style.backgroundImage&&pBg.style.backgroundImage.includes('url');
  if(!hasBgImg){
    pBg.style.backgroundImage='';
    pBg.style.background=sec.bg;
  }

  // Text ‚Äî badge + content
  pTxt.className='ptxt';
  setTimeout(()=>{
    pTxt.textContent=sec.text.substring(0,140);
    pTxt.className='ptxt '+curAnim;
  },50);

  // Emojis
  pEmo.textContent=VS.emojis||'üòî üî• ‚ú®';

  // Speak and advance on voice end
  if('speechSynthesis' in window){
    window.speechSynthesis.cancel();
    const utt=buildUtterance(sec.text);
    pSpeaking=true;

    // Estimate duration from word count for bar animation
    const words=sec.text.trim().split(/\s+/).length;
    const voiceRate=parseFloat(document.getElementById('ttsRate')?.value||1);
    pSecDur=Math.max(3000, (words/voiceRate)*600);
    pSecStart=performance.now();
    pStartBar();

    utt.onend=()=>{
      pSpeaking=false;
      if(pSafeTimer){ clearTimeout(pSafeTimer); pSafeTimer=null; }
      if(!isPlay) return;
      setTimeout(()=>pAdvance(), 500);
    };
    utt.onerror=()=>{
      pSpeaking=false;
      if(!isPlay) return;
      // fallback: use timer
      pSafeTimer=setTimeout(()=>pAdvance(), pSecDur);
    };
    window.speechSynthesis.speak(utt);

    // Safety: if onend never fires, advance anyway
    const safety=pSecDur*2+3000;
    pSafeTimer=setTimeout(()=>{
      if(pSpeaking&&isPlay){
        window.speechSynthesis.cancel();
        pSpeaking=false;
        pAdvance();
      }
    }, safety);

  } else {
    // No TTS ‚Äî use word-count timer
    const words=sec.text.trim().split(/\s+/).length;
    pSecDur=Math.max(3000, words*600);
    pSecStart=performance.now();
    pStartBar();
    pSafeTimer=setTimeout(()=>pAdvance(), pSecDur);
  }

  // Update label
  document.getElementById('timD').textContent=`${idx+1}/${pSections.length} ‚Äî ${sec.badge}`;
}

// Animate progress bar smoothly for current section
function pStartBar(){
  if(pBarRAF){ cancelAnimationFrame(pBarRAF); pBarRAF=null; }
  // Offset in total: sections before this idx
  const totalDur=pSections.reduce((a,s,i)=>{
    const w=s.text.trim().split(/\s+/).length;
    return a+(i<pSecIdx?Math.max(3000,w*600):0);
  },0);
  const allDur=pSections.reduce((a,s)=>{
    const w=s.text.trim().split(/\s+/).length;
    return a+Math.max(3000,w*600);
  },0);

  function barFrame(){
    if(!isPlay){ pBarRAF=null; return; }
    const elapsed=performance.now()-pSecStart;
    const secPct=Math.min(elapsed/pSecDur,1);
    const globalPct=((totalDur+elapsed)/allDur)*100;
    document.getElementById('pFill').style.width=Math.min(globalPct,100)+'%';
    const totalElapsed=(totalDur+elapsed)/1000;
    const totalSec=allDur/1000;
    const fmt=s=>`${Math.floor(s/60)}:${(Math.floor(s)%60).toString().padStart(2,'0')}`;
    document.getElementById('timD').textContent=`${fmt(totalElapsed)} / ${fmt(totalSec)}`;
    if(secPct<1) pBarRAF=requestAnimationFrame(barFrame);
    else pBarRAF=null;
  }
  pBarRAF=requestAnimationFrame(barFrame);
}

function pAdvance(){
  if(!isPlay) return;
  if(pSafeTimer){ clearTimeout(pSafeTimer); pSafeTimer=null; }
  pSecIdx++;
  if(pSecIdx>=pSections.length){
    // All done
    document.getElementById('pFill').style.width='100%';
    setTimeout(()=>pStop(), 600);
    return;
  }
  pShowSection(pSecIdx);
}

// -------------------------------------------------- EXPORT --------------------------------------------------
// ----------------------------------------------------------------------------------------------------
// REAL VIDEO EXPORT ENGINE
// Canvas 1080√ó1920 ‚Üí MediaRecorder ‚Üí WebM download
// Voice plays live via SpeechSynthesis during recording
// ----------------------------------------------------------------------------------------------------

function doExport(){
  // Browser check
  if(!HTMLCanvasElement.prototype.captureStream || !window.MediaRecorder){
    showExportModal(`
      <div style="text-align:center;padding:20px">
        <div style="font-size:48px;margin-bottom:16px">üì±</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:2px;margin-bottom:12px">USE CHROME ON PC/MAC</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.6);line-height:1.8;margin-bottom:20px">
          Your browser doesn't support canvas video recording.<br>
          Open this page in <strong>Chrome on a desktop</strong> to download the video.<br><br>
          On iPhone: use the <strong>Screen Recording</strong> method ‚Äî it's equally professional!
        </div>
        <button onclick="closeExportModal()" style="padding:12px 28px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:10px;color:#fff;font-weight:700;font-size:14px;cursor:pointer">Got It</button>
      </div>
    `);
    return;
  }

  if(!VS.hook && !VS.seedThought){ toast('‚úçÔ∏è Add a script first!'); return; }

  showExportModal(`
    <div style="text-align:center;padding:24px">
      <div style="font-size:40px;margin-bottom:12px">üé¨</div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;margin-bottom:8px">RENDERING YOUR VIDEO</div>
      <div style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:24px;font-family:'Space Mono',monospace" id="xpStep">Initialising‚Ä¶</div>
      <div style="background:rgba(255,255,255,0.08);border-radius:8px;height:8px;overflow:hidden;margin-bottom:8px">
        <div id="xpBar" style="height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%;transition:width .3s ease;border-radius:8px"></div>
      </div>
      <div style="font-family:'Space Mono',monospace;font-size:11px;color:var(--accent2)" id="xpPct">0%</div>
      <div style="font-size:11px;color:rgba(255,255,255,0.35);margin-top:16px;line-height:1.8">
        üîä Voice will play during recording<br>
        Keep your volume up for best results
      </div>
    </div>
  `);

  // Small delay so modal renders before heavy canvas work
  setTimeout(()=> runExport(), 200);
}

// ‚îÄ‚îÄ Export Modal helpers ‚îÄ‚îÄ
function showExportModal(html){
  let m=document.getElementById('xpModal');
  if(!m){
    m=document.createElement('div');
    m.id='xpModal';
    m.style.cssText='position:fixed;inset:0;z-index:999999;background:rgba(0,0,0,0.88);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(12px)';
    document.body.appendChild(m);
  }
  m.innerHTML=`<div style="background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:8px;max-width:380px;width:90%;color:var(--text)">${html}</div>`;
  m.style.display='flex';
}
function closeExportModal(){
  const m=document.getElementById('xpModal');
  if(m) m.style.display='none';
}
function xpProgress(pct, step){
  const b=document.getElementById('xpBar'), p=document.getElementById('xpPct'), s=document.getElementById('xpStep');
  if(b) b.style.width=pct+'%';
  if(p) p.textContent=Math.round(pct)+'%';
  if(s) s.textContent=step;
}

// ‚îÄ‚îÄ Core canvas rendering ‚îÄ‚îÄ
const XW=1080, XH=1920; // 9:16 Full HD

// Draw text wrapped to fit maxWidth, returns array of lines
function wrapText(ctx, text, maxWidth){
  const words=text.split(' ');
  const lines=[];
  let line='';
  for(const word of words){
    const test=line?line+' '+word:word;
    if(ctx.measureText(test).width>maxWidth && line){
      lines.push(line); line=word;
    } else { line=test; }
  }
  if(line) lines.push(line);
  return lines;
}

// Draw rounded rectangle
function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

// Background gradients per section
const XBGS={
  intro:    ['#0d0d1a','#0f1a2e','#0a0f20'],
  hook:     ['#1a1a2e','#16213e','#0f3460'],
  problem:  ['#2a0000','#3d0000','#5a0000'],
  realize:  ['#1a1200','#3d2800','#5c3c00'],
  solution: ['#001a0a','#003d1a','#005c28'],
  closing:  ['#0f003d','#1a0064','#2a0096'],
  outro:    ['#0d0d1a','#0f1a2e','#0a0f20'],
};

function drawBg(ctx, sectionId){
  const cols=XBGS[sectionId]||XBGS.hook;
  const g=ctx.createLinearGradient(0,0,XW,XH);
  g.addColorStop(0, cols[0]);
  g.addColorStop(0.5, cols[1]);
  g.addColorStop(1, cols[2]);
  ctx.fillStyle=g;
  ctx.fillRect(0,0,XW,XH);
}

function drawBgImage(ctx, img){
  // Draw image covering full canvas with darkening overlay
  const ratio=Math.max(XW/img.width, XH/img.height);
  const iw=img.width*ratio, ih=img.height*ratio;
  ctx.drawImage(img, (XW-iw)/2, (XH-ih)/2, iw, ih);
  // Dark overlay so text is readable
  ctx.fillStyle='rgba(0,0,0,0.55)';
  ctx.fillRect(0,0,XW,XH);
}

function drawVignette(ctx){
  const g=ctx.createRadialGradient(XW/2,XH/2,XH*0.2,XW/2,XH/2,XH*0.8);
  g.addColorStop(0,'rgba(0,0,0,0)');
  g.addColorStop(1,'rgba(0,0,0,0.7)');
  ctx.fillStyle=g;
  ctx.fillRect(0,0,XW,XH);
  // Bottom gradient
  const gb=ctx.createLinearGradient(0,XH*0.6,0,XH);
  gb.addColorStop(0,'rgba(0,0,0,0)');
  gb.addColorStop(1,'rgba(0,0,0,0.85)');
  ctx.fillStyle=gb;
  ctx.fillRect(0,0,XW,XH);
}

function drawWatermark(ctx){
  ctx.font='32px "Space Mono", monospace';
  ctx.fillStyle='rgba(255,255,255,0.25)';
  ctx.textAlign='center';
  ctx.fillText('‚Äî PRADEEP PARMAR ‚Äî', XW/2, XH-60);
}

function drawIntro(ctx, title, progress){
  // progress 0‚Üí1 for fade-in animation
  const alpha=Math.min(progress*2, 1);
  ctx.globalAlpha=alpha;

  // Pre-title
  ctx.font='36px "Space Mono", monospace';
  ctx.fillStyle='rgba(255,255,255,0.45)';
  ctx.textAlign='center';
  ctx.fillText('PRADEEP PARMAR PRESENTS', XW/2, XH/2-160);

  // Divider line
  ctx.fillStyle='#ff6b2b';
  ctx.fillRect(XW/2-60, XH/2-120, 120, 3);

  // Main title ‚Äî large Bebas
  const titleWords=title.toUpperCase();
  ctx.font=`bold 96px "Bebas Neue", sans-serif`;
  ctx.fillStyle='#ffffff';
  ctx.shadowColor='rgba(255,107,43,0.6)';
  ctx.shadowBlur=40;
  const lines=wrapText(ctx, titleWords, XW-160);
  lines.forEach((line,i)=>{
    ctx.fillText(line, XW/2, XH/2-40+i*110);
  });
  ctx.shadowBlur=0;

  // Tag
  ctx.font='32px "Space Mono", monospace';
  ctx.fillStyle='#ffb347';
  ctx.fillText('Belief ¬∑ Mind ¬∑ Life', XW/2, XH/2+80+lines.length*90);

  ctx.globalAlpha=1;
}

function drawContent(ctx, section, progress){
  // progress 0‚Üí1 slide-in
  const slideIn=Math.min(progress*3, 1);
  const yOff=(1-slideIn)*60;

  const badgeColors={
    hook:'#ff6b2b', problem:'#4a9eff', realize:'#f5c842',
    solution:'#2dce89', closing:'#b57bee'
  };
  const badgeColor=badgeColors[section.id]||'#ff6b2b';
  const c=fpContent(section.id);
  if(!c.text) return;

  // ‚îÄ‚îÄ Badge pill (top-left area) ‚îÄ‚îÄ
  const BY=260;
  ctx.globalAlpha=Math.min(progress*4,1);
  const badgeText=c.badge.toUpperCase();
  ctx.font='bold 36px "DM Sans", sans-serif';
  const bw=ctx.measureText(badgeText).width+60;
  const bh=70;
  const bx=80, by=BY+yOff;

  ctx.fillStyle=badgeColor+'40';
  roundRect(ctx,bx,by,bw,bh,35);
  ctx.fill();
  ctx.strokeStyle=badgeColor+'90';
  ctx.lineWidth=2;
  roundRect(ctx,bx,by,bw,bh,35);
  ctx.stroke();

  ctx.fillStyle=badgeColor;
  ctx.textAlign='left';
  ctx.fillText(badgeText, bx+30, by+bh*0.68);

  // ‚îÄ‚îÄ Emojis ‚îÄ‚îÄ
  const emos=VS.emojis||'üòî üî• ‚ú®';
  ctx.globalAlpha=Math.min(progress*3.5,1);
  ctx.font='72px serif';
  ctx.fillStyle='#ffffff';
  ctx.fillText(emos, 80, BY+bh+90+yOff);

  // ‚îÄ‚îÄ Main TEXT ‚Äî hero of the screen ‚îÄ‚îÄ
  ctx.globalAlpha=Math.min(progress*2.5,1);
  ctx.font=`bold 88px "Bebas Neue", sans-serif`;
  ctx.fillStyle='#ffffff';
  ctx.shadowColor='rgba(0,0,0,0.9)';
  ctx.shadowBlur=20;
  ctx.textAlign='left';

  const textY=BY+bh+200+yOff;
  const textMaxW=XW-160;
  const lines=wrapText(ctx, c.text.toUpperCase(), textMaxW);
  lines.forEach((line,i)=>{
    ctx.fillText(line, 80, textY+i*104);
  });
  ctx.shadowBlur=0;

  // ‚îÄ‚îÄ Signature ‚îÄ‚îÄ
  ctx.globalAlpha=0.4;
  ctx.font='28px "Space Mono", monospace';
  ctx.fillStyle='#ffffff';
  ctx.textAlign='left';
  ctx.fillText('‚Äî PRADEEP PARMAR', 80, XH-120);

  ctx.globalAlpha=1;
}

function drawOutro(ctx, progress){
  const alpha=Math.min(progress*2,1);
  ctx.globalAlpha=alpha;
  ctx.textAlign='center';

  // Fire emoji
  ctx.font='160px serif';
  ctx.fillText('üî•', XW/2, XH/2-200);

  ctx.font=`bold 110px "Bebas Neue", sans-serif`;
  ctx.fillStyle='#ffffff';
  ctx.shadowColor='rgba(255,107,43,0.5)';
  ctx.shadowBlur=30;
  ctx.fillText('CHANGE YOUR BELIEF', XW/2, XH/2+0);

  // Gradient text for second line
  const g=ctx.createLinearGradient(XW*0.2,0,XW*0.8,0);
  g.addColorStop(0,'#ff6b2b'); g.addColorStop(1,'#f5c842');
  ctx.fillStyle=g;
  ctx.fillText('CHANGE YOUR LIFE', XW/2, XH/2+120);
  ctx.shadowBlur=0;

  ctx.fillStyle='rgba(255,255,255,0.3)';
  ctx.font='32px "Space Mono", monospace';
  ctx.fillText('‚Äî Pradeep Parmar', XW/2, XH/2+210);
  ctx.globalAlpha=1;
}

// ‚îÄ‚îÄ Speak via SpeechSynthesis, returns promise that resolves on end ‚îÄ‚îÄ
function xpSpeak(text){
  return new Promise(resolve=>{
    if(!text||!('speechSynthesis' in window)){resolve();return;}
    window.speechSynthesis.cancel();
    const utt=buildUtterance(text);
    utt.onend=utt.onerror=()=>resolve();
    // Safety timeout
    const safety=setTimeout(()=>resolve(), text.split(/\s+/).length*800+3000);
    utt.onend=()=>{clearTimeout(safety);resolve();};
    utt.onerror=()=>{clearTimeout(safety);resolve();};
    window.speechSynthesis.speak(utt);
  });
}

// Wait ms helper
function xpWait(ms){ return new Promise(r=>setTimeout(r,ms)); }

// ‚îÄ‚îÄ MAIN EXPORT RUNNER ‚îÄ‚îÄ
async function runExport(){
  const canvas=document.createElement('canvas');
  canvas.width=XW; canvas.height=XH;
  const ctx=canvas.getContext('2d');

  // Load fonts
  xpProgress(5,'Loading fonts‚Ä¶');
  try{
    await document.fonts.load('bold 96px "Bebas Neue"');
    await document.fonts.load('bold 36px "DM Sans"');
    await document.fonts.load('28px "Space Mono"');
  }catch(e){}

  // Load user background image if any
  let bgImg=null;
  const pBg=document.getElementById('pBg');
  const hasBgImg=pBg.style.backgroundImage&&pBg.style.backgroundImage.includes('url');
  if(hasBgImg){
    const url=pBg.style.backgroundImage.replace(/url\(["']?(.+?)["']?\)/,'$1');
    bgImg=await new Promise(res=>{
      const img=new Image();
      img.onload=()=>res(img);
      img.onerror=()=>res(null);
      img.src=url;
    });
  } else if(imgs.length>0){
    bgImg=await new Promise(res=>{
      const img=new Image();
      img.onload=()=>res(img);
      img.onerror=()=>res(null);
      img.src=imgs[0].src;
    });
  }

  // Setup MediaRecorder
  xpProgress(10,'Setting up recorder‚Ä¶');
  let recorder, chunks=[];

  const mimeType=
    MediaRecorder.isTypeSupported('video/webm;codecs=vp9') ? 'video/webm;codecs=vp9' :
    MediaRecorder.isTypeSupported('video/webm')            ? 'video/webm'            :
    MediaRecorder.isTypeSupported('video/mp4')             ? 'video/mp4'             : '';

  try{
    const stream=canvas.captureStream(30);
    recorder=new MediaRecorder(stream, mimeType?{mimeType,videoBitsPerSecond:8000000}:{});
    recorder.ondataavailable=e=>{if(e.data&&e.data.size>0)chunks.push(e.data);};
    recorder.start(100);
  }catch(e){
    closeExportModal();
    toast('‚ùå Your browser blocked recording. Try Chrome on desktop.');
    return;
  }

  // Start background music if set in editor
  if(window.vedMusic && window.vedMusic.audio){
    window.vedMusic.audio.currentTime=0;
    window.vedMusic.audio.volume=window.vedMusic.vol;
    window.vedMusic.audio.loop=true;
    window.vedMusic.audio.play().catch(()=>{});
  }

  // Pre-load all section background images BEFORE the render loop (no await inside RAF)
  const VED_THEMES_XP=[
    {bg:['#1a1a2e','#16213e','#0f3460']},{bg:['#2a0000','#3d0000','#5a0000']},
    {bg:['#1a1200','#3d2800','#5c3c00']},{bg:['#001a0a','#003d1a','#005c28']},
    {bg:['#0f003d','#1a0064','#2a0096']},{bg:['#2d1b00','#5c3200','#8b4513']},
    {bg:['#0a192f','#112240','#233554']},{bg:['#0a0a0a','#111','#0d0d0d']}
  ];
  const sectionImgCache=[];
  for(let si=0;si<sections.length;si++){
    const sec=sections[si];
    const idx=sec.imgIdx!=null?sec.imgIdx:-1;
    if(idx>=0 && imgs[idx]){
      const loaded=await new Promise(res=>{
        const im=new Image(); im.onload=()=>res(im); im.onerror=()=>res(null); im.src=imgs[idx].src;
      });
      sectionImgCache.push(loaded);
    } else {
      sectionImgCache.push(null);
    }
  }

  // ‚îÄ‚îÄ Section render loop ‚îÄ‚îÄ
  const totalDur=sections.reduce((a,s)=>a+s.dur,0);
  let elapsed=0;

  for(let si=0;si<sections.length;si++){
    const sec=sections[si];
    const pctBase=(elapsed/totalDur)*100;
    const pctEnd=((elapsed+sec.dur)/totalDur)*100;
    elapsed+=sec.dur;

    xpProgress(pctBase,`Rendering ${sec.label}‚Ä¶`);

    const secStart=performance.now();
    let voiceDone=false;

    // Speak while rendering
    if(si>0 && si<sections.length-1){
      const c=fpContent(sec.id);
      if(c.text) xpSpeak(c.text).then(()=>{voiceDone=true;});
      else voiceDone=true;
    } else { voiceDone=true; }

    // Pre-resolve background for this section (already loaded above)
    const secBgImg = sectionImgCache[si] || bgImg || null;
    const secTheme = (sec.themeIdx!=null && VED_THEMES_XP[sec.themeIdx]) ? VED_THEMES_XP[sec.themeIdx] : null;

    // Draw frames for this section ‚Äî plain function (no await inside)
    await new Promise(resolve=>{
      function frame(){
        const now=performance.now();
        const progress=Math.min((now-secStart)/sec.dur, 1);

        // Draw background
        if(secBgImg){
          drawBgImage(ctx,secBgImg);
        } else if(secTheme){
          const g=ctx.createLinearGradient(0,0,XW,XH);
          g.addColorStop(0,secTheme.bg[0]);g.addColorStop(0.5,secTheme.bg[1]);g.addColorStop(1,secTheme.bg[2]);
          ctx.fillStyle=g; ctx.fillRect(0,0,XW,XH);
        } else {
          drawBg(ctx,sec.id);
        }
        drawVignette(ctx);

        // Draw content
        if(si===0)                       drawIntro(ctx, VS.seedThought||VS.hook, progress);
        else if(si===sections.length-1)  drawOutro(ctx, progress);
        else                             drawContent(ctx, sec, progress);

        drawWatermark(ctx);
        xpProgress(pctBase+(progress*(pctEnd-pctBase)),`Rendering ${sec.label}‚Ä¶`);

        if(progress<1){
          requestAnimationFrame(frame);
        } else {
          // Wait for voice before moving on
          const waitVoice=()=>{
            if(voiceDone||!('speechSynthesis' in window)) resolve();
            else setTimeout(waitVoice,100);
          };
          setTimeout(waitVoice,300);
        }
      }
      requestAnimationFrame(frame);
    });

    // 400ms fade-to-black between sections
    await new Promise(resolve=>{
      let f=0;
      function fadeFrame(){
        ctx.globalAlpha=f/12;
        ctx.fillStyle='#000';
        ctx.fillRect(0,0,XW,XH);
        ctx.globalAlpha=1;
        f++;
        if(f<=12) requestAnimationFrame(fadeFrame);
        else resolve();
      }
      requestAnimationFrame(fadeFrame);
    });
  }

  // Stop recording
  xpProgress(97,'Finalising‚Ä¶');
  window.speechSynthesis.cancel();
  // Stop background music if playing
  if(window.vedMusic && window.vedMusic.audio){ window.vedMusic.audio.pause(); }

  await new Promise(resolve=>{
    recorder.onstop=resolve;
    recorder.stop();
  });

  await xpWait(300);

  // Download
  xpProgress(100,'Done!');
  const ext=mimeType.includes('mp4')?'mp4':'webm';
  const blob=new Blob(chunks,{type:mimeType||'video/webm'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`pradeep-parmar-${Date.now()}.${ext}`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url),5000);

  // Update modal to done state
  showExportModal(`
    <div style="text-align:center;padding:24px">
      <div style="font-size:56px;margin-bottom:12px">‚úÖ</div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:2px;margin-bottom:8px">VIDEO DOWNLOADED!</div>
      <div style="font-size:13px;color:rgba(255,255,255,0.55);line-height:1.8;margin-bottom:8px">
        Saved as <strong>.${ext}</strong> file<br>
        Check your Downloads folder
      </div>
      <div style="background:rgba(255,107,43,0.1);border:1px solid rgba(255,107,43,0.3);border-radius:10px;padding:12px;margin:16px 0;font-size:12px;color:rgba(255,255,255,0.6);line-height:1.8">
        üí° <strong>Pro tip:</strong> Import into CapCut or iMovie<br>
        to add music, captions & final polish
      </div>
      <button onclick="closeExportModal()" style="padding:12px 32px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:10px;color:#fff;font-weight:700;font-size:14px;cursor:pointer;width:100%">üî• Done!</button>
    </div>
  `);
  toast('üéâ Video downloaded! Check your Downloads folder.');
}

// ----------------------------------------------------------------------------------------------------
// FULL VIDEO PREVIEW ENGINE  ‚Äî Voice-synced, mobile-safe
// Section advance is driven by voice onend (when voice ON)
// or by a simple timer (when voice OFF or iOS fallback)
// ----------------------------------------------------------------------------------------------------

// Section definitions ‚Äî bg class applied to #fpBg
const FP = [
  {id:'intro',   label:'INTRO',       bg:'fpbg-hook',     dur:3500},
  {id:'hook',    label:'HOOK',        bg:'fpbg-hook',     dur:9000},
  {id:'problem', label:'PROBLEM',     bg:'fpbg-problem',  dur:12000},
  {id:'realize', label:'REALIZATION', bg:'fpbg-realize',  dur:12000},
  {id:'solution',label:'SOLUTION',    bg:'fpbg-solution', dur:11000},
  {id:'closing', label:'CLOSING',     bg:'fpbg-closing',  dur:6000},
  {id:'outro',   label:'OUTRO',       bg:'fpbg-hook',     dur:4000},
];
let fpTotal = FP.reduce((a,s)=>a+s.dur, 0);

// Playback state
let fpPlaying    = false;
let fpSection    = 0;
let fpElapsed    = 0;       // ms elapsed in current section
let fpVoiceOn    = true;
let fpVoiceBusy  = false;   // true while TTS is speaking
let fpRAF        = null;
let fpLastTs     = null;
let fpTimerFallback = null; // setInterval used when voice doesn't fire onend

// Content map ‚Äî reads from VS
function fpContent(id){
  return {
    hook:     {badge:'üé£ HOOK',        text: VS.hook||VS.seedThought||''},
    problem:  {badge:'üòî THE PROBLEM', text: VS.problem||''},
    realize:  {badge:'üí° REALIZATION', text: VS.realization||''},
    solution: {badge:'üî• SOLUTION',    text: VS.solution||''},
    closing:  {badge:'‚ú® CLOSING',     text: VS.closing||'Change your belief, change your life. üî•'},
  }[id] || {badge:'', text:''};
}

// ‚îÄ‚îÄ Word spans for karaoke highlight ‚îÄ‚îÄ
function buildWordSpans(text){
  if(!text) return '';
  let wIdx=0;
  return text.split(/(\s+)/).map(part=>{
    if(/^\s+$/.test(part)) return part;
    return `<span class="fpw" id="fpw${wIdx++}">${part}</span>`;
  }).join('');
}
function highlightWordAt(charIdx, text){
  const spans=document.querySelectorAll('#fpText .fpw');
  if(!spans.length) return;
  let pos=0, wIdx=0;
  for(const part of text.split(/(\s+)/)){
    if(!/^\s+$/.test(part)){
      if(charIdx>=pos && charIdx<pos+part.length){
        spans.forEach(s=>s.classList.remove('fpw-on'));
        if(spans[wIdx]) spans[wIdx].classList.add('fpw-on');
        return;
      }
      wIdx++;
    }
    pos+=part.length;
  }
}
function clearHighlight(){
  document.querySelectorAll('.fpw-on').forEach(s=>s.classList.remove('fpw-on'));
}

// ‚îÄ‚îÄ Open modal ‚îÄ‚îÄ
function openFullPreview(){
  if(!VS.seedThought&&!VS.hook&&!elabRaw){
    toast('‚úçÔ∏è Write a thought and Elaborate first!'); return;
  }
  if(elabRaw&&!VS.hook) parseIntoVS(elabRaw);
  if(!VS.hook) VS.hook=VS.seedThought;

  // Intro title
  document.getElementById('fpIntroTitle').textContent=
    (VS.seedThought||VS.hook).toUpperCase().substring(0,60);

  // Dynamic durations: ~480ms per word + 1200ms buffer, voice-driven anyway
  function wdur(t,mn,mx){
    const w=(t||'').trim().split(/\s+/).filter(Boolean).length;
    return Math.min(mx,Math.max(mn,w*480+1200));
  }
  FP[1].dur=wdur(VS.hook,        4000,12000);
  FP[2].dur=wdur(VS.problem,     5000,16000);
  FP[3].dur=wdur(VS.realization, 5000,16000);
  FP[4].dur=wdur(VS.solution,    5000,14000);
  FP[5].dur=wdur(VS.closing,     3500, 8000);
  fpTotal=FP.reduce((a,s)=>a+s.dur,0);

  applyFpBg(0);
  const modal=document.getElementById('fpModal');
  modal.style.display='block';
  requestAnimationFrame(()=>modal.classList.add('open'));

  fpSection=0; fpElapsed=0; fpPlaying=false; fpVoiceBusy=false;
  showFpSection(0, true);
  drawFpBar();
  document.getElementById('fpPlayBtn').textContent='‚ñ∂';
  document.body.style.overflow='hidden';
}

function closeFullPreview(){
  stopFpPlayback();
  const modal=document.getElementById('fpModal');
  modal.classList.remove('open');
  setTimeout(()=>{ modal.style.display='none'; },380);
  document.body.style.overflow='';
}

// ‚îÄ‚îÄ Background ‚îÄ‚îÄ
function applyFpBg(sIdx){
  const sec=FP[sIdx];
  const bg=document.getElementById('fpBg');
  const imgBg=document.getElementById('fpImgBg');

  // Remove old bg classes
  bg.className='';
  bg.classList.add(sec.bg);

  // User-uploaded image via pBg
  const pBg=document.getElementById('pBg');
  const hasBgImg=pBg.style.backgroundImage&&!pBg.style.backgroundImage.includes('none')&&pBg.style.backgroundImage.includes('url');
  if(hasBgImg){
    bg.style.backgroundImage=pBg.style.backgroundImage;
    bg.style.backgroundSize='cover'; bg.style.backgroundPosition='center';
  } else {
    bg.style.backgroundImage='';
  }

  // Uploaded image stack with Ken Burns
  if(imgs.length>0){
    const im=imgs[sIdx%imgs.length];
    imgBg.style.backgroundImage=`url(${im.src})`;
    imgBg.style.backgroundSize='cover'; imgBg.style.backgroundPosition='center';
    imgBg.style.opacity='0.42';
    imgBg.className=['kb1','kb2','kb3'][sIdx%3];
  } else {
    imgBg.style.opacity='0'; imgBg.className='';
  }
}

// ‚îÄ‚îÄ Show section ‚îÄ‚îÄ
function showFpSection(sIdx, instant){
  const sec=FP[sIdx];

  // Label + dots
  document.getElementById('fpSectionLabel').textContent=sec.label;
  document.querySelectorAll('.fpdot').forEach((d,i)=>{
    d.classList.toggle('active', i===Math.min(sIdx,4));
    d.classList.toggle('done',   i<Math.min(sIdx,4));
  });

  applyFpBg(sIdx);

  const isIntro  = sIdx===0;
  const isOutro  = sIdx===FP.length-1;
  const isContent= !isIntro&&!isOutro;

  // Hide all slides first
  ['fpIntro','fpContent','fpOutro'].forEach(id=>{
    const el=document.getElementById(id);
    el.classList.remove('fp-visible');
  });

  // Show the right slide
  const slideId = isIntro?'fpIntro': isOutro?'fpOutro':'fpContent';
  setTimeout(()=>{
    document.getElementById(slideId).classList.add('fp-visible');
  }, instant?0:80);

  if(isContent){
    const c=fpContent(sec.id);

    const badge  =document.getElementById('fpBadge');
    const textEl =document.getElementById('fpText');
    const emoEl  =document.getElementById('fpEmoji');

    // Reset animation classes
    badge.classList.remove('fp-in');
    emoEl.classList.remove('fp-in');
    textEl.classList.remove('fp-in');

    // Set content
    badge.textContent=c.badge;
    textEl.innerHTML=buildWordSpans(c.text);  // word spans for karaoke
    emoEl.textContent=VS.emojis||'';

    // Animate in staggered
    const d=instant?20:200;
    setTimeout(()=>{ badge.classList.add('fp-in'); },d);
    setTimeout(()=>{ emoEl.classList.add('fp-in'); },d+60);
    setTimeout(()=>{ textEl.classList.add('fp-in'); },d+140);

    // üéôÔ∏è SPEAK ‚Äî always call directly (iOS needs it synchronous within play chain)
    // Call immediately, voice will start after brief system delay naturally
    if(fpVoiceOn && fpPlaying && c.text){
      speakSection(c.text, sIdx);
    } else if(!fpVoiceOn && fpPlaying){
      // Voice off ‚Äî use timer only
      fpVoiceBusy=false;
    }
  } else {
    // Intro/Outro: no voice, timer drives advance
    fpVoiceBusy=false;
  }
}

// ‚îÄ‚îÄ Speak a section, voice drives advance via onend ‚îÄ‚îÄ
function speakSection(text, sIdx){
  if(!text||!('speechSynthesis' in window)){ fpVoiceBusy=false; return; }

  // iOS Safari: cancel any pending, then speak immediately
  window.speechSynthesis.cancel();
  clearHighlight();

  const utt=buildUtterance(text);
  fpVoiceBusy=true;

  if(fpTimerFallback){ clearTimeout(fpTimerFallback); fpTimerFallback=null; }

  // onboundary ‚Äî karaoke word highlight (Chrome/Android; silently skipped on iOS)
  utt.onboundary=(e)=>{
    if(e.name==='word'){
      highlightWordAt(e.charIndex, text);
      const prog=Math.min(e.charIndex/Math.max(text.length,1), 0.95);
      fpElapsed=prog*FP[sIdx].dur;
      drawFpBar();
    }
  };

  // onend ‚Äî THE CORE: voice finishes ‚Üí advance screen to next section
  utt.onend=()=>{
    clearHighlight();
    fpVoiceBusy=false;
    if(fpTimerFallback){ clearTimeout(fpTimerFallback); fpTimerFallback=null; }
    if(!fpPlaying) return;
    fpElapsed=FP[sIdx].dur;
    drawFpBar();
    // Advance immediately ‚Äî no setTimeout (keeps iOS gesture chain alive)
    advanceSection();
  };

  utt.onerror=(e)=>{
    clearHighlight();
    fpVoiceBusy=false;
    // On error use timer fallback for this section
    useFallbackTimer(sIdx);
  };

  window.speechSynthesis.speak(utt);

  // Safety net: if onend never fires (some browsers bug), force advance after 2.5√ó expected
  const estMs = Math.max(text.split(/\s+/).length * 600, FP[sIdx].dur) + 2000;
  fpTimerFallback=setTimeout(()=>{
    if(fpVoiceBusy && fpPlaying){
      window.speechSynthesis.cancel();
      fpVoiceBusy=false;
      advanceSection();
    }
  }, estMs);
}

// Timer fallback for when voice API fails (e.g. some mobile browsers)
function useFallbackTimer(sIdx){
  if(fpTimerFallback){ clearTimeout(fpTimerFallback); fpTimerFallback=null; }
  const remaining=FP[sIdx].dur - fpElapsed;
  fpTimerFallback=setTimeout(()=>{
    fpTimerFallback=null;
    if(fpPlaying) advanceSection();
  }, Math.max(remaining, 800));
}

function advanceSection(){
  fpElapsed=0;
  fpSection++;
  if(fpSection>=FP.length){
    fpSection=FP.length-1; fpElapsed=FP[fpSection].dur;
    drawFpBar(); stopFpPlayback();
    document.getElementById('fpPlayBtn').textContent='‚ñ∂';
    showFpSection(fpSection,false); return;
  }
  showFpSection(fpSection,false);
  drawFpBar();
}

// ‚îÄ‚îÄ RAF loop ‚Äî drives bar + intro/outro timer advance ‚îÄ‚îÄ
function fpTick(ts){
  if(!fpLastTs) fpLastTs=ts;
  const delta=Math.min(ts-fpLastTs, 200); // cap delta to avoid jumps
  fpLastTs=ts;

  // Only advance elapsed via timer when voice is NOT busy
  if(!fpVoiceBusy){
    fpElapsed+=delta;
    drawFpBar();
    // Timer-driven advance (intro/outro, or voice OFF)
    if(fpElapsed>=FP[fpSection].dur && !fpVoiceBusy){
      advanceSection();
      return;
    }
  } else {
    // Voice is speaking: just keep bar moving smoothly
    fpElapsed=Math.min(fpElapsed+delta*0.3, FP[fpSection].dur*0.95);
    drawFpBar();
  }

  if(fpPlaying) fpRAF=requestAnimationFrame(fpTick);
}

// ‚îÄ‚îÄ Playback controls ‚îÄ‚îÄ
function toggleFpPlay(){
  if(fpPlaying){ stopFpPlayback(); document.getElementById('fpPlayBtn').textContent='‚ñ∂'; }
  else          { startFpPlayback(); document.getElementById('fpPlayBtn').textContent='‚è∏'; }
}

function startFpPlayback(){
  fpPlaying=true; fpLastTs=null;
  fpRAF=requestAnimationFrame(fpTick);

  const sec=FP[fpSection];
  const isContent = fpSection>0 && fpSection<FP.length-1;

  if(fpVoiceOn && isContent){
    // Content section ‚Äî speak it (voice drives advance)
    const c=fpContent(sec.id);
    if(c.text){
      // iOS: must call speak() synchronously within user gesture
      speakSection(c.text, fpSection);
    } else {
      fpVoiceBusy=false;
    }
  } else {
    // Intro/outro or voice off ‚Äî timer drives it
    fpVoiceBusy=false;
  }
}

function stopFpPlayback(){
  fpPlaying=false;
  if(fpRAF){ cancelAnimationFrame(fpRAF); fpRAF=null; }
  if(fpTimerFallback){ clearTimeout(fpTimerFallback); fpTimerFallback=null; }
  if('speechSynthesis' in window) window.speechSynthesis.cancel();
  fpVoiceBusy=false;
  clearHighlight();
}

function drawFpBar(){
  let el=fpElapsed;
  for(let i=0;i<fpSection;i++) el+=FP[i].dur;
  const pct=Math.min((el/fpTotal)*100,100);
  document.getElementById('fpBar').style.width=pct+'%';
  const s=Math.floor(el/1000), tot=Math.floor(fpTotal/1000);
  const fmt=n=>`${Math.floor(n/60)}:${(n%60).toString().padStart(2,'0')}`;
  document.getElementById('fpTimerDisplay').textContent=fmt(s);
  document.getElementById('fpFullTime').textContent=`${fmt(s)} / ${fmt(tot)}`;
}

function restartPreview(){
  stopFpPlayback(); fpSection=0; fpElapsed=0;
  showFpSection(0,true); drawFpBar();
  document.getElementById('fpPlayBtn').textContent='‚ñ∂';
}
function nextSection(){
  const wasPlaying=fpPlaying;
  stopFpPlayback(); fpElapsed=0;
  fpSection=Math.min(fpSection+1,FP.length-1);
  showFpSection(fpSection,false); drawFpBar();
  if(wasPlaying){ startFpPlayback(); document.getElementById('fpPlayBtn').textContent='‚è∏'; }
}
function prevSection(){
  const wasPlaying=fpPlaying;
  stopFpPlayback(); fpElapsed=0;
  fpSection=Math.max(fpSection-1,0);
  showFpSection(fpSection,false); drawFpBar();
  if(wasPlaying){ startFpPlayback(); document.getElementById('fpPlayBtn').textContent='‚è∏'; }
}
function seekPreview(e){
  const rect=e.currentTarget.getBoundingClientRect();
  const pct=(e.clientX-rect.left)/rect.width;
  let target=pct*fpTotal, acc=0;
  for(let i=0;i<FP.length;i++){
    if(acc+FP[i].dur>=target){
      stopFpPlayback(); fpSection=i; fpElapsed=target-acc;
      showFpSection(i,false); drawFpBar(); return;
    }
    acc+=FP[i].dur;
  }
}
function toggleFpVoice(){
  fpVoiceOn=!fpVoiceOn;
  document.getElementById('fpVoiceBtn').textContent=fpVoiceOn?'üîä':'üîá';
  if(!fpVoiceOn){
    if('speechSynthesis' in window) window.speechSynthesis.cancel();
    fpVoiceBusy=false; clearHighlight();
  }
  toast(fpVoiceOn?'üîä Voice ON ‚Äî synced':'üîá Voice OFF ‚Äî timer mode');
}



// ----------------------------------------------------------------------------------------------------
// VIDEO EDITOR ENGINE
// Full per-section editing: text, image, color, transition, duration
// Live canvas preview + background music + apply-to-export
// ----------------------------------------------------------------------------------------------------

// ‚îÄ‚îÄ Editor State ‚îÄ‚îÄ
const VED = {
  activeSection: 0,   // index into vedSections
  musicAudio: null,
  musicName: '',
  musicVol: 0.4,
  musicLoop: true,
};

// Per-section settings ‚Äî mirrors FP array, editable
let vedSections = [];

// Section colour themes
const VED_THEMES = [
  {name:'Night Blue',  bg:['#1a1a2e','#16213e','#0f3460']},
  {name:'Blood Red',   bg:['#2a0000','#3d0000','#5a0000']},
  {name:'Gold Dark',   bg:['#1a1200','#3d2800','#5c3c00']},
  {name:'Deep Green',  bg:['#001a0a','#003d1a','#005c28']},
  {name:'Royal Purple',bg:['#0f003d','#1a0064','#2a0096']},
  {name:'Ember',       bg:['#2d1b00','#5c3200','#8b4513']},
  {name:'Ocean',       bg:['#0a192f','#112240','#233554']},
  {name:'Pure Black',  bg:['#0a0a0a','#111','#0d0d0d']},
];

const VED_BADGE_COLORS = {
  hook:'#ff6b2b', problem:'#4a9eff', realize:'#f5c842',
  solution:'#2dce89', closing:'#b57bee', intro:'#ff6b2b', outro:'#ff6b2b'
};

// ‚îÄ‚îÄ Initialise editor state from current VS + FP ‚îÄ‚îÄ
function vedInit(){
  vedSections = [
    { id:'intro',    label:'INTRO',       text: VS.seedThought||VS.hook||'',  fontSize:88, textPos:'center', textColor:'#ffffff', themeIdx:0, imgIdx:-1, imgOpacity:42, transition:'fade', dur: 3500 },
    { id:'hook',     label:'HOOK',        text: VS.hook||'',                  fontSize:88, textPos:'center', textColor:'#ffffff', themeIdx:0, imgIdx:-1, imgOpacity:42, transition:'fade', dur: FP[1]?FP[1].dur:9000 },
    { id:'problem',  label:'PROBLEM',     text: VS.problem||'',               fontSize:88, textPos:'center', textColor:'#ffffff', themeIdx:1, imgIdx:-1, imgOpacity:42, transition:'fade', dur: FP[2]?FP[2].dur:12000 },
    { id:'realize',  label:'REALIZATION', text: VS.realization||'',           fontSize:88, textPos:'center', textColor:'#ffffff', themeIdx:2, imgIdx:-1, imgOpacity:42, transition:'fade', dur: FP[3]?FP[3].dur:12000 },
    { id:'solution', label:'SOLUTION',    text: VS.solution||'',              fontSize:88, textPos:'center', textColor:'#ffffff', themeIdx:3, imgIdx:-1, imgOpacity:42, transition:'fade', dur: FP[4]?FP[4].dur:11000 },
    { id:'closing',  label:'CLOSING',     text: VS.closing||'Change your belief, change your life. üî•', fontSize:88, textPos:'center', textColor:'#ffffff', themeIdx:4, imgIdx:-1, imgOpacity:42, transition:'fade', dur: FP[5]?FP[5].dur:6000 },
    { id:'outro',    label:'OUTRO',       text: 'Change Your Belief\nChange Your Life', fontSize:88, textPos:'center', textColor:'#ffffff', themeIdx:0, imgIdx:-1, imgOpacity:42, transition:'fade', dur: 4000 },
  ];
  // If user has uploaded images, assign them per section
  if(imgs.length>0){
    vedSections.forEach((s,i)=>{ s.imgIdx = i % imgs.length; });
  }
}

// ‚îÄ‚îÄ Open editor ‚îÄ‚îÄ
function openVideoEditor(){
  if(!VS.hook && !VS.seedThought){ toast('‚úçÔ∏è Write a thought and Elaborate first!'); return; }
  vedInit();
  buildVedTimeline();
  buildVedColorGrid();
  buildVedImgGrid();
  vedSelectSection(1); // default to HOOK
  updateVedTotalDur();
  const modal = document.getElementById('vedModal');
  modal.style.display = 'flex';
  requestAnimationFrame(()=> modal.classList.add('open'));
  document.body.style.overflow = 'hidden';
}

function closeVideoEditor(){
  const modal = document.getElementById('vedModal');
  modal.classList.remove('open');
  setTimeout(()=>{ modal.style.display='none'; },350);
  document.body.style.overflow = '';
  if(VED.musicAudio){ VED.musicAudio.pause(); }
}

// ‚îÄ‚îÄ Build Timeline ‚îÄ‚îÄ
const TL_COLORS = ['#1a3a6b','#6b1a1a','#5c4400','#1a4a2e','#2a1a6b','#ff6b2b','#1a3a6b'];

function buildVedTimeline(){
  const tl = document.getElementById('vedTimeline');
  tl.innerHTML = '';
  vedSections.forEach((sec,i)=>{
    const minPx=70, maxPx=200;
    const durSec = sec.dur/1000;
    const totalSec = vedSections.reduce((a,s)=>a+s.dur/1000,0)||60;
    const w = Math.max(minPx, Math.min(maxPx, (durSec/totalSec)*700));

    const block = document.createElement('div');
    block.className = 'ved-tl-block' + (i===VED.activeSection?' active':'');
    block.style.background = `linear-gradient(135deg,${VED_THEMES[sec.themeIdx].bg[0]},${VED_THEMES[sec.themeIdx].bg[1]})`;
    block.style.borderColor = VED_BADGE_COLORS[sec.id]||'#ff6b2b';
    block.style.width = w+'px';
    block.dataset.idx = i;
    block.innerHTML = `
      <div class="ved-tl-label">${sec.label}</div>
      <div class="ved-tl-dur">${(durSec).toFixed(1)}s</div>
      <div class="ved-tl-resize" title="Drag to resize"></div>`;
    block.addEventListener('click', ()=> vedSelectSection(i));
    // Drag resize
    const resizeHandle = block.querySelector('.ved-tl-resize');
    resizeHandle.addEventListener('mousedown', vedStartResize(i, block));
    tl.appendChild(block);
  });
}

function vedStartResize(idx, block){
  return function(e){
    e.stopPropagation();
    const startX = e.clientX;
    const startDur = vedSections[idx].dur;
    function onMove(ev){
      const dx = ev.clientX - startX;
      const newDur = Math.max(2000, Math.min(20000, startDur + dx*40));
      vedSections[idx].dur = Math.round(newDur/500)*500;
      block.querySelector('.ved-tl-dur').textContent = (vedSections[idx].dur/1000).toFixed(1)+'s';
      if(idx===VED.activeSection){
        document.getElementById('vedDurSlider').value = vedSections[idx].dur/1000;
        document.getElementById('vedDurV').textContent = (vedSections[idx].dur/1000)+'s';
      }
      updateVedTotalDur();
    }
    function onUp(){
      document.removeEventListener('mousemove',onMove);
      document.removeEventListener('mouseup',onUp);
      buildVedTimeline();
    }
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onUp);
  };
}

// ‚îÄ‚îÄ Select Section ‚îÄ‚îÄ
function vedSelectSection(idx){
  VED.activeSection = idx;
  const sec = vedSections[idx];

  // Highlight timeline block
  document.querySelectorAll('.ved-tl-block').forEach((b,i)=>{
    b.classList.toggle('active', i===idx);
  });

  // Update props header
  document.getElementById('vedPropTitle').textContent = sec.label;
  document.getElementById('vedCanvasLabel').textContent = sec.label;

  // TEXT tab
  document.getElementById('vedTextInput').value = sec.text;
  document.getElementById('vedCharCount').textContent = sec.text.length + ' chars';
  document.getElementById('vedFontSize').value = sec.fontSize;
  document.getElementById('vedFontSizeV').textContent = sec.fontSize + 'px';
  // Position buttons
  document.querySelectorAll('.ved-pos-btns button').forEach(b=>{
    b.classList.toggle('active', b.getAttribute('onclick').includes("'"+sec.textPos+"'"));
  });

  // STYLE tab ‚Äî color swatches
  document.querySelectorAll('.ved-color-swatch').forEach(s=>{
    s.classList.toggle('active', s.dataset.color===sec.textColor);
  });
  // Theme grid
  document.querySelectorAll('.ved-color-opt').forEach((s,i)=>{
    s.classList.toggle('active', i===sec.themeIdx);
  });
  // Transitions
  document.querySelectorAll('.ved-trans-btn').forEach(b=>{
    b.classList.toggle('active', b.getAttribute('onclick').includes("'"+sec.transition+"'"));
  });

  // IMAGE tab
  document.getElementById('vedImgOpacity').value = sec.imgOpacity;
  document.getElementById('vedImgOpacityV').textContent = sec.imgOpacity + '%';
  buildVedImgGrid();

  // TIMING tab
  document.getElementById('vedDurSlider').value = sec.dur/1000;
  document.getElementById('vedDurV').textContent = (sec.dur/1000) + 's';
  updateVedTotalDur();

  // Redraw canvas
  vedDrawCanvas();
}

// ‚îÄ‚îÄ Canvas Preview ‚îÄ‚îÄ
function vedDrawCanvas(){
  const canvas = document.getElementById('vedCanvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const W=270, H=480;
  canvas.width=W; canvas.height=H;

  const sec = vedSections[VED.activeSection];
  const theme = VED_THEMES[sec.themeIdx];

  // Background gradient
  const g = ctx.createLinearGradient(0,0,W,H);
  g.addColorStop(0, theme.bg[0]);
  g.addColorStop(0.5, theme.bg[1]);
  g.addColorStop(1, theme.bg[2]);
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);

  // Background image
  if(sec.imgIdx>=0 && imgs[sec.imgIdx]){
    const img = imgs[sec.imgIdx];
    const r = Math.max(W/img.width, H/img.height);
    const iw=img.width*r, ih=img.height*r;
    ctx.globalAlpha = sec.imgOpacity/100;
    ctx.drawImage(img, (W-iw)/2,(H-ih)/2,iw,ih);
    ctx.globalAlpha = 1;
  }

  // Vignette
  const vg = ctx.createRadialGradient(W/2,H/2,H*0.15,W/2,H/2,H*0.75);
  vg.addColorStop(0,'rgba(0,0,0,0)');
  vg.addColorStop(1,'rgba(0,0,0,0.7)');
  ctx.fillStyle=vg; ctx.fillRect(0,0,W,H);

  const bottomGrad = ctx.createLinearGradient(0,H*0.55,0,H);
  bottomGrad.addColorStop(0,'rgba(0,0,0,0)');
  bottomGrad.addColorStop(1,'rgba(0,0,0,0.85)');
  ctx.fillStyle=bottomGrad; ctx.fillRect(0,0,W,H);

  if(sec.id==='intro'||sec.id==='outro'){
    // Intro/Outro centred layout
    ctx.textAlign='center';
    ctx.fillStyle='rgba(255,255,255,0.4)';
    ctx.font='9px monospace';
    ctx.fillText('PRADEEP PARMAR PRESENTS', W/2, H/2-60);
    ctx.fillStyle='#ff6b2b';
    ctx.fillRect(W/2-30,H/2-50,60,2);
    ctx.fillStyle=sec.textColor||'#fff';
    ctx.font=`bold ${Math.round(sec.fontSize*0.36)}px sans-serif`;
    ctx.shadowColor='rgba(255,107,43,0.6)'; ctx.shadowBlur=12;
    const lines = vedWrapText(ctx, (sec.text||'').toUpperCase(), W-40);
    lines.forEach((l,i)=> ctx.fillText(l, W/2, H/2-20+i*34));
    ctx.shadowBlur=0;
    ctx.fillStyle='#ffb347'; ctx.font='8px monospace';
    ctx.fillText('Belief ¬∑ Mind ¬∑ Life', W/2, H/2+40+lines.length*20);
  } else {
    // Content section layout
    const badge = (sec.label||'').toUpperCase();
    const badgeColor = VED_BADGE_COLORS[sec.id]||'#ff6b2b';
    const textY = sec.textPos==='top' ? 100 : sec.textPos==='bottom' ? H-200 : H/2-60;

    // Badge pill
    ctx.font='bold 9px sans-serif';
    const bw = ctx.measureText(badge).width+18;
    ctx.fillStyle = badgeColor+'40';
    ctx.roundRect(16, textY-60, bw, 22, 11); ctx.fill();
    ctx.strokeStyle=badgeColor+'90'; ctx.lineWidth=1;
    ctx.roundRect(16, textY-60, bw, 22, 11); ctx.stroke();
    ctx.fillStyle=badgeColor; ctx.textAlign='left';
    ctx.fillText(badge, 24, textY-44);

    // Emojis
    ctx.font='16px serif';
    ctx.fillText(VS.emojis||'üòî üî• ‚ú®', 16, textY-18);

    // Main text
    ctx.font=`bold ${Math.round(sec.fontSize*0.28)}px sans-serif`;
    ctx.fillStyle = sec.textColor||'#fff';
    ctx.shadowColor='rgba(0,0,0,0.9)'; ctx.shadowBlur=8;
    const lines = vedWrapText(ctx, (sec.text||'').toUpperCase(), W-32);
    lines.forEach((l,i)=> ctx.fillText(l, 16, textY+i*28));
    ctx.shadowBlur=0;

    // Signature
    ctx.font='7px monospace';
    ctx.fillStyle='rgba(255,255,255,0.3)';
    ctx.fillText('‚Äî PRADEEP PARMAR', 16, H-20);
  }
}

function vedWrapText(ctx, text, maxW){
  const words=(text||'').split(' ');
  const lines=[]; let line='';
  for(const w of words){
    const t=line?line+' '+w:w;
    if(ctx.measureText(t).width>maxW && line){ lines.push(line); line=w; }
    else line=t;
  }
  if(line) lines.push(line);
  return lines;
}

// ‚îÄ‚îÄ Tab switching ‚îÄ‚îÄ
function vedTab(name, btn){
  document.querySelectorAll('.ved-tab').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.ved-tab-panel').forEach(p=>p.classList.remove('active'));
  btn.classList.add('active');
  const panelMap={text:'vedTabText',image:'vedTabImage',style:'vedTabStyle',timing:'vedTabTiming'};
  document.getElementById(panelMap[name]).classList.add('active');
}

// ‚îÄ‚îÄ Text editing ‚îÄ‚îÄ
function vedTextChange(val){
  vedSections[VED.activeSection].text = val;
  document.getElementById('vedCharCount').textContent = val.length+' chars';
  vedDrawCanvas();
}
function vedFontChange(val){
  vedSections[VED.activeSection].fontSize = parseInt(val);
  document.getElementById('vedFontSizeV').textContent = val+'px';
  vedDrawCanvas();
}
function vedSetPos(pos, btn){
  vedSections[VED.activeSection].textPos = pos;
  document.querySelectorAll('.ved-pos-btns button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  vedDrawCanvas();
}

// ‚îÄ‚îÄ Style editing ‚îÄ‚îÄ
function buildVedColorGrid(){
  const grid = document.getElementById('vedColorGrid');
  if(!grid) return;
  grid.innerHTML = VED_THEMES.map((t,i)=>`
    <div class="ved-color-opt ${i===vedSections[VED.activeSection]?.themeIdx?'active':''}"
      style="background:linear-gradient(135deg,${t.bg[0]},${t.bg[1]},${t.bg[2]})"
      title="${t.name}" onclick="vedSetTheme(${i},this)"></div>`).join('');
}
function vedSetTheme(idx, el){
  vedSections[VED.activeSection].themeIdx = idx;
  document.querySelectorAll('.ved-color-opt').forEach(e=>e.classList.remove('active'));
  el.classList.add('active');
  buildVedTimeline();
  vedDrawCanvas();
}
function vedSetTextColor(color, el){
  vedSections[VED.activeSection].textColor = color;
  document.querySelectorAll('.ved-color-swatch').forEach(s=>s.classList.remove('active'));
  el.classList.add('active');
  vedDrawCanvas();
}
function vedSetTrans(trans, btn){
  vedSections[VED.activeSection].transition = trans;
  document.querySelectorAll('.ved-trans-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

// ‚îÄ‚îÄ Image editing ‚îÄ‚îÄ
function buildVedImgGrid(){
  const grid = document.getElementById('vedImgGrid');
  if(!grid) return;
  if(!imgs.length){
    grid.innerHTML='<div class="ved-no-imgs">Upload images in Step 3 first</div>'; return;
  }
  const sec = vedSections[VED.activeSection];
  grid.innerHTML = imgs.map((img,i)=>`
    <div class="ved-img-thumb ${i===sec.imgIdx?'active':''}" onclick="vedSetSectionImg(${i},this)">
      <img src="${img.src}">
    </div>`).join('');
}
function vedSetSectionImg(idx, el){
  vedSections[VED.activeSection].imgIdx = idx;
  document.querySelectorAll('.ved-img-thumb').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  vedDrawCanvas();
}
function vedImgOpacityChange(val){
  vedSections[VED.activeSection].imgOpacity = parseInt(val);
  document.getElementById('vedImgOpacityV').textContent = val+'%';
  vedDrawCanvas();
}
function vedClearSectionImg(){
  vedSections[VED.activeSection].imgIdx = -1;
  buildVedImgGrid();
  vedDrawCanvas();
  toast('üóëÔ∏è Section image removed');
}

// ‚îÄ‚îÄ Timing ‚îÄ‚îÄ
function vedDurChange(val){
  vedSections[VED.activeSection].dur = parseFloat(val)*1000;
  document.getElementById('vedDurV').textContent = val+'s';
  updateVedTotalDur();
  buildVedTimeline();
}
function vedSetDur(sec){
  vedSections[VED.activeSection].dur = sec*1000;
  document.getElementById('vedDurSlider').value = sec;
  document.getElementById('vedDurV').textContent = sec+'s';
  updateVedTotalDur();
  buildVedTimeline();
}
function updateVedTotalDur(){
  const total = vedSections.reduce((a,s)=>a+s.dur,0)/1000;
  const fmt=s=>`${Math.floor(s/60)}:${(Math.floor(s)%60).toString().padStart(2,'0')}`;
  document.getElementById('vedTotalDur').textContent = fmt(total);
  const allDurs = document.getElementById('vedAllDurs');
  allDurs.innerHTML = vedSections.map(s=>`
    <div class="ved-dur-row">
      <span>${s.label}</span>
      <span>${(s.dur/1000).toFixed(1)}s</span>
    </div>`).join('');
}

// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
function vedPrev(){
  if(VED.activeSection>0) vedSelectSection(VED.activeSection-1);
}
function vedNext(){
  if(VED.activeSection<vedSections.length-1) vedSelectSection(VED.activeSection+1);
}

// ‚îÄ‚îÄ Music ‚îÄ‚îÄ
function vedLoadMusic(input){
  const file=input.files[0]; if(!file) return;
  VED.musicName=file.name;
  document.getElementById('vedMusicName').textContent=file.name;
  document.getElementById('vedMusicControls').style.display='flex';
  if(VED.musicAudio) VED.musicAudio.pause();
  VED.musicAudio = new Audio(URL.createObjectURL(file));
  VED.musicAudio.volume = VED.musicVol;
  VED.musicAudio.loop = true;
  toast('üéµ Music loaded: '+file.name);
}
function vedUpdateMusicVol(val){
  VED.musicVol = val/100;
  document.getElementById('vedMusicVolV').textContent=val+'%';
  if(VED.musicAudio) VED.musicAudio.volume=VED.musicVol;
}
function vedPreviewMusic(){
  if(!VED.musicAudio){ toast('Upload music first'); return; }
  const btn=document.getElementById('vedMusicPlayBtn');
  if(!VED.musicAudio.paused){ VED.musicAudio.pause(); btn.textContent='‚ñ∂ Preview'; }
  else { VED.musicAudio.play(); btn.textContent='‚è∏ Stop'; }
}

// ‚îÄ‚îÄ Apply changes back to main app ‚îÄ‚îÄ
function vedApply(){
  // Push edited text back to VS
  vedSections.forEach(sec=>{
    if(sec.id==='hook')    VS.hook        = sec.text;
    if(sec.id==='problem') VS.problem     = sec.text;
    if(sec.id==='realize') VS.realization = sec.text;
    if(sec.id==='solution')VS.solution    = sec.text;
    if(sec.id==='closing') VS.closing     = sec.text;
  });

  // Push durations back to FP
  const durMap={hook:1,problem:2,realize:3,solution:4,closing:5};
  vedSections.forEach(sec=>{
    const fi=durMap[sec.id];
    if(fi!==undefined && FP[fi]) FP[fi].dur = sec.dur;
  });
  fpTotal = FP.reduce((a,s)=>a+s.dur,0);

  // Push per-section images back ‚Äî assign to FP image sequence
  const sectionImgs=[];
  vedSections.forEach(sec=>{
    if(sec.imgIdx>=0 && imgs[sec.imgIdx]) sectionImgs.push(imgs[sec.imgIdx]);
  });

  // Refresh preview panel cards
  refreshParsedCards();
  applyScript(elabRaw||buildFallback(VS.seedThought,'motivational', selectedLen, selectedTgt));

  // Store editor settings for export to use
  window.vedSettings = vedSections;
  window.vedMusic = VED.musicAudio ? { audio:VED.musicAudio, vol:VED.musicVol } : null;

  closeVideoEditor();
  toast('‚úÖ Changes applied! Preview and Export will use your edits.');
}


document.addEventListener('keydown',e=>{
  if(!document.getElementById('fpModal').classList.contains('open'))return;
  if(e.key==='Escape')closeFullPreview();
  if(e.key===' '){e.preventDefault();toggleFpPlay();}
  if(e.key==='ArrowRight')nextSection();
  if(e.key==='ArrowLeft')prevSection();
  if(e.key==='r'||e.key==='R')restartPreview();
});

// -------------------------------------------------- INIT --------------------------------------------------
window.addEventListener('load',()=>{
  if(typeof gsap!=='undefined'){
    gsap.from('.card',{y:28,opacity:0,duration:.55,stagger:.07,ease:'power3.out',delay:.15});
    gsap.from('.prev-panel',{x:40,opacity:0,duration:.7,ease:'power3.out',delay:.35});
    gsap.from('header',{y:-20,opacity:0,duration:.45,ease:'power2.out'});
  }
  document.querySelectorAll('.si').forEach(item=>{
    item.addEventListener('click',function(){
      document.querySelectorAll('.si').forEach(i=>i.classList.remove('active'));
      this.classList.add('active');
    });
  });
  // Load saved personal API key if any
  const savedKey = loadApiKey();
  if(savedKey){
    const f = document.getElementById('apiKeyInput');
    if(f){ f.value=savedKey; }
  }

  // Init PIN protection (and health check / provider detection)
  initPin();

  document.getElementById('scriptInput').addEventListener('input',function(){
    VS.seedThought=this.value.trim();
    if(VS.seedThought.length>8){
      document.getElementById('pTxt').textContent=VS.seedThought.split(/[.\n!]/)[0].trim().substring(0,100);
    }
  });
});
</script>
</body>
</html>
