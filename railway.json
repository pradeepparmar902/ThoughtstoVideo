// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Pradeep Parmar â€” Belief Creator Studio
// Backend API Server
// Handles AI calls server-side so API key is NEVER exposed
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const express  = require('express');
const cors     = require('cors');
const path     = require('path');
require('dotenv').config();

const app = express();
app.use(cors());
app.use(express.json({ limit: '2mb' }));

// â”€â”€ Serve the frontend â”€â”€
app.use(express.static(path.join(__dirname, 'public')));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POST /api/generate  â€” main AI generation endpoint
// Body: { sys, userMsg, maxTokens }
// Returns: { text }
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
app.post('/api/generate', async (req, res) => {
  const { sys, userMsg, maxTokens = 900 } = req.body;

  if (!sys || !userMsg) {
    return res.status(400).json({ error: 'Missing sys or userMsg in request body' });
  }

  const GEMINI_KEY    = process.env.GEMINI_API_KEY;
  const ANTHROPIC_KEY = process.env.ANTHROPIC_API_KEY;
  const OPENAI_KEY    = process.env.OPENAI_API_KEY;

  // Try providers in order: Gemini â†’ Anthropic â†’ OpenAI
  const errors = [];

  // â”€â”€ Gemini â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (GEMINI_KEY) {
    try {
      const model  = 'gemini-1.5-flash';
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_KEY}`;
      const body   = {
        contents: [{ role: 'user', parts: [{ text: sys + '\n\n---\n\n' + userMsg }] }],
        generationConfig: { temperature: 1.0, maxOutputTokens: maxTokens }
      };

      const r = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      const d = await r.json();
      if (d.error) throw new Error('Gemini: ' + d.error.message);
      const text = d.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
      if (!text) throw new Error('Gemini returned empty text');

      return res.json({ text, provider: 'gemini' });
    } catch (e) {
      errors.push('Gemini: ' + e.message);
    }
  }

  // â”€â”€ Anthropic Claude â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (ANTHROPIC_KEY) {
    try {
      const r = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': ANTHROPIC_KEY,
          'anthropic-version': '2023-06-01'
        },
        body: JSON.stringify({
          model: 'claude-haiku-4-5-20251001',
          max_tokens: maxTokens,
          system: sys,
          messages: [{ role: 'user', content: userMsg }]
        })
      });

      const d = await r.json();
      if (d.error) throw new Error('Anthropic: ' + d.error.message);
      const text = d.content?.[0]?.text?.trim();
      if (!text) throw new Error('Anthropic returned empty text');

      return res.json({ text, provider: 'anthropic' });
    } catch (e) {
      errors.push('Anthropic: ' + e.message);
    }
  }

  // â”€â”€ OpenAI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (OPENAI_KEY) {
    try {
      const r = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + OPENAI_KEY
        },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          max_tokens: maxTokens,
          messages: [
            { role: 'system', content: sys },
            { role: 'user',   content: userMsg }
          ]
        })
      });

      const d = await r.json();
      if (d.error) throw new Error('OpenAI: ' + d.error.message);
      const text = d.choices?.[0]?.message?.content?.trim();
      if (!text) throw new Error('OpenAI returned empty text');

      return res.json({ text, provider: 'openai' });
    } catch (e) {
      errors.push('OpenAI: ' + e.message);
    }
  }

  // No keys configured or all failed
  if (!GEMINI_KEY && !ANTHROPIC_KEY && !OPENAI_KEY) {
    return res.status(500).json({ error: 'No API keys configured on server. Add GEMINI_API_KEY to your .env file.' });
  }

  return res.status(500).json({ error: 'All AI providers failed: ' + errors.join(' | ') });
});

// â”€â”€ Simple hash (same as client-side) â”€â”€
function simpleHash(str){
  let h = 0;
  for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; }
  return Math.abs(h).toString(16);
}

// â”€â”€ Health check â€” also exposes PIN hash so client can verify â”€â”€
app.get('/api/health', (req, res) => {
  const pin = process.env.APP_PIN;
  res.json({
    status: 'ok',
    pinHash: pin ? simpleHash(pin) : null,
    providers: {
      gemini:    !!process.env.GEMINI_API_KEY,
      anthropic: !!process.env.ANTHROPIC_API_KEY,
      openai:    !!process.env.OPENAI_API_KEY
    }
  });
});

// â”€â”€ Catch-all â†’ serve index.html (SPA support) â”€â”€
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`\nğŸ¬ Pradeep Parmar Creator Studio running on http://localhost:${PORT}`);
  console.log(`   Gemini key:    ${process.env.GEMINI_API_KEY    ? 'âœ… configured' : 'âŒ not set'}`);
  console.log(`   Anthropic key: ${process.env.ANTHROPIC_API_KEY ? 'âœ… configured' : 'âŒ not set'}`);
  console.log(`   OpenAI key:    ${process.env.OPENAI_API_KEY    ? 'âœ… configured' : 'âŒ not set'}\n`);
});
